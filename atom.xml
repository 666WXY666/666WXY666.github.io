<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>苇名一心的博客</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://666wxy666.github.io/"/>
  <updated>2020-06-03T08:19:10.673Z</updated>
  <id>https://666wxy666.github.io/</id>
  
  <author>
    <name>苇名一心</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>大数据实战 Spark 自选日志分析</title>
    <link href="https://666wxy666.github.io/2020/06/03/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-%E8%87%AA%E9%80%89%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    <id>https://666wxy666.github.io/2020/06/03/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-%E8%87%AA%E9%80%89%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/</id>
    <published>2020-06-03T08:11:17.635Z</published>
    <updated>2020-06-03T08:19:10.673Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于大数据通过Java进行Spark编程实现自选日志处理分析。</p><a id="more"></a><h2 id="一、实验环境："><a href="#一、实验环境：" class="headerlink" title="一、实验环境："></a>一、实验环境：</h2><ul><li>虚拟机数量：1</li><li>系统版本：Centos 7.5</li><li>Spark版本：Apache Spark 2.1.1</li><li>Eclipse版本：Neno.3 （4.6.3）</li></ul><h2 id="二、实验内容："><a href="#二、实验内容：" class="headerlink" title="二、实验内容："></a>二、实验内容：</h2><ul><li>收集一组自选日志，构造mydata.log数据集，上传到实验环境中，重新完成对自选日志分析。</li></ul><h2 id="三、主要步骤："><a href="#三、主要步骤：" class="headerlink" title="三、主要步骤："></a>三、主要步骤：</h2><ul><li>获取自选数据集</li><li>自选数据集计算的需求分析</li><li>编程设计实现</li><li>运行程序</li></ul><h2 id="四、实验步骤："><a href="#四、实验步骤：" class="headerlink" title="四、实验步骤："></a>四、实验步骤：</h2><h3 id="4-1获取自选数据集以及数据字段格式解释说明"><a href="#4-1获取自选数据集以及数据字段格式解释说明" class="headerlink" title="4.1获取自选数据集以及数据字段格式解释说明"></a>4.1获取自选数据集以及数据字段格式解释说明</h3><p>我受到平台的第一个实验和uber日志文件的启发，想到了自己用python生成uber日志文件，首先是日志的格式：</p><table><thead><tr><th align="center">字段</th><th align="center">数据类型</th><th align="center">说明信息</th></tr></thead><tbody><tr><td align="center">dispatching_base_number</td><td align="center">String</td><td align="center">区域编号</td></tr><tr><td align="center">date</td><td align="center">String</td><td align="center">日期</td></tr><tr><td align="center">active_vehicles</td><td align="center">int</td><td align="center">使用的机动车数量</td></tr><tr><td align="center">trips</td><td align="center">int</td><td align="center">旅游次数</td></tr></tbody></table><p>定义好了日志的格式，只要编写python程序，让他自己按照这个格式生产日志即可，具体代码见附录，下面是部分代码截图和运行结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603145855.jpg" alt="2020-06-03_145833" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603145923.jpg" alt="2020-06-03_145917" style="zoom:80%"><h3 id="4-2自选数据集计算的需求分析"><a href="#4-2自选数据集计算的需求分析" class="headerlink" title="4.2自选数据集计算的需求分析"></a>4.2自选数据集计算的需求分析</h3><p>因为是汽车和旅游日志信息，并且有不同日期，不同地区的信息，主要需求就是选取从开始时间到截止时间使用的机动车数量和旅游次数最多的前10个地区，以及他们的机动车总数量和旅游总次数。</p><p>主要步骤就是（与实验一大体相同，又有所区别）：</p><ol><li><p>按照 Serrializable 接口实现自定义排序的 Key；</p></li><li><p>将要进行二次排序的文件加载进来生成 key-value 类型的 RDD</p></li><li><p>使用 sortByKey 基于自定义的 Key 进行二次排序</p></li><li><p>去除掉排序的 key，只保留排序结果</p><p>排序规则如下：</p><p>以区域编号dispatching_base_number为基准，分别按照active_vehicles，trips，date进行降序排序。即先按照active_vehicles排序，如果active_vehicles相同，再比较trips，如果trips相同，再比较date，最后选择前10条记录输出。</p></li></ol><h3 id="4-3编程设计实现"><a href="#4-3编程设计实现" class="headerlink" title="4.3编程设计实现"></a>4.3编程设计实现</h3><h4 id="4-3-1创建工程"><a href="#4-3-1创建工程" class="headerlink" title="4.3.1创建工程"></a>4.3.1创建工程</h4><p>4.3.1.1打开Eclipse IDE</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd eclipse/</span><br><span class="line">./eclipse &amp;</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143358.jpg" alt="2020-06-03_102818" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143419.jpg" alt="2020-06-03_102840" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143431.jpg" alt="2020-06-03_102917" style="zoom:80%"><p>4.3.1.2点击 File -&gt; New -&gt;Other</p><p>4.3.1.3搜索 maven -&gt; 点击 Maven Project -&gt; Next-&gt;Next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143443.jpg" alt="2020-06-03_103021" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143500.jpg" alt="2020-06-03_103035" style="zoom:80%"><p>4.3.1.4选中maven-archetype-quickstart -&gt;Next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143535.jpg" alt="2020-06-03_103051" style="zoom:80%"><p>4.3.1.5输入Group Id 为 org.zkpk；Artifact Id 为 spark ；Package为org.zkpk.spark；-&gt;Finish</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143603.jpg" alt="2020-06-03_103201" style="zoom:80%"><p>4.3.1.6升级maven工程</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143618.jpg" alt="2020-06-03_103247" style="zoom:80%"><p>升级完成：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143638.jpg" alt="2020-06-03_103513" style="zoom:80%"><p>4.3.1.7更改JRE，右键JRE System Library-&gt; Properties</p><p>4.3.1.8选中jdk1.8.0_131-&gt; OK</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143649.jpg" alt="2020-06-03_103535" style="zoom:80%"><p>4.3.1.9点击spark项目-&gt;修改pom.xml-&gt; 保存会自动下载jar包</p><p>4.3.1.10下载Jar包：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143734.jpg" alt="2020-06-03_103915" style="zoom:80%"><p>4.3.1.11最终 pom.xml 如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.zkpk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>spark<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-hive_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-kafka_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-flume_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>src/main/test<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span><span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>exec-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">executable</span>&gt;</span>java<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">includeProjectDependencies</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeProjectDependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">includePluginDependencies</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includePluginDependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">classpathScope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">classpathScope</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.com.syl.spark.App<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4.3.1.12删除工程生成的App.java和AppTest.java</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143746.jpg" alt="2020-06-03_104358" style="zoom:80%"><p>利用实验一的实验环境编写java程序，同样是SecondarySortKey.java和SecondarySortDemo.java两个java文件。其中SecondarySortKey.java中有两个类，一个是serDemo类，用于存储未排序的数据，一个是SecondarySortKey类，里面重写了一系列排序函数，用于按照自己的规则排序；SecondarySortDemo.java有一个类SecondarySortDemo，里面有主函数和创建Spark RDD，求和，sortByKey等函数，是主要的逻辑运行的地方。</p><h4 id="4-3-2这里只挑出关键的代码进行解释注释和说明，详细的带注释的代码见附录："><a href="#4-3-2这里只挑出关键的代码进行解释注释和说明，详细的带注释的代码见附录：" class="headerlink" title="4.3.2这里只挑出关键的代码进行解释注释和说明，详细的带注释的代码见附录："></a>4.3.2这里只挑出关键的代码进行解释注释和说明，详细的带注释的代码见附录：</h4><p>这是排序的数据存放的类，有三个字段，全参构造函数，getter和setter，以及toString，hashCode和equal方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySortKey</span> <span class="keyword">implements</span> <span class="title">Ordered</span>&lt;<span class="title">SecondarySortKey</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3702442700882342403L</span>;</span><br><span class="line">    <span class="comment">//日期</span></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="comment">//使用的机动车数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> activeVehicles;</span><br><span class="line">    <span class="comment">//旅游次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> trips;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">(String date, <span class="keyword">int</span> activeVehicles, <span class="keyword">int</span> trips)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">        <span class="keyword">this</span>.activeVehicles = activeVehicles;</span><br><span class="line">        <span class="keyword">this</span>.trips = trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SecondarySortKey that = (SecondarySortKey) o;</span><br><span class="line">        <span class="keyword">return</span> activeVehicles == that.activeVehicles &amp;&amp;</span><br><span class="line">                trips == that.trips &amp;&amp;</span><br><span class="line">                Objects.equals(date, that.date);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(date, activeVehicles, trips);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SortResult&#123;"</span> +</span><br><span class="line">                <span class="string">"截止日期："</span> + date +</span><br><span class="line">                <span class="string">", 使用的机动车总数量："</span> + activeVehicles +</span><br><span class="line">                <span class="string">", 旅游总次数："</span> + trips +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最主要的是$greater，$less等一系列比较函数和compare和compareTo函数用于RDD的sortByKey。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $greater(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles &gt; other.activeVehicles) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips &gt; other.trips) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips == other.trips &amp;&amp;</span><br><span class="line">                date.compareTo(other.date) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles - other.activeVehicles != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> activeVehicles - other.activeVehicles;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trips - other.trips != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> trips - other.trips;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles - other.activeVehicles != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> activeVehicles - other.activeVehicles;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trips - other.trips != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> trips - other.trips;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>下面的类是主方法所在的类，也是主要的对数据进行处理计算的类：</p><p>他有四个函数（算上主函数），分别为：</p><ul><li><p>main：</p><p>用于打开文件，创建SparkConf和SparkContext对象，调用函数对RDD进行操作，并输出结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       SparkConf conf = <span class="keyword">new</span> SparkConf().setAppName(<span class="string">"SecondarySortDemo"</span>).setMaster(<span class="string">"local"</span>);</span><br><span class="line">       JavaSparkContext jsc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">       jsc.setLogLevel(<span class="string">"WARN"</span>);</span><br><span class="line">       JavaRDD&lt;String&gt; textfile = jsc.textFile(<span class="string">"/home/zkpk/experiment/mydata.log"</span>);</span><br><span class="line">       JavaPairRDD&lt;String, serDemo&gt; pairRdd = mapTfRDD2Pair(textfile);</span><br><span class="line">       JavaPairRDD&lt;String, serDemo&gt; getlines = aggregateByDeviceID(pairRdd);</span><br><span class="line">       JavaPairRDD&lt;SecondarySortKey, String&gt; telval = mapRDDKey2SortKey(getlines);</span><br><span class="line">       JavaPairRDD&lt;SecondarySortKey, String&gt; sortedRdd = telval.sortByKey(<span class="keyword">false</span>);</span><br><span class="line">       List&lt;Tuple2&lt;SecondarySortKey, String&gt;&gt; getTop = sortedRdd.take(<span class="number">10</span>);</span><br><span class="line">       System.out.println(<span class="string">"============ result ============"</span>);</span><br><span class="line">       <span class="keyword">for</span> (Tuple2&lt;SecondarySortKey, String&gt; dt : getTop) &#123;</span><br><span class="line">           System.out.println(<span class="string">"区域编号："</span> + dt._2 + <span class="string">", "</span> + dt._1);</span><br><span class="line">       &#125;</span><br><span class="line">       jsc.close();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>mapTfRDD2Pair：</p><p>用于从文件中读取数据，并将其转化为JavaPairRDD，key为区域编号dispatchingBaseNumber，value为以文件每一行生成的serDemo对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">mapTfRDD2Pair</span><span class="params">(JavaRDD&lt;String&gt; accessLogRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, serDemo&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, serDemo&gt; <span class="title">call</span><span class="params">(String lines)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] split = lines.split(<span class="string">","</span>);</span><br><span class="line">                String dispatchingBaseNumber = split[<span class="number">0</span>];</span><br><span class="line">                String date = split[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> activeVehicles = Integer.valueOf(split[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">int</span> trips = Integer.valueOf(split[<span class="number">3</span>]);</span><br><span class="line">                serDemo dataInfo = <span class="keyword">new</span> serDemo(date, activeVehicles, trips);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, serDemo&gt;(dispatchingBaseNumber, dataInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>aggregateByRegionID：</p><p>用于将mapTfRDD2Pair生成好的JavaPairRDD按照key对使用的机动车数量activeVehicles和旅游次数trips求和，获得JavaPairRDD，key为区域编号dispatchingBaseNumber，value为已经求和聚集完成的serDemo对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">aggregateByDeviceID</span><span class="params">(JavaPairRDD&lt;String, serDemo&gt; accessLogPairRDD)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accessLogPairRDD.reduceByKey(<span class="keyword">new</span> Function2&lt;serDemo, serDemo, serDemo&gt;() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="function"><span class="keyword">public</span> serDemo <span class="title">call</span><span class="params">(serDemo d1, serDemo d2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            String date = d1.getDate().compareTo(d2.getDate()) &gt; <span class="number">0</span> ? d1.getDate() : d2.getDate();</span><br><span class="line">            <span class="keyword">int</span> activeVehicles = d1.getActiveVehicles() + d2.getActiveVehicles();</span><br><span class="line">            <span class="keyword">int</span> trips = d1.getTrips() + d2.getTrips();</span><br><span class="line">            serDemo accessLogInfo = <span class="keyword">new</span> serDemo();</span><br><span class="line">            accessLogInfo.setDate(date);</span><br><span class="line">            accessLogInfo.setActiveVehicles(activeVehicles);</span><br><span class="line">            accessLogInfo.setTrips(trips);</span><br><span class="line">            <span class="keyword">return</span> accessLogInfo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><ul><li><p>mapRDDKey2SortKey：</p><p>用于将aggregateByRegionID生成好的JavaPairRDD按照上面定义好的规则进行排序，获得排好序的JavaPairRDD，用于输出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;SecondarySortKey, String&gt; <span class="title">mapRDDKey2SortKey</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JavaPairRDD&lt;String, serDemo&gt; aggrAccessLogPairRDD)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> aggrAccessLogPairRDD.mapToPair(</span><br><span class="line">            <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;String, serDemo&gt;, SecondarySortKey, String&gt;() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">                <span class="function"><span class="keyword">public</span> Tuple2&lt;SecondarySortKey, String&gt; <span class="title">call</span><span class="params">(Tuple2&lt;String, serDemo&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    String dispatchingBaseNumber = tuple._1;</span><br><span class="line">                    serDemo accessLogInfo = tuple._2;</span><br><span class="line">                    SecondarySortKey accessLogSortKey = <span class="keyword">new</span> SecondarySortKey(accessLogInfo.getDate(), accessLogInfo.getActiveVehicles(),</span><br><span class="line">                            accessLogInfo.getTrips());</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;SecondarySortKey, String&gt;(accessLogSortKey, dispatchingBaseNumber);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="4-4运行程序"><a href="#4-4运行程序" class="headerlink" title="4.4运行程序"></a>4.4运行程序</h3><h4 id="4-4-1将生成好的mydata-log发送到平台。"><a href="#4-4-1将生成好的mydata-log发送到平台。" class="headerlink" title="4.4.1将生成好的mydata.log发送到平台。"></a>4.4.1将生成好的mydata.log发送到平台。</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603153734.jpg" alt="2020-06-03_125258" style="zoom:80%"><h4 id="4-4-2运行程序，查看结果。"><a href="#4-4-2运行程序，查看结果。" class="headerlink" title="4.4.2运行程序，查看结果。"></a>4.4.2运行程序，查看结果。</h4><p>可以发现，程序正常运行得出了结果，并且已经求和和排序，成功！</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603154055.png" alt="QQ截图20200603142255" style="zoom:80%"><h2 id="五、附录"><a href="#五、附录" class="headerlink" title="五、附录"></a>五、附录</h2><h3 id="1、SecondarySortKey-java"><a href="#1、SecondarySortKey-java" class="headerlink" title="1、SecondarySortKey.java"></a>1、SecondarySortKey.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.spark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.math.Ordered;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">serDemo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5749943279909593929L</span>;</span><br><span class="line">    <span class="comment">//日期</span></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="comment">//使用的机动车数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> activeVehicles;</span><br><span class="line">    <span class="comment">//旅游次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> trips;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">serDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">serDemo</span><span class="params">(String date, <span class="keyword">int</span> activeVehicles, <span class="keyword">int</span> trips)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">        <span class="keyword">this</span>.activeVehicles = activeVehicles;</span><br><span class="line">        <span class="keyword">this</span>.trips = trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getSerialVersionUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialVersionUID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveVehicles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activeVehicles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setActiveVehicles</span><span class="params">(<span class="keyword">int</span> activeVehicles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.activeVehicles = activeVehicles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTrips</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrips</span><span class="params">(<span class="keyword">int</span> trips)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.trips = trips;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySortKey</span> <span class="keyword">implements</span> <span class="title">Ordered</span>&lt;<span class="title">SecondarySortKey</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3702442700882342403L</span>;</span><br><span class="line">    <span class="comment">//日期</span></span><br><span class="line">    <span class="keyword">private</span> String date;</span><br><span class="line">    <span class="comment">//使用的机动车数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> activeVehicles;</span><br><span class="line">    <span class="comment">//旅游次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> trips;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">(String date, <span class="keyword">int</span> activeVehicles, <span class="keyword">int</span> trips)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">        <span class="keyword">this</span>.activeVehicles = activeVehicles;</span><br><span class="line">        <span class="keyword">this</span>.trips = trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getSerialVersionUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialVersionUID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(String date)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getActiveVehicles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> activeVehicles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setActiveVehicles</span><span class="params">(<span class="keyword">int</span> activeVehicles)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.activeVehicles = activeVehicles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTrips</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrips</span><span class="params">(<span class="keyword">int</span> trips)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.trips = trips;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $greater(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles &gt; other.activeVehicles) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips &gt; other.trips) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips == other.trips &amp;&amp;</span><br><span class="line">                date.compareTo(other.date) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $greater$eq(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($greater(other)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips == other.trips &amp;&amp;</span><br><span class="line">                date.compareTo(other.date) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $less(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles &lt; other.activeVehicles) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips &lt; other.trips) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips == other.trips &amp;&amp;</span><br><span class="line">                date.compareTo(other.date) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $less$eq(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($less(other)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (activeVehicles == other.activeVehicles &amp;&amp;</span><br><span class="line">                trips == other.trips &amp;&amp;</span><br><span class="line">                date.compareTo(other.date) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles - other.activeVehicles != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> activeVehicles - other.activeVehicles;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trips - other.trips != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> trips - other.trips;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activeVehicles - other.activeVehicles != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> activeVehicles - other.activeVehicles;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trips - other.trips != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> trips - other.trips;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SecondarySortKey that = (SecondarySortKey) o;</span><br><span class="line">        <span class="keyword">return</span> activeVehicles == that.activeVehicles &amp;&amp;</span><br><span class="line">                trips == that.trips &amp;&amp;</span><br><span class="line">                Objects.equals(date, that.date);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(date, activeVehicles, trips);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SortResult&#123;"</span> +</span><br><span class="line">                <span class="string">"截止日期："</span> + date +</span><br><span class="line">                <span class="string">", 使用的机动车总数量："</span> + activeVehicles +</span><br><span class="line">                <span class="string">", 旅游总次数："</span> + trips +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、SecondarySortDemo-java"><a href="#2、SecondarySortDemo-java" class="headerlink" title="2、SecondarySortDemo.java"></a>2、SecondarySortDemo.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.spark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function2;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySortDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SparkConf conf = <span class="keyword">new</span> SparkConf().setAppName(<span class="string">"SecondarySortDemo"</span>).setMaster(<span class="string">"local"</span>);</span><br><span class="line">        JavaSparkContext jsc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">        jsc.setLogLevel(<span class="string">"WARN"</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; textfile = jsc.textFile(<span class="string">"/home/zkpk/experiment/mydata.log"</span>);</span><br><span class="line">        JavaPairRDD&lt;String, serDemo&gt; pairRdd = mapTfRDD2Pair(textfile);</span><br><span class="line">        JavaPairRDD&lt;String, serDemo&gt; getlines = aggregateByRegionID(pairRdd);</span><br><span class="line">        JavaPairRDD&lt;SecondarySortKey, String&gt; telval = mapRDDKey2SortKey(getlines);</span><br><span class="line">        JavaPairRDD&lt;SecondarySortKey, String&gt; sortedRdd = telval.sortByKey(<span class="keyword">false</span>);</span><br><span class="line">        List&lt;Tuple2&lt;SecondarySortKey, String&gt;&gt; getTop = sortedRdd.take(<span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">"============ result ============"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Tuple2&lt;SecondarySortKey, String&gt; dt : getTop) &#123;</span><br><span class="line">            System.out.println(<span class="string">"区域编号："</span> + dt._2 + <span class="string">", "</span> + dt._1);</span><br><span class="line">        &#125;</span><br><span class="line">        jsc.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//从文件读取生成PairRDD</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">mapTfRDD2Pair</span><span class="params">(JavaRDD&lt;String&gt; accessLogRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, serDemo&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, serDemo&gt; <span class="title">call</span><span class="params">(String lines)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] split = lines.split(<span class="string">","</span>);</span><br><span class="line">                String dispatchingBaseNumber = split[<span class="number">0</span>];</span><br><span class="line">                String date = split[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">int</span> activeVehicles = Integer.valueOf(split[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">int</span> trips = Integer.valueOf(split[<span class="number">3</span>]);</span><br><span class="line">                serDemo dataInfo = <span class="keyword">new</span> serDemo(date, activeVehicles, trips);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, serDemo&gt;(dispatchingBaseNumber, dataInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对PairRDD进行reduceByKey聚集操作求和</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">aggregateByRegionID</span><span class="params">(JavaPairRDD&lt;String, serDemo&gt; accessLogPairRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogPairRDD.reduceByKey(<span class="keyword">new</span> Function2&lt;serDemo, serDemo, serDemo&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> serDemo <span class="title">call</span><span class="params">(serDemo d1, serDemo d2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String date = d1.getDate().compareTo(d2.getDate()) &gt; <span class="number">0</span> ? d1.getDate() : d2.getDate();</span><br><span class="line">                <span class="keyword">int</span> activeVehicles = d1.getActiveVehicles() + d2.getActiveVehicles();</span><br><span class="line">                <span class="keyword">int</span> trips = d1.getTrips() + d2.getTrips();</span><br><span class="line">                serDemo accessLogInfo = <span class="keyword">new</span> serDemo();</span><br><span class="line">                accessLogInfo.setDate(date);</span><br><span class="line">                accessLogInfo.setActiveVehicles(activeVehicles);</span><br><span class="line">                accessLogInfo.setTrips(trips);</span><br><span class="line">                <span class="keyword">return</span> accessLogInfo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//对PairRDD进行排序，用于最后输出</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;SecondarySortKey, String&gt; <span class="title">mapRDDKey2SortKey</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            JavaPairRDD&lt;String, serDemo&gt; aggrAccessLogPairRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aggrAccessLogPairRDD.mapToPair(</span><br><span class="line">                <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;String, serDemo&gt;, SecondarySortKey, String&gt;() &#123;</span><br><span class="line">                    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Tuple2&lt;SecondarySortKey, String&gt; <span class="title">call</span><span class="params">(Tuple2&lt;String, serDemo&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        String dispatchingBaseNumber = tuple._1;</span><br><span class="line">                        serDemo accessLogInfo = tuple._2;</span><br><span class="line">                        SecondarySortKey accessLogSortKey = <span class="keyword">new</span> SecondarySortKey(accessLogInfo.getDate(), accessLogInfo.getActiveVehicles(),</span><br><span class="line">                                accessLogInfo.getTrips());</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;SecondarySortKey, String&gt;(accessLogSortKey, dispatchingBaseNumber);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、log-generate-py"><a href="#3、log-generate-py" class="headerlink" title="3、log_generate.py"></a>3、log_generate.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Copyright: Copyright (c) 2020 王兴宇 All Rights Reserved.</span></span><br><span class="line"><span class="string">@Project: log_generate</span></span><br><span class="line"><span class="string">@Description: </span></span><br><span class="line"><span class="string">@Version: </span></span><br><span class="line"><span class="string">@Author: 王兴宇</span></span><br><span class="line"><span class="string">@Date: 2020-06-03 11:20</span></span><br><span class="line"><span class="string">@LastEditors: 王兴宇</span></span><br><span class="line"><span class="string">@LastEditTime: 2020-06-03 11:20</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">file = open(<span class="string">"mydata.log"</span>, mode=<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line">ch = string.ascii_uppercase</span><br><span class="line">dispatching_base_number_list = []</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    dispatching_base_number_list.append(random.choice(ch) + str(random.randint(<span class="number">1</span>, <span class="number">9</span>)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> dispatching_base_number <span class="keyword">in</span> dispatching_base_number_list:</span><br><span class="line">        file.write(dispatching_base_number + <span class="string">","</span> +</span><br><span class="line">                   time.strftime(<span class="string">"%Y-%m-%d"</span>,</span><br><span class="line">                                 time.gmtime(</span><br><span class="line">                                     time.mktime(</span><br><span class="line">                                         time.strptime(<span class="string">"2020-01-02"</span>, <span class="string">"%Y-%m-%d"</span>)) + <span class="number">86400</span> * i)) + <span class="string">","</span> +</span><br><span class="line">                   str(random.randint(<span class="number">100</span>, <span class="number">10000</span>)) + <span class="string">","</span> +</span><br><span class="line">                   str(random.randint(<span class="number">1000</span>, <span class="number">100000</span>)) + <span class="string">"\n"</span>)</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">99</span> <span class="keyword">and</span> dispatching_base_number == dispatching_base_number_list[len(dispatching_base_number_list) - <span class="number">1</span>]:</span><br><span class="line">            file.write(dispatching_base_number + <span class="string">","</span> +</span><br><span class="line">                       time.strftime(<span class="string">"%Y-%m-%d"</span>,</span><br><span class="line">                                     time.gmtime(</span><br><span class="line">                                         time.mktime(</span><br><span class="line">                                             time.strptime(<span class="string">"2020-01-02"</span>, <span class="string">"%Y-%m-%d"</span>)) + <span class="number">86400</span> * i)) + <span class="string">","</span> +</span><br><span class="line">                       str(random.randint(<span class="number">100</span>, <span class="number">10000</span>)) + <span class="string">","</span> +</span><br><span class="line">                       str(random.randint(<span class="number">1000</span>, <span class="number">100000</span>)))</span><br><span class="line">file.close()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于大数据通过Java进行Spark编程实现自选日志处理分析。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Spark" scheme="https://666wxy666.github.io/tags/Spark/"/>
    
      <category term="单词计数" scheme="https://666wxy666.github.io/tags/%E5%8D%95%E8%AF%8D%E8%AE%A1%E6%95%B0/"/>
    
      <category term="Scala" scheme="https://666wxy666.github.io/tags/Scala/"/>
    
      <category term="流计算" scheme="https://666wxy666.github.io/tags/%E6%B5%81%E8%AE%A1%E7%AE%97/"/>
    
      <category term="Streaming" scheme="https://666wxy666.github.io/tags/Streaming/"/>
    
      <category term="Kafka" scheme="https://666wxy666.github.io/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>大数据实战 Spark 分析流量日志</title>
    <link href="https://666wxy666.github.io/2020/06/03/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-%E5%88%86%E6%9E%90%E6%B5%81%E9%87%8F%E6%97%A5%E5%BF%97/"/>
    <id>https://666wxy666.github.io/2020/06/03/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-%E5%88%86%E6%9E%90%E6%B5%81%E9%87%8F%E6%97%A5%E5%BF%97/</id>
    <published>2020-06-03T08:11:12.969Z</published>
    <updated>2020-06-03T08:13:32.837Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于大数据通过Java进行Spark编程实现日志处理分析。</p><a id="more"></a><h2 id="一、实验环境："><a href="#一、实验环境：" class="headerlink" title="一、实验环境："></a>一、实验环境：</h2><ul><li>虚拟机数量：1</li><li>系统版本：Centos 7.5</li><li>Spark版本：Apache Spark 2.1.1</li><li>Eclipse版本：Neno.3 （4.6.3）</li></ul><h2 id="二、实验目的："><a href="#二、实验目的：" class="headerlink" title="二、实验目的："></a>二、实验目的：</h2><p>掌握</p><ul><li>Spark原理</li><li>Hadoop原理</li><li>Shell</li><li>Spark Streaming</li><li>二次排序</li><li>序列化</li><li>Spark RDD</li></ul><h2 id="三、实验结果："><a href="#三、实验结果：" class="headerlink" title="三、实验结果："></a>三、实验结果：</h2><ul><li><p>以下是分析后的流量日志结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603142941.png" alt="7b6022296ee8fef49cd725321a76c1da" style="zoom:80%"></li></ul><h2 id="四、实验内容："><a href="#四、实验内容：" class="headerlink" title="四、实验内容："></a>四、实验内容：</h2><ul><li>使用SparkStreaming构建实时数据处理系统，来分析手机流量日志。</li></ul><h2 id="五、主要步骤："><a href="#五、主要步骤：" class="headerlink" title="五、主要步骤："></a>五、主要步骤：</h2><ul><li>日志分析</li><li>代码实现</li><li>运行程序</li></ul><h2 id="六、实验步骤："><a href="#六、实验步骤：" class="headerlink" title="六、实验步骤："></a>六、实验步骤：</h2><h3 id="6-1数据日志介绍"><a href="#6-1数据日志介绍" class="headerlink" title="6.1数据日志介绍"></a>6.1数据日志介绍</h3><p>6.1.1数据字段</p><p>6.1.1.1reportTime（报告时间戳）</p><p>6.1.1.2telNum（手机号）</p><p>6.1.1.3upwardflow（上行总流量）</p><p>6.1.1.4downwardflow（下行总流量）</p><h3 id="6-2需求分析"><a href="#6-2需求分析" class="headerlink" title="6.2需求分析"></a>6.2需求分析</h3><p>6.2.1对文本中数据记录进行排序，排序规则如下：</p><p>以telNum为基准，分别按照 upwardflow，downwardflow，reportTime进行降序排序，即先按照upwardflow排序，如果upwardflow相同，再比较downwardflow，如果downwardflow相同，再比较reportTime，最后选择前10条记录输出。</p><p>6.2.2具体实现步骤：</p><p>6.2.2.1按照 Serrializable 接口实现自定义排序的 Key</p><p>6.2.2.2将要进行二次排序的文件加载进来生成 key-value 类型的 RDD</p><p>6.2.2.3使用 sortByKey 基于自定义的 Key 进行二次排序</p><p>6.2.2.4去除掉排序的 key，只保留排序结果</p><h3 id="6-3代码实现："><a href="#6-3代码实现：" class="headerlink" title="6.3代码实现："></a>6.3代码实现：</h3><h4 id="6-3-1创建maven项目"><a href="#6-3-1创建maven项目" class="headerlink" title="6.3.1创建maven项目"></a>6.3.1创建maven项目</h4><p>6.3.1.1打开Eclipse IDE</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd eclipse/</span><br><span class="line">./eclipse &amp;</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143358.jpg" alt="2020-06-03_102818" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143419.jpg" alt="2020-06-03_102840" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143431.jpg" alt="2020-06-03_102917" style="zoom:80%"><p>6.3.1.2点击 File -&gt; New -&gt;Other</p><p>6.3.1.3搜索 maven -&gt; 点击 Maven Project -&gt; Next-&gt;Next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143443.jpg" alt="2020-06-03_103021" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143500.jpg" alt="2020-06-03_103035" style="zoom:80%"><p>6.3.1.4选中maven-archetype-quickstart -&gt;Next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143535.jpg" alt="2020-06-03_103051" style="zoom:80%"><p>6.3.1.5输入Group Id 为 org.zkpk；Artifact Id 为 spark ；Package为org.zkpk.spark；-&gt;Finish</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143603.jpg" alt="2020-06-03_103201" style="zoom:80%"><p>6.3.1.6升级maven工程</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143618.jpg" alt="2020-06-03_103247" style="zoom:80%"><p>升级完成：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143638.jpg" alt="2020-06-03_103513" style="zoom:80%"><p>6.3.1.7更改JRE，右键JRE System Library-&gt; Properties</p><p>6.3.1.8选中jdk1.8.0_131-&gt; OK</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143649.jpg" alt="2020-06-03_103535" style="zoom:80%"><p>6.3.1.9点击spark项目-&gt;修改pom.xml-&gt; 保存会自动下载jar包</p><p>6.3.1.10下载Jar包：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143734.jpg" alt="2020-06-03_103915" style="zoom:80%"><p>6.3.1.11最终 pom.xml 如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.zkpk<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>spark<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-hive_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-kafka_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-flume_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    </span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>src/main/test<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span><span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.mojo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>exec-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">executable</span>&gt;</span>java<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">includeProjectDependencies</span>&gt;</span>true<span class="tag">&lt;/<span class="name">includeProjectDependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">includePluginDependencies</span>&gt;</span>false<span class="tag">&lt;/<span class="name">includePluginDependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">classpathScope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">classpathScope</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>cn.com.syl.spark.App<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>6.3.1.12删除工程生成的App.java和AppTest.java</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143746.jpg" alt="2020-06-03_104358" style="zoom:80%"><h4 id="6-3-2编写代码"><a href="#6-3-2编写代码" class="headerlink" title="6.3.2编写代码"></a>6.3.2编写代码</h4><p>6.3.2.1在src/main/java中创建类，并命名为SecondarySortKey.java，然后按Finish</p><p>6.3.2.1.1创建SecondarySortKey.java，代码见附录</p><p>6.3.2.1.2在src/main/java中创建类，并命名为SecondarySortDemo，然后按Finish</p><p>6.3.2.1.3创建SecondarySortDemo.java代码见附录</p><p>6.3.2.1.4运行SecondarySortDemo，观察控制台输出</p><p>6.3.2.1.5右键SecondarySortDemo.java -&gt; Run As -&gt; Java Application</p><p>最终结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603143924.png" alt="QQ图片20200603110720" style="zoom:67%"><h2 id="七、附录"><a href="#七、附录" class="headerlink" title="七、附录"></a>七、附录</h2><h3 id="1、SecondarySortKey-java"><a href="#1、SecondarySortKey-java" class="headerlink" title="1、SecondarySortKey.java"></a>1、SecondarySortKey.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.spark;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> scala.math.Ordered;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">serDemo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5749943279909593929L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> reportTime;        <span class="comment">// 时间戳</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> upwardflow;        <span class="comment">// 上行总流量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> downwardflow;    <span class="comment">// 下行总流量</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">serDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">serDemo</span><span class="params">(<span class="keyword">long</span> reportTime, <span class="keyword">long</span> upwardflow, <span class="keyword">long</span> downwardflow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.reportTime = reportTime;</span><br><span class="line">        <span class="keyword">this</span>.upwardflow = upwardflow;</span><br><span class="line">        <span class="keyword">this</span>.downwardflow = downwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getReportTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reportTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReportTime</span><span class="params">(<span class="keyword">long</span> reportTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reportTime = reportTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUpwardflow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> upwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpwardflow</span><span class="params">(<span class="keyword">long</span> upwardflow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.upwardflow = upwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDownwardflow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> downwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDownwardflow</span><span class="params">(<span class="keyword">long</span> downwardflow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.downwardflow = downwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getSerialversionuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialVersionUID;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySortKey</span> <span class="keyword">implements</span> <span class="title">Ordered</span>&lt;<span class="title">SecondarySortKey</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3702442700882342403L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> upwardflow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> downwardflow;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> reportTime;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// TODO Auto-generated constructor stub</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondarySortKey</span><span class="params">(<span class="keyword">long</span> upwardflow, <span class="keyword">long</span> downwardflow, <span class="keyword">long</span> reportTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.upwardflow = upwardflow;</span><br><span class="line">        <span class="keyword">this</span>.downwardflow = downwardflow;</span><br><span class="line">        <span class="keyword">this</span>.reportTime = reportTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUpwardflow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> upwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpwardflow</span><span class="params">(<span class="keyword">long</span> upwardflow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.upwardflow = upwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDownwardflow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> downwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDownwardflow</span><span class="params">(<span class="keyword">long</span> downwardflow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.downwardflow = downwardflow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getReportTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reportTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReportTime</span><span class="params">(<span class="keyword">long</span> reportTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reportTime = reportTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getSerialversionuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialVersionUID;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $greater(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span>(upwardflow &gt; other.upwardflow) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow &gt; other.downwardflow) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow == other.downwardflow &amp;&amp;</span><br><span class="line">                reportTime &gt; other.reportTime) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $greater$eq(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span>($greater(other)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow == other.downwardflow &amp;&amp;</span><br><span class="line">                reportTime == other.reportTime) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $less(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span>(upwardflow &lt; other.upwardflow) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow &lt; other.downwardflow) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow == other.downwardflow &amp;&amp;</span><br><span class="line">                reportTime &lt; other.reportTime) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> $less$eq(SecondarySortKey other) &#123;</span><br><span class="line">        <span class="keyword">if</span>($less(other)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(upwardflow == other.upwardflow &amp;&amp;</span><br><span class="line">                downwardflow == other.downwardflow &amp;&amp;</span><br><span class="line">                reportTime == other.reportTime) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(upwardflow - other.upwardflow != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (upwardflow - other.upwardflow);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(downwardflow - other.downwardflow != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (downwardflow - other.downwardflow);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(reportTime - other.reportTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (reportTime - other.reportTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(SecondarySortKey other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(upwardflow - other.upwardflow != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (upwardflow - other.upwardflow);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(downwardflow - other.downwardflow != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (downwardflow - other.downwardflow);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(reportTime - other.reportTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (reportTime - other.reportTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> prime = <span class="number">31</span>;</span><br><span class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">        result = prime * result + (<span class="keyword">int</span>) (downwardflow );</span><br><span class="line">        result = prime * result + (<span class="keyword">int</span>) (reportTime );</span><br><span class="line">        result = prime * result + (<span class="keyword">int</span>) (upwardflow );</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == obj)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (getClass() != obj.getClass())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        SecondarySortKey other = (SecondarySortKey) obj;</span><br><span class="line">        <span class="keyword">if</span> (downwardflow != other.downwardflow)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (reportTime != other.reportTime)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (upwardflow != other.upwardflow)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SortResult： [上行总流量： "</span> + upwardflow + <span class="string">", 下行总流量：  "</span> + downwardflow + <span class="string">", 时间戳："</span></span><br><span class="line">                + reportTime + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、SecondarySortDemo-java"><a href="#2、SecondarySortDemo-java" class="headerlink" title="2、SecondarySortDemo.java"></a>2、SecondarySortDemo.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.spark;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function2;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondarySortDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 创建sparkcontext对象，sparkcontext是程序的唯一入口</span></span><br><span class="line">        SparkConf conf = <span class="keyword">new</span> SparkConf().setAppName(<span class="string">"SecondarySortDemo"</span>).setMaster(<span class="string">"local"</span>);</span><br><span class="line">        JavaSparkContext jsc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">        <span class="comment">// 去掉WARN类的输出信息</span></span><br><span class="line">        jsc.setLogLevel(<span class="string">"WARN"</span>);</span><br><span class="line">        <span class="comment">// 调用textFile()方法，读取日志文件，这里指定本地磁盘文件</span></span><br><span class="line">        JavaRDD&lt;String&gt; textfile = jsc.textFile(<span class="string">"/home/zkpk/experiment/data.log"</span>);</span><br><span class="line">        <span class="comment">// 调用mapTfRDD2Pair方法 将tf映射为键值对</span></span><br><span class="line">        JavaPairRDD&lt;String, serDemo&gt; pairRdd = mapTfRDD2Pair(textfile);</span><br><span class="line">        <span class="comment">// 获取每个手机号的总上行流量、总下行流量、最早报告时间戳</span></span><br><span class="line">        JavaPairRDD&lt;String, serDemo&gt; getlines = aggregateByDeviceID(pairRdd);</span><br><span class="line">        <span class="comment">// 聚合，封装的RDD作为key,手机号作为值</span></span><br><span class="line">        JavaPairRDD&lt;SecondarySortKey, String&gt; telval = mapRDDKey2SortKey(getlines);</span><br><span class="line">        <span class="comment">// 依次按照上行流量、下行流量以及时间戳倒序排序</span></span><br><span class="line">        JavaPairRDD&lt;SecondarySortKey, String&gt; sortedRdd = telval.sortByKey(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 根据您的需要获得输出，这里仅显示前10行</span></span><br><span class="line">        List&lt;Tuple2&lt;SecondarySortKey, String&gt;&gt; getTop = sortedRdd.take(<span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">"============ result ============"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Tuple2&lt;SecondarySortKey, String&gt; dt : getTop) &#123;</span><br><span class="line">            System.out.println(<span class="string">"telNum: "</span> + dt._2 + <span class="string">", "</span> + dt._1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行结束关闭资源</span></span><br><span class="line">        jsc.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mapTfRDD2Pair方法，封装键值对</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">mapTfRDD2Pair</span><span class="params">(JavaRDD&lt;String&gt; accessLogRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, serDemo&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, serDemo&gt; <span class="title">call</span><span class="params">(String lines)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 根据数据格式进行切分</span></span><br><span class="line">                String[] split = lines.split(<span class="string">"\t"</span>);</span><br><span class="line">                <span class="comment">// 获取切分的字段</span></span><br><span class="line">                <span class="keyword">long</span> reportTime = Long.valueOf(split[<span class="number">0</span>]);</span><br><span class="line">                String telNum = split[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">long</span> upwardflow = Long.valueOf(split[<span class="number">2</span>]);</span><br><span class="line">                <span class="keyword">long</span> downwardflow = Long.valueOf(split[<span class="number">3</span>]);</span><br><span class="line">                <span class="comment">// 创建cmbInfo对象，有参构造 ，将上行流量、下行流量，报告时间戳封装为自定义的可序列化对象</span></span><br><span class="line">                serDemo dataInfo = <span class="keyword">new</span> serDemo(reportTime, upwardflow, downwardflow);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, serDemo&gt;(telNum, dataInfo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据手机号进行聚合，依次按照上行流量、下行流量以及报告时间戳倒序排序</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;String, serDemo&gt; <span class="title">aggregateByDeviceID</span><span class="params">(JavaPairRDD&lt;String, serDemo&gt; accessLogPairRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogPairRDD.reduceByKey(<span class="keyword">new</span> Function2&lt;serDemo, serDemo, serDemo&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> serDemo <span class="title">call</span><span class="params">(serDemo d1, serDemo d2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> reportTime = d1.getReportTime() &lt; d2.getReportTime() ? d1.getReportTime() : d2.getReportTime();</span><br><span class="line">                <span class="keyword">long</span> upwardflow = d1.getUpwardflow() + d2.getUpwardflow();</span><br><span class="line">                <span class="keyword">long</span> downwardflow = d1.getDownwardflow() + d2.getDownwardflow();</span><br><span class="line">                serDemo accessLogInfo = <span class="keyword">new</span> serDemo();</span><br><span class="line">                accessLogInfo.setReportTime(reportTime);</span><br><span class="line">                accessLogInfo.setUpwardflow(upwardflow);</span><br><span class="line">                accessLogInfo.setDownwardflow(downwardflow);</span><br><span class="line">                <span class="keyword">return</span> accessLogInfo;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 二次排序，手机号作为值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JavaPairRDD&lt;SecondarySortKey, String&gt; <span class="title">mapRDDKey2SortKey</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            JavaPairRDD&lt;String, serDemo&gt; aggrAccessLogPairRDD)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aggrAccessLogPairRDD.mapToPair(</span><br><span class="line">                <span class="keyword">new</span> PairFunction&lt;Tuple2&lt;String, serDemo&gt;, SecondarySortKey, String&gt;() &#123;</span><br><span class="line">                    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Tuple2&lt;SecondarySortKey, String&gt; <span class="title">call</span><span class="params">(Tuple2&lt;String, serDemo&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// 获取元祖里的数据</span></span><br><span class="line">                        String telNum = tuple._1;</span><br><span class="line">                        serDemo accessLogInfo = tuple._2;</span><br><span class="line">                        <span class="comment">// 封装为二次排序key</span></span><br><span class="line">                        SecondarySortKey accessLogSortKey = <span class="keyword">new</span> SecondarySortKey(accessLogInfo.getUpwardflow(),</span><br><span class="line">                                accessLogInfo.getDownwardflow(), accessLogInfo.getReportTime());</span><br><span class="line">                        <span class="comment">// 返回新的Tuple</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;SecondarySortKey, String&gt;(accessLogSortKey, telNum);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于大数据通过Java进行Spark编程实现日志处理分析。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Spark" scheme="https://666wxy666.github.io/tags/Spark/"/>
    
      <category term="Java" scheme="https://666wxy666.github.io/tags/Java/"/>
    
      <category term="流计算" scheme="https://666wxy666.github.io/tags/%E6%B5%81%E8%AE%A1%E7%AE%97/"/>
    
      <category term="Streaming" scheme="https://666wxy666.github.io/tags/Streaming/"/>
    
      <category term="日志分析" scheme="https://666wxy666.github.io/tags/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>大数据实战 Python可视化 Matplotlib可视化</title>
    <link href="https://666wxy666.github.io/2020/06/02/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Python%E5%8F%AF%E8%A7%86%E5%8C%96-Matplotlib%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    <id>https://666wxy666.github.io/2020/06/02/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Python%E5%8F%AF%E8%A7%86%E5%8C%96-Matplotlib%E5%8F%AF%E8%A7%86%E5%8C%96/</id>
    <published>2020-06-02T04:54:06.290Z</published>
    <updated>2020-06-02T05:34:22.537Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于大数据通过Python的Matplotlib实现数据可视化。</p><a id="more"></a><h2 id="一、实验环境："><a href="#一、实验环境：" class="headerlink" title="一、实验环境："></a>一、实验环境：</h2><ul><li>虚拟机数量：1</li><li>系统版本：Centos 7.5</li><li>Anaconda版本：4.4.0</li></ul><h2 id="二、实验内容："><a href="#二、实验内容：" class="headerlink" title="二、实验内容："></a>二、实验内容：</h2><ul><li>通过创建Kafka topic，使用Kafka Producer产生消息，然后通过编写spark<br>Streaming程序处理这些消息。</li><li>主要步骤：<ul><li>Matplotlib的介绍</li><li>基本绘图函数</li><li>图表的修饰项介绍</li><li>子图绘制</li><li>图像的保存</li></ul></li></ul><h2 id="三、实验步骤："><a href="#三、实验步骤：" class="headerlink" title="三、实验步骤："></a>三、实验步骤：</h2><h3 id="3-1Matplotlib的介绍："><a href="#3-1Matplotlib的介绍：" class="headerlink" title="3.1Matplotlib的介绍："></a>3.1Matplotlib的介绍：</h3><p>在Python中，主要运用matplotlib库进行数据可视化。matplotlib是Python最著名的绘图库，它提供了一整套和matlab相似的命令API，十分适合交互式地进行制图。而且也可以方便地将它作为绘图控件，嵌入GUI应用程序中。</p><h3 id="3-2基本绘图函数："><a href="#3-2基本绘图函数：" class="headerlink" title="3.2基本绘图函数："></a>3.2基本绘图函数：</h3><p>matplotlib的pyplot子库提供了和matlab类似的绘图API，方便用户快速绘制2D图表。pyplot模块中常见的用来绘制图形的主要有以下几种函数：</p><p>3.2.1<strong>plot</strong>:常用于绘制线型图，该方法具有可变长参数，参数color指定颜色，参数linestyle设置线的样式、参数marker设置标记类型，结果返回一个lines.Line2D对象的列表，lines.Line2D对象的属性可通过plot的关键字参数设置。</p><p>3.2.2<strong>scatter</strong>: 用于绘制散点图；</p><p>3.2.3<strong>hist</strong>:用于绘制直方图，其参数中较为重要的是bins，该参数指定bin(箱子)的个数，即柱状图中柱子的总数，该值默认为10；</p><p>3.2.4<strong>show</strong>: 显示图像。</p><h3 id="3-3图表的修饰项介绍："><a href="#3-3图表的修饰项介绍：" class="headerlink" title="3.3图表的修饰项介绍："></a>3.3图表的修饰项介绍：</h3><p>对于大多数的图表装饰项，其主要实现方式主要有使用过程型的pyplot接口和面向对象的原生matplotlib API两种，分别对应的是函数编程和对象编程两种思想。</p><p>3.3.1<strong>title</strong>：设置或者获取图表标题；</p><p>3.3.2<strong>xlim</strong>：设置或者获取X轴范围；</p><p>3.3.3<strong>xlabel</strong>：设置或者获取X轴标签；</p><p>3.3.4<strong>xticks(&lt;刻度&gt;,&lt;标签&gt;)</strong>：设置或者获取X轴刻度和刻度标签；</p><p>3.3.5<strong>text(x,y,z)</strong>：将文本z绘制在图表的指定坐标(x,y)</p><p>3.3.6<strong>legend</strong>：自动创建图例，可以通过设置loc参数指定图例的位置。需要事先在添加图像时设置label参数。</p><p>3.3.7<strong>twinx(ax)</strong>：返回一个与子图对象ax的x轴一致y轴在右侧的子图对象ax2，用于绘制双轴图表。使用实例方法的形式为<code>ax2=ax.twinx()</code>。</p><p>3.3.8除了上面特别说明的，其它方法各自对应子图对象的的两个实例方法，以xlim为例，就是Axes.get_xlim和Axes.set_xlim。</p><h3 id="3-4子图绘制："><a href="#3-4子图绘制：" class="headerlink" title="3.4子图绘制："></a>3.4子图绘制：</h3><p>简单类型的Artists为标准的绘图元件，例如Line2D、Rectangle、Text、AxesImage等等。而<strong>容器类型</strong>则可以包含许多简单类型的Artists，使它们组织成一个整体，例如Axis、Axes、Figure等。</p><p>3.4.1<strong>figure</strong>：用来创建一个绘图对象，通常也可以不创建绘图对象而调用plot之类的函数直接绘图，matplotlib会自动创建一个绘图对象。通过figsize参数可以指定绘图对象的宽度和高度。如果需要同时绘制多幅图表的话，可以是给figure传递一个整数参数指定图表的序号，如果所指定序号的绘图对象已经存在的话，将不创建新的对象，而只是让它成为当前绘图对象；</p><p>3.4.2<strong>subplot</strong>：创建一个新的Figure，并返回一个含有已创建的subplot对象的NumPy数组。该方法的调用形式为：subplot(numRows,numCols, plotNum)，将整个绘图区域等分为numRows行、numCols列个<strong>子区域</strong>，然后按照从左到右，从上到下的顺序对每个子区域进行编号，左上的子区域的编号为1。如果numRows，numCols和plotNum的值都小于10，可以把它们缩写为一个整数，例如 subplot(321)和subplot(3,2,1)是相同的；对于绘图对象有add_subplot方法用于添加subplot对象；</p><p>3.4.3<strong>subplots</strong>：创建一个包含多个子图的Figure，返回Figure和一个或多个ax（子图）对象，可以通过设置sharex/sharey参数指定共享x轴/y轴；</p><p>3.4.4<strong>axes</strong>：同样往图表添加子图，不同之处在于子图可以设定在绘图区域的任意位置，axes的参数是一个形如[left,bottom, width,height]的列表，这些数值分别指定所创建的Axes对象相对于绘图对象的位置和大小，取值范围都在0到1之间。对于绘图对象有add_axes方法用于添加subplot对象。</p><h3 id="3-5图像的保存："><a href="#3-5图像的保存：" class="headerlink" title="3.5图像的保存："></a>3.5图像的保存：</h3><p>利用<code>plt.savefig</code>可以将当前图表保存到文件，该方法相当于Figure对象的实例方法savefig。具体参数如下：</p><p>3.5.1 fname：含有文件路径的字符串或Python的文件型对象；</p><p>3.5.2 dpi：图像分辨率（每英寸点数），默认为100；</p><p>3.5.3 facecolor，edgecolor，图像的背景色，默认为”w”，即白色；</p><p>3.5.4 format：显式设置文件格式（”png”、”pdf”、”svg”等）；</p><p>3.5.5 bbox_inches：图表需要保存的部分。</p><h3 id="3-6Matplotlib-绘图示例"><a href="#3-6Matplotlib-绘图示例" class="headerlink" title="3.6Matplotlib 绘图示例"></a>3.6Matplotlib 绘图示例</h3><p>3.6.1执行如下命令打开编程环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">ipython</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123119.jpg" alt="2020-06-02_110843" style="zoom:80%"><p>3.6.2绘制世界人口与年份的关系图：</p><p>3.6.2.1导入实验所需的库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.dates <span class="keyword">as</span> mdates</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123234.jpg" alt="2020-06-02_111044" style="zoom:80%"><p>3.6.2.2year 和pop为年份和对应的全世界人口数辆（单位10亿）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yearInt = [<span class="number">2005</span>, <span class="number">2006</span>, <span class="number">2007</span>, <span class="number">2008</span>, <span class="number">2009</span>, <span class="number">2010</span>, <span class="number">2011</span>, <span class="number">2012</span>, <span class="number">2013</span>, <span class="number">2014</span>, <span class="number">2015</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="number">2018</span>, <span class="number">2019</span>, <span class="number">2020</span>]</span><br><span class="line">year = [str(item) <span class="keyword">for</span> item <span class="keyword">in</span> yearInt]  <span class="comment"># 将yearInt中的数字转换成str</span></span><br><span class="line">pop = [<span class="number">6.49</span>, <span class="number">6.558</span>, <span class="number">6.656</span>, <span class="number">6.725</span>, <span class="number">6.804</span>, <span class="number">6.884</span>, <span class="number">6.965</span>, <span class="number">7.043</span>, <span class="number">7.125</span>, <span class="number">7.207</span>, <span class="number">7.356</span>, <span class="number">7.380</span>, <span class="number">7.405</span>, <span class="number">7.440</span>, <span class="number">7.468</span>, <span class="number">8.020</span>]</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123248.jpg" alt="2020-06-02_114653" style="zoom:80%"><p>3.6.2.3绘图</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xs = [datetime.strptime(d, <span class="string">'%Y'</span>).date() <span class="keyword">for</span> d <span class="keyword">in</span> year]  <span class="comment"># 将year中的每个如'2005'的字符串转换成只包含年的日期</span></span><br><span class="line">plt.gca().xaxis.set_major_formatter(mdates.DateFormatter(<span class="string">'%Y'</span>))  <span class="comment"># gca()获得坐标轴；</span></span><br><span class="line">plt.gca().xaxis.set_major_locator(mdates.YearLocator())  <span class="comment"># 年份</span></span><br><span class="line">plt.plot(xs, pop)  <span class="comment"># 绘制图表</span></span><br><span class="line">plt.gcf().autofmt_xdate()  <span class="comment"># 将x轴的日期自动旋转角度</span></span><br><span class="line">plt.show()  <span class="comment"># 显示图表</span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123256.jpg" alt="2020-06-02_115550" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123321.jpg" alt="2020-06-02_115609" style="zoom:80%"><h3 id="3-7在上一幅图表中添加另一条关于中国人品与年份关系的线，并对新图添加对应的修饰项"><a href="#3-7在上一幅图表中添加另一条关于中国人品与年份关系的线，并对新图添加对应的修饰项" class="headerlink" title="3.7在上一幅图表中添加另一条关于中国人品与年份关系的线，并对新图添加对应的修饰项"></a>3.7在上一幅图表中添加另一条关于中国人品与年份关系的线，并对新图添加对应的修饰项</h3><p>3.7.1添加中国人口数量关系</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plt.figure()</span><br><span class="line">pop_cn = [<span class="number">1.30756</span>, <span class="number">1.31448</span>, <span class="number">1.32129</span>, <span class="number">1.32802</span>, <span class="number">1.33450</span>, <span class="number">1.34091</span>, <span class="number">1.34735</span>, <span class="number">1.35404</span>, <span class="number">1.36072</span>, <span class="number">1.36782</span>, <span class="number">1.36790</span>, <span class="number">1.36801</span>,</span><br><span class="line">          <span class="number">1.36813</span>, <span class="number">1.36832</span>, <span class="number">1.36845</span>, <span class="number">1.36860</span>]</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123409.jpg" alt="2020-06-02_115923" style="zoom:80%"><p>3.7.2绘制人口数量和年份关系；year与pop仍然用之前的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plt.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">plt.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123441.jpg" alt="2020-06-02_120014" style="zoom:80%"><p>3.7.3添加修饰项</p><p>3.7.3.1添加x，y轴标签</p><p>3.7.3.2添加注解。注解点为(2008, 6.725)，内容为年(2013)</p><p>3.7.3.3添加图例，loc=1,表示图例出现在恰当的位置</p><p>3.7.3.4添加title</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plt.xlabel(<span class="string">'year'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Population'</span>)</span><br><span class="line">plt.text(<span class="string">'2008'</span>, <span class="number">6.725</span>, <span class="string">'2013'</span>)</span><br><span class="line">plt.legend(loc=<span class="number">1</span>)</span><br><span class="line">plt.title(<span class="string">"World Population Summary"</span>)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123531.jpg" alt="2020-06-02_120228" style="zoom:80%"><p>3.7.4显示图片</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123539.jpg" alt="2020-06-02_120321" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123546.jpg" alt="2020-06-02_120300" style="zoom:80%"><h3 id="3-8子图的绘制："><a href="#3-8子图的绘制：" class="headerlink" title="3.8子图的绘制："></a>3.8子图的绘制：</h3><p>利用plt.subplots函数创建包含多个子图的绘图对象，还可以设置子图个数。</p><p>3.8.1绘制x轴共享子图，</p><p>3.8.1.1子图个数设置为2，并且共享x轴</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f, (ax1, ax2) = plt.subplots(<span class="number">2</span>, sharex=<span class="literal">True</span>)  <span class="comment"># f是Figure对象；ax1,ax2分别是Axes</span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123723.jpg" alt="2020-06-02_120441" style="zoom:80%"><p>3.8.1.2使用散点图绘制</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax1.scatter(year, pop)  <span class="comment"># 绘制散点图</span></span><br><span class="line">ax2.scatter(year, pop_cn)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123731.jpg" alt="2020-06-02_120452" style="zoom:80%"><p>3.8.1.3添加修饰项：标题，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax1.set_title(<span class="string">'World Population Summary'</span>)  <span class="comment"># 设置标题</span></span><br><span class="line">ax2.set_title(<span class="string">"China Population Summary"</span>)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123737.jpg" alt="2020-06-02_120501" style="zoom:80%"><p>3.8.1.4显示图像</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123745.jpg" alt="2020-06-02_120725" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123752.jpg" alt="2020-06-02_120708" style="zoom:80%"><p>3.8.2绘制双y轴子图，共享x轴。</p><p>3.8.2.1创建绘图对象fig</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123926.jpg" alt="2020-06-02_120843" style="zoom:80%"><p>3.8.2.2使用fig.add_subplot函数为绘图对象fig添加两个子图，ax4通过使用ax3的twinx方法创建，且与ax3共享x中，放置在y轴右侧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax3 = fig.add_subplot(<span class="number">111</span>)  <span class="comment"># 参数是1个3位的整数或3个分隔的整数，描述子图的位置，分别是nrows,ncols,index</span></span><br><span class="line">ax4 = ax3.twinx()  <span class="comment"># 创建一个x轴，并创建一个与原y轴处于相对位置的新y轴</span></span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123932.jpg" alt="2020-06-02_120854" style="zoom:80%"><p>3.8.2.3绘制子图ax3， ax4</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax3.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">ax4.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123937.jpg" alt="2020-06-02_120905" style="zoom:80%"><p>3.8.2.4添加修饰项：添加x,y轴标签、 标题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ax3.set_ylabel(<span class="string">'World population'</span>)</span><br><span class="line">ax3.set_title(<span class="string">"Double Y axis"</span>)</span><br><span class="line">ax4.set_ylabel(<span class="string">'China population'</span>)</span><br><span class="line">ax4.set_xlabel(<span class="string">'Year'</span>)</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123942.jpg" alt="2020-06-02_121021" style="zoom:80%"><p>3.8.2.5显示图像</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123949.jpg" alt="2020-06-02_121101" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602123955.jpg" alt="2020-06-02_121049" style="zoom:80%"><h3 id="3-9图像的保存："><a href="#3-9图像的保存：" class="headerlink" title="3.9图像的保存："></a>3.9图像的保存：</h3><p>3.9.1代码使用双y轴的代码，代码末尾show（）方法改成保存方法即可</p><p>3.9.2使用plt.savfig()函数保存图像</p><p>3.9.2.1制定保存的名称，格式，像素，以及是否修渐空白区域。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax3 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">ax3.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">ax3.set_ylabel(<span class="string">'World population'</span>)</span><br><span class="line">ax3.set_title(<span class="string">"Double Y axis"</span>)</span><br><span class="line">ax4 = ax3.twinx()</span><br><span class="line">ax4.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br><span class="line">ax4.set_ylabel(<span class="string">'China population'</span>)</span><br><span class="line">ax4.set_xlabel(<span class="string">'Year'</span>)</span><br><span class="line">plt.savefig(<span class="string">'figure.pdf'</span>, dpi=<span class="number">400</span>, bbox_inches=<span class="string">'tight'</span>)  <span class="comment"># 去除空白区域</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602124041.jpg" alt="2020-06-02_121228" style="zoom:80%"><p>3.9.2.2点击关闭弹出的效果图</p><p>3.9.2.3查看保存的文件：打开火狐浏览器，地址栏键入如下内容（生成图片的绝对路径）</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602124053.jpg" alt="2020-06-02_121449" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200602124102.jpg" alt="2020-06-02_121529" style="zoom:80%"><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><h3 id="所有的代码汇总plt-py"><a href="#所有的代码汇总plt-py" class="headerlink" title="所有的代码汇总plt.py"></a>所有的代码汇总plt.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="string">@Project: plt_5</span></span><br><span class="line"><span class="string">@Description: </span></span><br><span class="line"><span class="string">@Version: </span></span><br><span class="line"><span class="string">@Author: 苇名一心</span></span><br><span class="line"><span class="string">@Date: 2020-06-02 11:46</span></span><br><span class="line"><span class="string">@LastEditors: 苇名一心</span></span><br><span class="line"><span class="string">@LastEditTime: 2020-06-02 11:46</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.dates <span class="keyword">as</span> mdates</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">yearInt = [<span class="number">2005</span>, <span class="number">2006</span>, <span class="number">2007</span>, <span class="number">2008</span>, <span class="number">2009</span>, <span class="number">2010</span>, <span class="number">2011</span>, <span class="number">2012</span>, <span class="number">2013</span>, <span class="number">2014</span>, <span class="number">2015</span>, <span class="number">2016</span>, <span class="number">2017</span>, <span class="number">2018</span>, <span class="number">2019</span>, <span class="number">2020</span>]</span><br><span class="line">year = [str(item) <span class="keyword">for</span> item <span class="keyword">in</span> yearInt]  <span class="comment"># 将yearInt中的数字转换成str</span></span><br><span class="line">pop = [<span class="number">6.49</span>, <span class="number">6.558</span>, <span class="number">6.656</span>, <span class="number">6.725</span>, <span class="number">6.804</span>, <span class="number">6.884</span>, <span class="number">6.965</span>, <span class="number">7.043</span>, <span class="number">7.125</span>, <span class="number">7.207</span>, <span class="number">7.356</span>, <span class="number">7.380</span>, <span class="number">7.405</span>, <span class="number">7.440</span>, <span class="number">7.468</span>, <span class="number">8.020</span>]</span><br><span class="line">xs = [datetime.strptime(d, <span class="string">'%Y'</span>).date() <span class="keyword">for</span> d <span class="keyword">in</span> year]  <span class="comment"># 将year中的每个如'2005'的字符串转换成只包含年的日期</span></span><br><span class="line">plt.gca().xaxis.set_major_formatter(mdates.DateFormatter(<span class="string">'%Y'</span>))  <span class="comment"># gca()获得坐标轴；</span></span><br><span class="line">plt.gca().xaxis.set_major_locator(mdates.YearLocator())  <span class="comment"># 年份</span></span><br><span class="line">plt.plot(xs, pop)  <span class="comment"># 绘制图表</span></span><br><span class="line">plt.gcf().autofmt_xdate()  <span class="comment"># 将x轴的日期自动旋转角度</span></span><br><span class="line">plt.show()  <span class="comment"># 显示图表</span></span><br><span class="line"></span><br><span class="line">plt.figure()</span><br><span class="line">pop_cn = [<span class="number">1.30756</span>, <span class="number">1.31448</span>, <span class="number">1.32129</span>, <span class="number">1.32802</span>, <span class="number">1.33450</span>, <span class="number">1.34091</span>, <span class="number">1.34735</span>, <span class="number">1.35404</span>, <span class="number">1.36072</span>, <span class="number">1.36782</span>, <span class="number">1.36790</span>, <span class="number">1.36801</span>,</span><br><span class="line">          <span class="number">1.36813</span>, <span class="number">1.36832</span>, <span class="number">1.36845</span>, <span class="number">1.36860</span>]</span><br><span class="line">plt.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">plt.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br><span class="line">plt.xlabel(<span class="string">'year'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'Population'</span>)</span><br><span class="line">plt.text(<span class="string">'2008'</span>, <span class="number">6.725</span>, <span class="string">'2013'</span>)</span><br><span class="line">plt.legend(loc=<span class="number">1</span>)</span><br><span class="line">plt.title(<span class="string">"World Population Summary"</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">f, (ax1, ax2) = plt.subplots(<span class="number">2</span>, sharex=<span class="literal">True</span>)  <span class="comment"># f是Figure对象；ax1,ax2分别是Axes</span></span><br><span class="line">ax1.scatter(year, pop)  <span class="comment"># 绘制散点图</span></span><br><span class="line">ax2.scatter(year, pop_cn)</span><br><span class="line">ax1.set_title(<span class="string">'World Population Summary'</span>)  <span class="comment"># 设置标题</span></span><br><span class="line">ax2.set_title(<span class="string">"China Population Summary"</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax3 = fig.add_subplot(<span class="number">111</span>)  <span class="comment"># 参数是1个3位的整数或3个分隔的整数，描述子图的位置，分别是nrows,ncols,index</span></span><br><span class="line">ax4 = ax3.twinx()  <span class="comment"># 创建一个x轴，并创建一个与原y轴处于相对位置的新y轴</span></span><br><span class="line">ax3.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">ax4.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br><span class="line">ax3.set_ylabel(<span class="string">'World population'</span>)</span><br><span class="line">ax3.set_title(<span class="string">"Double Y axis"</span>)</span><br><span class="line">ax4.set_ylabel(<span class="string">'China population'</span>)</span><br><span class="line">ax4.set_xlabel(<span class="string">'Year'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax3 = fig.add_subplot(<span class="number">111</span>)</span><br><span class="line">ax3.plot(year, pop, color=<span class="string">"g"</span>, label=<span class="string">"World population"</span>)</span><br><span class="line">ax3.set_ylabel(<span class="string">'World population'</span>)</span><br><span class="line">ax3.set_title(<span class="string">"Double Y axis"</span>)</span><br><span class="line">ax4 = ax3.twinx()</span><br><span class="line">ax4.plot(year, pop_cn, linestyle=<span class="string">"--"</span>, color=<span class="string">"r"</span>, label=<span class="string">"China population"</span>)</span><br><span class="line">ax4.set_ylabel(<span class="string">'China population'</span>)</span><br><span class="line">ax4.set_xlabel(<span class="string">'Year'</span>)</span><br><span class="line">plt.savefig(<span class="string">'figure.pdf'</span>, dpi=<span class="number">400</span>, bbox_inches=<span class="string">'tight'</span>)  <span class="comment"># 去除空白区域</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于大数据通过Python的Matplotlib实现数据可视化。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="Python" scheme="https://666wxy666.github.io/tags/Python/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="可视化" scheme="https://666wxy666.github.io/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
      <category term="iPython" scheme="https://666wxy666.github.io/tags/iPython/"/>
    
      <category term="Matplotlib" scheme="https://666wxy666.github.io/tags/Matplotlib/"/>
    
  </entry>
  
  <entry>
    <title>机器学习 实验 决策树</title>
    <link href="https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-%E5%86%B3%E7%AD%96%E6%A0%91/"/>
    <id>https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-%E5%86%B3%E7%AD%96%E6%A0%91/</id>
    <published>2020-05-24T06:29:25.511Z</published>
    <updated>2020-05-24T06:46:40.775Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于20问读心游戏的决策树代码实现。</p><a id="more"></a><h2 id="一、问题："><a href="#一、问题：" class="headerlink" title="一、问题："></a>一、问题：</h2><p>以20问读心游戏为例，以ID3算法（即信息增益算法）为基础，构造并绘制决策树，最后可以进行简单的测试游玩.</p><h2 id="二、实验环境"><a href="#二、实验环境" class="headerlink" title="二、实验环境"></a>二、实验环境</h2><ul><li>语言：Python 3.6（Anaconda3）</li><li>IDE：PyCharm 2020.1.1 (Professional Edition)</li><li>Packages：<ul><li>python standard library</li><li>numpy：1.16.2</li><li>scipy：1.2.1</li><li>pandas：0.24.2</li><li>networkx：2.4</li><li>graphviz：0.13.2</li><li>matplotlib：3.2.1</li></ul></li></ul><h2 id="三、实验结果"><a href="#三、实验结果" class="headerlink" title="三、实验结果"></a>三、实验结果</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524143530.jpg" alt="2020-05-24_112450" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524144633.jpg" alt="2020-05-24_112723" style="zoom:80%"><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><p>数据集data_set.txt：</p><p>男 运动员 70后 光头 80后 离婚 选秀 篮球 内地 演员<br>是 是 否 否 是 否 否 是 是 否 姚明<br>是 是 否 否 是 是 否 否 是 否 刘翔<br>是 是 是 是 否 否 否 是 否 否 科比<br>是 是 否 否 是 否 否 否 否 否 c罗<br>是 否 否 否 否 否 否 否 否 是 刘德华<br>是 否 否 否 否 否 是 否 是 否 毛不易<br>是 否 是 否 否 否 否 否 否 是 周杰伦<br>是 否 是 否 否 否 否 否 是 是 黄渤<br>是 否 是 是 否 否 否 否 是 是 徐峥<br>否 是 否 否 是 否 否 否 是 否 张怡宁<br>否 是 否 否 否 是 否 否 是 否 郎平<br>否 是 否 否 否 否 否 否 是 否 朱婷<br>否 否 否 否 否 否 是 否 是 是 杨超越<br>否 否 否 否 是 是 否 否 是 是 杨幂<br>否 否 否 否 否 否 否 否 否 否 邓紫棋<br>否 否 否 否 是 否 是 否 否 否 徐佳莹<br>否 否 否 否 是 否 否 否 是 是 赵丽颖</p><p>代码decision_tree.py：</p><ol start="0"><li><p>全局配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"># @Project: DecisionTree</span></span><br><span class="line"><span class="comment"># @Description: 以20问读心游戏为例，以ID3算法（即信息增益算法）为基础，构造并绘制决策树，最后进行测试</span></span><br><span class="line"><span class="comment"># @Version: 2.0</span></span><br><span class="line"><span class="comment"># @Author: 苇名一心</span></span><br><span class="line"><span class="comment"># @Date: 2020-03-10 8:30</span></span><br><span class="line"><span class="comment"># @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"># @LastEditTime: 2020-04-05 10:55</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> log</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 基本配置</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'font.sans-serif'</span>] = [<span class="string">'SimHei'</span>]</span><br><span class="line"><span class="comment"># 设置决策树样式</span></span><br><span class="line"><span class="comment"># boxstyle为文本框的类型，sawtooth是锯齿形，fc是边框线粗细</span></span><br><span class="line"><span class="comment"># arrowstyle是树的线为箭头样式</span></span><br><span class="line">decision_node = dict(boxstyle=<span class="string">"sawtooth"</span>, fc=<span class="string">"0.8"</span>)</span><br><span class="line">leaf_node = dict(boxstyle=<span class="string">"round4"</span>, fc=<span class="string">"0.8"</span>)</span><br><span class="line">arrow = dict(arrowstyle=<span class="string">"&lt;-"</span>)</span><br></pre></td></tr></table></figure></li></ol><ol><li><p>构造决策树</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 构造决策树</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入并创建数据集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_data_set</span><span class="params">()</span>:</span></span><br><span class="line">    data_set = []</span><br><span class="line">    <span class="comment"># 数据从文件获取</span></span><br><span class="line">    <span class="comment"># f = open(r'data_set.txt', encoding='UTF-8')</span></span><br><span class="line">    <span class="comment"># text = f.read().splitlines()</span></span><br><span class="line">    <span class="comment"># print("data_set.txt的内容为：")</span></span><br><span class="line">    <span class="comment"># for line in text:</span></span><br><span class="line">    <span class="comment">#     temp = line.split('\t')</span></span><br><span class="line">    <span class="comment">#     print(temp)</span></span><br><span class="line">    <span class="comment">#     data_set.append(temp)</span></span><br><span class="line">    <span class="comment"># 数据在程序中写死</span></span><br><span class="line">    data_set.append([<span class="string">"男"</span>, <span class="string">"运动员"</span>, <span class="string">"70后"</span>, <span class="string">"光头"</span>, <span class="string">"80后"</span>, <span class="string">"离婚"</span>, <span class="string">"选秀"</span>, <span class="string">"篮球"</span>, <span class="string">"内地"</span>, <span class="string">"演员"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"姚明"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"刘翔"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"科比"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"c罗"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"刘德华"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"毛不易"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"周杰伦"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"黄渤"</span>])</span><br><span class="line">    data_set.append([<span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"徐峥"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"张怡宁"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"郎平"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"朱婷"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"杨超越"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"杨幂"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"邓紫棋"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"徐佳莹"</span>])</span><br><span class="line">    data_set.append([<span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"否"</span>, <span class="string">"是"</span>, <span class="string">"是"</span>, <span class="string">"赵丽颖"</span>])</span><br><span class="line">    attr = data_set[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">del</span> (data_set[<span class="number">0</span>])</span><br><span class="line">    print(<span class="string">"属性集："</span>)</span><br><span class="line">    print(attr)</span><br><span class="line">    print(<span class="string">"数据集："</span>)</span><br><span class="line">    print(data_set)</span><br><span class="line">    <span class="keyword">return</span> data_set, attr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果数据集中的axis列，值为value，那么取出这一行，且去掉这一列，加入子数据集中</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_data_set</span><span class="params">(data_set, axis, value)</span>:</span></span><br><span class="line">    sub_data_set = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data_set:</span><br><span class="line">        <span class="keyword">if</span> line[axis] == value:</span><br><span class="line">            <span class="comment"># 去掉这一列</span></span><br><span class="line">            <span class="comment"># note: 用循环，较为麻烦</span></span><br><span class="line">            <span class="comment"># newline = []</span></span><br><span class="line">            <span class="comment"># for i in range(len(line)):</span></span><br><span class="line">            <span class="comment">#     if i != axis:</span></span><br><span class="line">            <span class="comment">#         newline.append(line[i])</span></span><br><span class="line">            <span class="comment"># sub_data_set.append(newline)</span></span><br><span class="line">            <span class="comment"># note: 易错点，如果直接newline = line，其实是newline和line指向同一个地址，会修改data_set中的值</span></span><br><span class="line">            newline = line[:]</span><br><span class="line">            <span class="keyword">del</span> newline[axis]</span><br><span class="line">            sub_data_set.append(newline)</span><br><span class="line">    <span class="keyword">return</span> sub_data_set</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算信息熵</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc_info_ent</span><span class="params">(data_set)</span>:</span></span><br><span class="line">    <span class="comment"># 数据集样本条数n</span></span><br><span class="line">    num = len(data_set)</span><br><span class="line">    <span class="comment"># 标签计数字典</span></span><br><span class="line">    count = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data_set:</span><br><span class="line">        <span class="comment"># 获取样本最后一列的标签</span></span><br><span class="line">        current_label = i[<span class="number">-1</span>]</span><br><span class="line">        <span class="comment"># 如果当前标签不在计数字典里，则初始化</span></span><br><span class="line">        <span class="keyword">if</span> current_label <span class="keyword">not</span> <span class="keyword">in</span> count.keys():</span><br><span class="line">            count[current_label] = <span class="number">0</span></span><br><span class="line">        count[current_label] += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 信息熵初始化</span></span><br><span class="line">    info_ent = <span class="number">0.0</span></span><br><span class="line">    <span class="comment"># 计算信息熵:sum(-P(X)log(P(x)))</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> count.keys():</span><br><span class="line">        <span class="comment"># 计算概率</span></span><br><span class="line">        probability = float(count[key]) / num</span><br><span class="line">        <span class="comment"># -P(X)log(P(x))</span></span><br><span class="line">        info_ent -= probability * log(probability, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> info_ent</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选出信息增益最大的最优属性</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">best_split</span><span class="params">(data_set)</span>:</span></span><br><span class="line">    <span class="comment"># 属性个数，data_set最后一列是标签，不是属性</span></span><br><span class="line">    feature_num = len(data_set[<span class="number">0</span>]) - <span class="number">1</span></span><br><span class="line">    <span class="comment"># 初始信息熵,也就是根节点的信息熵</span></span><br><span class="line">    base_ent = calc_info_ent(data_set)</span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    best_info_gain = <span class="number">0.0</span></span><br><span class="line">    best_index = <span class="number">-1</span></span><br><span class="line">    <span class="comment"># axis为列号</span></span><br><span class="line">    <span class="keyword">for</span> axis <span class="keyword">in</span> range(feature_num):</span><br><span class="line">        <span class="comment"># 获取每一列数据并去重</span></span><br><span class="line">        row = []</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> data_set:</span><br><span class="line">            row.append(line[axis])</span><br><span class="line">        unique_row = set(row)</span><br><span class="line">        new_ent = <span class="number">0.0</span></span><br><span class="line">        <span class="comment"># value为列可能的取值，在20问读心游戏里为：是/否</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> unique_row:</span><br><span class="line">            <span class="comment"># 取出axis列的值为value的子数据集</span></span><br><span class="line">            sub_data_set = split_data_set(data_set, axis, value)</span><br><span class="line">            <span class="comment"># 计算条件概率</span></span><br><span class="line">            probability = float(len(sub_data_set)) / len(data_set)</span><br><span class="line">            <span class="comment"># 计算条件熵</span></span><br><span class="line">            new_ent += probability * calc_info_ent(sub_data_set)</span><br><span class="line">        <span class="comment"># 计算信息增益</span></span><br><span class="line">        info_gain = base_ent - new_ent</span><br><span class="line">        <span class="keyword">if</span> info_gain &gt; best_info_gain:</span><br><span class="line">            best_info_gain = info_gain</span><br><span class="line">            best_index = axis</span><br><span class="line">    <span class="keyword">return</span> best_index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归方式创建决策树</span></span><br><span class="line"><span class="comment"># data_set为当前数据集，attr为剩余的还未用过的属性集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_tree</span><span class="params">(data_set, attr)</span>:</span></span><br><span class="line">    <span class="comment"># 获取标签，data_set的最后一列</span></span><br><span class="line">    <span class="comment"># note: 因为递归，data_set会改变，每次要从新的data_set中获取</span></span><br><span class="line">    true_labels = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data_set:</span><br><span class="line">        true_labels.append(line[<span class="number">-1</span>])</span><br><span class="line">    <span class="comment"># 递归终止条件：标签全部相同（例如全是‘姚明’），或者只有一个标签，没必要再进行下去，直接返回这个标签</span></span><br><span class="line">    <span class="keyword">if</span> true_labels.count(true_labels[<span class="number">0</span>]) == len(true_labels):</span><br><span class="line">        <span class="keyword">return</span> true_labels[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 递归终止条件：数据集中只有一个属性（只有一列，标签列，实际没有意义），没必要继续下去，直接返回列中相同值最多的标签</span></span><br><span class="line">    <span class="keyword">if</span> len(data_set[<span class="number">0</span>]) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> max(true_labels, key=true_labels.count)</span><br><span class="line">    <span class="comment"># 从当前数据集和剩余的属性集attr中获取最优属性(信息增益最大)的索引和属性名</span></span><br><span class="line">    best_index = best_split(data_set)</span><br><span class="line">    best_attr = attr[best_index]</span><br><span class="line">    <span class="comment"># 开始创建决策树</span></span><br><span class="line">    <span class="comment"># 初始化字典，创建根节点，第一个属性对应的也是一个字典</span></span><br><span class="line">    root = &#123;best_attr: &#123;&#125;&#125;</span><br><span class="line">    <span class="comment"># 获取最优属性对应的列并去重</span></span><br><span class="line">    best_row = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data_set:</span><br><span class="line">        best_row.append(line[best_index])</span><br><span class="line">    unique_row = set(best_row)</span><br><span class="line">    <span class="comment"># value为列可能的取值，在20问读心游戏里为：是/否</span></span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> unique_row:</span><br><span class="line">        <span class="comment"># 新建子属性集合，并且将用完的属性从属性集中删除</span></span><br><span class="line">        <span class="comment"># note: 最好是不要改变attr的内容，新建一个sub_attr拷贝attr，对sub_attr做删除操作</span></span><br><span class="line">        sub_attr = attr[:]</span><br><span class="line">        <span class="keyword">del</span> sub_attr[best_index]</span><br><span class="line">        <span class="comment"># 递归构造决策树</span></span><br><span class="line">        <span class="comment"># note: root[best_attr]是一个字典</span></span><br><span class="line">        <span class="comment">#  根据当前best_attr属性的所有可能的取值value进行构造，在20问读心游戏里为：是/否</span></span><br><span class="line">        <span class="comment">#  也就是说构造出的决策树是二叉树</span></span><br><span class="line">        root[best_attr][value] = create_tree(split_data_set(data_set, best_index, value), sub_attr)</span><br><span class="line">    <span class="keyword">return</span> root</span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>绘制决策树</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 绘制决策树（ps: 为了让画出来的树更美观，借鉴学习了《机器学习实战》中的好思路）</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取树的层数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_depth</span><span class="params">(decision_tree)</span>:</span></span><br><span class="line">    max_depth = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 将决策树dict的key转化为list并获取根结点属性名称</span></span><br><span class="line">    root_attr = list(decision_tree.keys())[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 根据根节点属性获取子树</span></span><br><span class="line">    sub_tree = decision_tree[root_attr]</span><br><span class="line">    <span class="comment"># 对子树字典所有的key，也就是root_attr所有的取值（在20问读心游戏里为：是/否）遍历</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sub_tree.keys():</span><br><span class="line">        <span class="comment"># 如果是字典对象，说明还未到叶子，继续递归</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(sub_tree[key], dict):</span><br><span class="line">            depth = get_depth(sub_tree[key]) + <span class="number">1</span></span><br><span class="line">        <span class="comment"># 如果不是字典对象，说明已经到达叶子，停止递归</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            depth = <span class="number">1</span></span><br><span class="line">        <span class="comment"># 判断深度是否大于最大深度</span></span><br><span class="line">        <span class="keyword">if</span> depth &gt; max_depth:</span><br><span class="line">            max_depth = depth</span><br><span class="line">    <span class="keyword">return</span> max_depth</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取树的叶子节点个数，也就是标签数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_leaf_num</span><span class="params">(decision_tree)</span>:</span></span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 将决策树dict的key转化为list并获取根结点属性名称</span></span><br><span class="line">    root_attr = list(decision_tree.keys())[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 根据根节点属性获取子树</span></span><br><span class="line">    sub_tree = decision_tree[root_attr]</span><br><span class="line">    <span class="comment"># 对子树字典所有的key，也就是root_attr所有的取值（在20问读心游戏里为：是/否）遍历</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sub_tree.keys():</span><br><span class="line">        <span class="comment"># 如果是字典对象，说明还未到叶子，继续递归</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(sub_tree[key], dict):</span><br><span class="line">            num += get_leaf_num(sub_tree[key])</span><br><span class="line">        <span class="comment"># 如果不是字典对象，说明已经到达叶子，停止递归</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建图对象，初始化，画图</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_plot</span><span class="params">(decision_tree)</span>:</span></span><br><span class="line">    <span class="comment"># 定义一个背景为白色的画布，并把画布清空</span></span><br><span class="line">    fig = plt.figure(<span class="number">1</span>, facecolor=<span class="string">'white'</span>)</span><br><span class="line">    fig.clf()</span><br><span class="line">    <span class="comment"># ax_prop为图形的样式，没有坐标轴标签</span></span><br><span class="line">    ax_prop = dict(xticks=[], yticks=[])</span><br><span class="line">    <span class="comment"># 使用subplot为定义了一个图，一行一列一个图，</span></span><br><span class="line">    <span class="comment"># frameon=False代表没有矩形边框</span></span><br><span class="line">    <span class="comment"># note: 在python里，[函数名称].[变量名]相当于是全局变量</span></span><br><span class="line">    <span class="comment"># ax1相当于是图对象，在其它函数中使用</span></span><br><span class="line">    create_plot.ax1 = plt.subplot(<span class="number">111</span>, frameon=<span class="literal">False</span>, **ax_prop)</span><br><span class="line">    <span class="comment"># total_width和total_depth分别代表初始决策树的叶子节点数目和深度，不改变</span></span><br><span class="line">    plot_tree.total_width = float(get_leaf_num(decision_tree))</span><br><span class="line">    plot_tree.total_depth = float(get_depth(decision_tree))</span><br><span class="line">    <span class="comment"># 图的大小是长0~1，宽0~1</span></span><br><span class="line">    <span class="comment"># note: x_offset实质是每个叶子的x坐标的位置</span></span><br><span class="line">    <span class="comment">#  第一片叶子的x为0.5/叶子数目，因此初始的x_offset设为-0.5/叶子数目</span></span><br><span class="line">    <span class="comment">#  每次将x_offset+(1/x_offset)，也就是第一个叶子不紧贴边框，有0.5/叶子数目的内边距</span></span><br><span class="line">    <span class="comment">#  例如绘制3个叶子，坐标应为1/3、2/3、3/3</span></span><br><span class="line">    <span class="comment">#  但这样整个图形会偏右，因此将初始的x_offset设为-0.5/3</span></span><br><span class="line">    <span class="comment">#  这样的话，每个叶子向左移了0.5/3，坐标变成了0.5/3、1.5/3、2.5/3，就刚好让图形在正中间了</span></span><br><span class="line">    <span class="comment">#  初始的y_offset显然为1，也就是最高点，每下降一层将y_offset-(1/深度)即可</span></span><br><span class="line">    plot_tree.x_offset = <span class="number">-0.5</span> / plot_tree.total_width</span><br><span class="line">    plot_tree.y_offset = <span class="number">1.0</span></span><br><span class="line">    <span class="comment"># 初始根节点位置为图形的正中间最上方，即(0.5, 1.0)</span></span><br><span class="line">    <span class="comment"># 初始节点文本为空，等待获取</span></span><br><span class="line">    plot_tree(decision_tree, (<span class="number">0.5</span>, <span class="number">1.0</span>), <span class="string">''</span>)</span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 递归画出决策树</span></span><br><span class="line"><span class="comment"># parent_pos为父节点位置，也就是当前决策树根节点的父节点位置</span></span><br><span class="line"><span class="comment"># arrow_text为父节点指来的箭头上的内容（在20问读心游戏里为：是/否）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_tree</span><span class="params">(decision_tree, parent_pos, arrow_text)</span>:</span></span><br><span class="line">    <span class="comment"># 获取当前决策树叶子数目</span></span><br><span class="line">    <span class="comment"># note: leaf_num与plot_tree.total_depth不同，前者针对的是当前的决策树，后者是针对的原来的整个决策树</span></span><br><span class="line">    leaf_num = get_leaf_num(decision_tree)</span><br><span class="line">    <span class="comment"># 将决策树dict的key转化为list并获取根结点属性名称</span></span><br><span class="line">    root_attr = list(decision_tree.keys())[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># root_pos为当前决策树的根节点的位置</span></span><br><span class="line">    <span class="comment"># note: 计算方法为</span></span><br><span class="line">    <span class="comment">#  拆分为三部分：</span></span><br><span class="line">    <span class="comment">#  1. plot_tree.x_offset：初始的x偏移，基准值</span></span><br><span class="line">    <span class="comment">#  2. float(numLeafs) / 2.0 / plotTree.totalW：</span></span><br><span class="line">    <span class="comment">#       float(numLeafs) * (1 / plotTree.totalW)为该决策树所包含的所有叶子所占的横坐标宽度</span></span><br><span class="line">    <span class="comment">#       / 2.0就是这个宽度的中间点</span></span><br><span class="line">    <span class="comment">#  3. 0.5 / plotTree.totalW：因为x_offset初始有-0.5/plotTree.totalW的偏移</span></span><br><span class="line">    <span class="comment">#       导致该节点并不是在区域中点，而是向左有个0.5/plotTree.totalW偏移</span></span><br><span class="line">    <span class="comment">#       因此+0.5 / plotTree.totalW，使其位于区域正中</span></span><br><span class="line">    <span class="comment">#  最终的公式经过合并就是下式：</span></span><br><span class="line">    root_pos = (plot_tree.x_offset + (<span class="number">1.0</span> + float(leaf_num)) / <span class="number">2.0</span> / plot_tree.total_width, plot_tree.y_offset)</span><br><span class="line">    <span class="comment"># 画出由当前子决策树父节点指来的箭头和箭头上的文本（在20问读心游戏里为：是/否）以及箭头指向的当前决策树的根节点</span></span><br><span class="line">    plot_arrow_text(root_pos, parent_pos, arrow_text)</span><br><span class="line">    <span class="comment"># 节点类型为决策类型decision_node，不是叶子</span></span><br><span class="line">    plot_node(root_pos, parent_pos, decision_node, root_attr)</span><br><span class="line">    <span class="comment"># 根据根节点属性获取子树</span></span><br><span class="line">    sub_tree = decision_tree[root_attr]</span><br><span class="line">    <span class="comment"># note: 每下降一层，将y_offset减1.0 / plot_tree.total_depth</span></span><br><span class="line">    plot_tree.y_offset = plot_tree.y_offset - <span class="number">1.0</span> / plot_tree.total_depth</span><br><span class="line">    <span class="comment"># 对子树字典所有的key，也就是root_attr所有的取值（在20问读心游戏里为：是/否）遍历</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sub_tree.keys():</span><br><span class="line">        <span class="comment"># 如果是字典对象，说明还未到叶子，继续递归</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(sub_tree[key], dict):</span><br><span class="line">            <span class="comment"># note: 子决策树为sub_tree[key]</span></span><br><span class="line">            <span class="comment">#  子决策树的父节点为当前决策树的根节点</span></span><br><span class="line">            <span class="comment">#  当前决策树指向子决策树的箭头上的文本为key，因为key不是字符串，要进行类型转换</span></span><br><span class="line">            plot_tree(sub_tree[key], root_pos, str(key))</span><br><span class="line">        <span class="comment"># 如果不是字典对象，说明已经到达叶子，停止递归</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 每到一个叶子，就把x_offset加1.0 / plot_tree.total_width</span></span><br><span class="line">            plot_tree.x_offset = plot_tree.x_offset + <span class="number">1.0</span> / plot_tree.total_width</span><br><span class="line">            <span class="comment"># 画出叶子、箭头</span></span><br><span class="line">            <span class="comment"># (plot_tree.x_offset, plot_tree.y_offset)刚好是叶子的坐标</span></span><br><span class="line">            <span class="comment"># root_pos为当前决策树的根节点坐标</span></span><br><span class="line">            <span class="comment"># 节点类型为叶子类型leaf_node</span></span><br><span class="line">            <span class="comment"># 因为是叶子，sub_tree[key]为字符串类型，也就是标签</span></span><br><span class="line">            plot_node((plot_tree.x_offset, plot_tree.y_offset), root_pos, leaf_node, sub_tree[key])</span><br><span class="line">            <span class="comment"># 画出箭头上的文本</span></span><br><span class="line">            <span class="comment"># 当前决策树指向叶子的箭头上的文本为key，因为key不是字符串，要进行类型转换</span></span><br><span class="line">            plot_arrow_text((plot_tree.x_offset, plot_tree.y_offset), root_pos, str(key))</span><br><span class="line">    <span class="comment"># note: 易错点，每次递归结束需要将y_offset加1.0 / plot_tree.total_depth，回到上一层</span></span><br><span class="line">    plot_tree.y_offset = plot_tree.y_offset + <span class="number">1.0</span> / plot_tree.total_depth</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 画节点和指向节点的箭头的函数</span></span><br><span class="line"><span class="comment"># root_pos为子节点的位置，也就是箭头指向的位置</span></span><br><span class="line"><span class="comment"># parent_pos为父节点的位置，也就是箭头尾部所在的位置</span></span><br><span class="line"><span class="comment"># node_type为节点类型，两种：决策节点（decision_node）和叶节点（leaf_node）</span></span><br><span class="line"><span class="comment"># node_text为要显示的文本，也就是节点的内容，即属性的名称（例如：男、运动员……）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_node</span><span class="params">(root_pos, parent_pos, node_type, node_text)</span>:</span></span><br><span class="line">    <span class="comment"># note: annotate用于在图形上给数据添加文本注解，支持带箭头的划线工具</span></span><br><span class="line">    <span class="comment">#  参数如下：</span></span><br><span class="line">    <span class="comment">#  s：注释文本的内容</span></span><br><span class="line">    <span class="comment">#  xy：被注释的坐标点，二维元组形如(x,y)</span></span><br><span class="line">    <span class="comment">#  xytext：注释文本的坐标点，也就是文本写的地方，也是二维元组，默认与xy相同</span></span><br><span class="line">    <span class="comment">#  xycoords：被注释点的坐标系属性，axes fraction是以子绘图区左下角为参考，单位是百分比</span></span><br><span class="line">    <span class="comment">#  textcoords：注释文本的坐标系属性，默认与xycoords属性值相同</span></span><br><span class="line">    <span class="comment">#  va="center"，ha="center"表示注释的坐标以注释框的正中心为准，而不是注释框的左下角(v代表垂直方向，h代表水平方向)</span></span><br><span class="line">    <span class="comment">#  bbox是注释框的风格和颜色深度，fc越小，注释框的颜色越深，支持输入一个字典</span></span><br><span class="line">    <span class="comment">#  arrowprops：箭头的样式，字典型数据，在画图的开头定义了</span></span><br><span class="line">    create_plot.ax1.annotate(node_text, xy=parent_pos, xycoords=<span class="string">'axes fraction'</span>,</span><br><span class="line">                             xytext=root_pos, textcoords=<span class="string">'axes fraction'</span>,</span><br><span class="line">                             va=<span class="string">"center"</span>, ha=<span class="string">"center"</span>, bbox=node_type, arrowprops=arrow)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 画箭头上文本的函数</span></span><br><span class="line"><span class="comment"># root_pos为子节点的位置，也就是箭头指向的位置</span></span><br><span class="line"><span class="comment"># parent_pos为父节点的位置，也就是箭头尾部所在的位置</span></span><br><span class="line"><span class="comment"># text为要显示的文本，也就是箭头上写的内容，即属性的取值（在20问读心游戏里为：是/否）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_arrow_text</span><span class="params">(root_pos, parent_pos, arrow_text)</span>:</span></span><br><span class="line">    <span class="comment"># 文本的位置应该处于箭头中间，也就是文本坐标=箭头头坐标+（箭头尾坐标-箭头头坐标）/2，因为箭头是向下指的</span></span><br><span class="line">    x_mid = root_pos[<span class="number">0</span>] + (parent_pos[<span class="number">0</span>] - root_pos[<span class="number">0</span>]) / <span class="number">2.0</span></span><br><span class="line">    y_mid = root_pos[<span class="number">1</span>] + (parent_pos[<span class="number">1</span>] - root_pos[<span class="number">1</span>]) / <span class="number">2.0</span></span><br><span class="line">    create_plot.ax1.text(x_mid, y_mid, arrow_text, va=<span class="string">"center"</span>, ha=<span class="string">"center"</span>, rotation=<span class="number">30</span>)</span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>测试函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 测试函数</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据决策树decision_tree(决策树字典对象)和标签列表labels对输入的测试向量test进行分类，输出类别</span></span><br><span class="line"><span class="comment"># test为列表，样例：['是', '否', '否', '否', '否', '否', '否', '否', '否', '是']</span></span><br><span class="line"><span class="comment"># note: 与决策树建立一样，也是使用递归，从根节点查起，直到叶子</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classify</span><span class="params">(decision_tree, labels, test)</span>:</span></span><br><span class="line">    <span class="comment"># 将决策树dict的key转化为list并获取根结点属性名称</span></span><br><span class="line">    <span class="comment"># note: 易错点，如果不转化为list会产生错误：</span></span><br><span class="line">    <span class="comment">#  TypeError: 'dict_keys' object does not support indexing</span></span><br><span class="line">    <span class="comment">#  原因是python3改变了dict.keys，返回的是dict_keys对象，支持iterable</span></span><br><span class="line">    <span class="comment">#  但不支持indexable，我们可以将其明确的转化成list来解决</span></span><br><span class="line">    root_attr = list(decision_tree.keys())[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 根据根节点属性获取子树</span></span><br><span class="line">    <span class="comment"># note: 子树也是一个字典对象，key为该属性的取值（在20问读心游戏里为：是/否）</span></span><br><span class="line">    <span class="comment">#  value也是一个字典对象，key为下一个属性，value为下一个属性对应的子树</span></span><br><span class="line">    sub_tree = decision_tree[root_attr]</span><br><span class="line">    <span class="comment"># 根据根节点属性名称获取在标签列表中对应的索引，并根据索引获取测试向量test该属性对应的值（在20问读心游戏里为：是/否）</span></span><br><span class="line">    value = test[labels.index(root_attr)]</span><br><span class="line">    <span class="comment"># 根据value的值（在20问读心游戏里为：是/否）获取决策树的子树字典</span></span><br><span class="line">    tree_of_value = sub_tree[value]</span><br><span class="line">    <span class="comment"># 用isinstance判断得到的对象是不是字典对象</span></span><br><span class="line">    <span class="comment"># 如果是字典，就不是叶子，继续递归</span></span><br><span class="line">    <span class="comment"># 如果不是字典，就是叶子，停止递归，tree_of_value就是分类结果</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(tree_of_value, dict):</span><br><span class="line">        label = classify(tree_of_value, labels, test)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        label = tree_of_value</span><br><span class="line">    <span class="keyword">return</span> label</span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>开始运行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 开始运行</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读入并创建数据集和属性集</span></span><br><span class="line">data_set, attr = create_data_set()</span><br><span class="line"><span class="comment"># 复制一份属性集attr用于递归，因为递归会将attr内容改变</span></span><br><span class="line">attr_copy = attr.copy()</span><br><span class="line">decision_tree = create_tree(data_set, attr_copy)</span><br><span class="line">print(<span class="string">"决策树结构为："</span>)</span><br><span class="line">print(decision_tree)</span><br><span class="line"><span class="comment"># 绘制决策树</span></span><br><span class="line">print(<span class="string">"绘制决策树……"</span>)</span><br><span class="line">create_plot(decision_tree)</span><br><span class="line">print(<span class="string">"决策树的深度为：%d"</span> % get_depth(decision_tree))</span><br><span class="line">print(<span class="string">"决策树叶子数目为：%d"</span> % get_leaf_num(decision_tree))</span><br></pre></td></tr></table></figure></li></ol><ol start="5"><li><p>测试游玩</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="string">"是否要进行测试（1是，0否）："</span>)</span><br><span class="line">flag = int(input())</span><br><span class="line"><span class="keyword">while</span> flag == <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">"请输入测试向量（以空格分隔每个问题的答案）："</span>)</span><br><span class="line">    test = input().split()</span><br><span class="line">    result = classify(decision_tree, attr, test)</span><br><span class="line">    print(<span class="string">"测试结果为：%s"</span> % result)</span><br><span class="line">    print(<span class="string">"是否要进行测试（1是，0否）："</span>)</span><br><span class="line">    flag = int(input())</span><br><span class="line">print(<span class="string">"程序成功退出，感谢使用……"</span>)</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于20问读心游戏的决策树代码实现。&lt;/p&gt;
    
    </summary>
    
    
      <category term="机器学习" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="Python" scheme="https://666wxy666.github.io/tags/Python/"/>
    
      <category term="机器学习" scheme="https://666wxy666.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="决策树" scheme="https://666wxy666.github.io/tags/%E5%86%B3%E7%AD%96%E6%A0%91/"/>
    
  </entry>
  
  <entry>
    <title>机器学习 实验 K-Means聚类</title>
    <link href="https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-K-Means%E8%81%9A%E7%B1%BB/"/>
    <id>https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%AE%9E%E9%AA%8C-K-Means%E8%81%9A%E7%B1%BB/</id>
    <published>2020-05-24T06:23:59.370Z</published>
    <updated>2020-05-24T06:52:50.474Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于经典聚类算法K-Means的代码实现。</p><a id="more"></a><h2 id="一、实验目标"><a href="#一、实验目标" class="headerlink" title="一、实验目标"></a>一、实验目标</h2><p>数据说明：目标是对 cluster.dat 里的数据进行聚类分析。其中，cluster.dat 包含了若干二维输入数据（但不包含其输出）。</p><ul><li><p>使用 K-means 模型进行聚类，尝试使用不同的类别个数 K，并分析聚类结果。</p></li><li><p>按照 8:2 的比例随机将数据划分为训练集和测试集，至少尝试 3 个不同的 K 值，并画出不同 K 下的聚类结果，及不同模型在训练集和测试集上的损失。对结果进行讨论，发现能解释数据的最好的 K值。</p></li></ul><h2 id="二、实验环境"><a href="#二、实验环境" class="headerlink" title="二、实验环境"></a>二、实验环境</h2><ul><li>语言：Python 3.7（Anaconda3）</li><li>IDE：PyCharm 2020.1.1 (Professional Edition)</li><li>Packages：<ul><li>numpy：1.18.1</li><li>matplotlib：3.1.3</li></ul></li></ul><h2 id="三、算法原理"><a href="#三、算法原理" class="headerlink" title="三、算法原理"></a>三、算法原理</h2><p>聚类是一种典型无监督学习，K-means算法是聚类的经典算法。目标是将原始数据集划分为k个簇，最小化损失函数（目标函数）是：<br>$$<br>SSE=\sum_{n=1}^{N}\sum_{k=1}^{K}r_{nk}dist(x_n-\mu_k)<br>$$</p><ul><li>$\mu_k$表示簇$C_k$的中心点（或其他能代表$C_k$的点）。</li><li>$x_n$被划分到簇$C_k$则$r_{nk}=1$，否则$r_{nk}=0$。</li><li>目标是找到簇的中心点$\mu_k$及簇的划分$r_{nk}$使得目标函数SSE最小。</li></ul><p>要解决上述问题就需要遍历所有可能的簇划分，显然这是不合适的。K-means算法使用了贪心策略求一个近似解，具体步骤如下：</p><ol><li>将全部数据随机分为k类，计算每类的重心作为初始点。</li><li>计算所有数据点与各个簇中心之间的距离，将数据点划到与它距离最近的簇中。</li><li>根据簇中已有的样本点，重新计算簇中心（一般使用重心）。</li><li>重复2、3，直到数据点的簇划分不在变化或者达到了规定的最大迭代次数。</li></ol><p>这是k-means算法的基本步骤，但是，这个算法有个很严重的问题，就是在将数据点划到与它距离最近的簇后，由于初始簇心选择不当，可能产生空簇，导致计算簇中心无法进行（簇的size=0，除数为0），我的解决方法是在计算簇心时，如果簇的size=0就先忽略，后面单独处理。计算完非空簇心后，依次选取与自己簇中心最远、次远……的点（因为距离自己的簇心越远，这个点分到该簇的概率越低）作为空簇的簇心，直到没有空簇，即所有的簇都有簇心，然后继续算法。</p><h2 id="四、算法流程图"><a href="#四、算法流程图" class="headerlink" title="四、算法流程图"></a>四、算法流程图</h2><p>这只是算法函数（algorithm）和其他一些部分的流程图，不是整个程序的流程图，整个程序要更复杂。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524095524.svg" alt="程序流程图" style="zoom:67%"><h2 id="五、实验结果及分析"><a href="#五、实验结果及分析" class="headerlink" title="五、实验结果及分析"></a>五、实验结果及分析</h2><ol><li><p>输入k的范围是[2,10]，测试集所占比例为0.2，最大迭代次数为20。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104752.jpg" alt="2020-05-24_104724" style="zoom:50%"></li><li><p>聚类结果</p><table><thead><tr><th align="center">k=2</th><th align="center">k=3</th><th align="center">k=4</th></tr></thead><tbody><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104824.jpg" alt="2020-05-24_104436" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104838.jpg" alt="2020-05-24_104447" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104853.jpg" alt="2020-05-24_104456" style="zoom:67%"></td></tr><tr><td align="center"><strong>k=5</strong></td><td align="center"><strong>k=6</strong></td><td align="center"><strong>k=7</strong></td></tr><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104910.jpg" alt="2020-05-24_104505" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104921.jpg" alt="2020-05-24_104521" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104933.jpg" alt="2020-05-24_104543" style="zoom:67%"></td></tr><tr><td align="center"><strong>k=8</strong></td><td align="center"><strong>k=9</strong></td><td align="center"><strong>k=10</strong></td></tr><tr><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524104954.jpg" alt="2020-05-24_104555" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524105001.jpg" alt="2020-05-24_104607" style="zoom:67%"></td><td align="center"><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524105008.jpg" alt="2020-05-24_104617" style="zoom:67%"></td></tr></tbody></table></li></ol><ol start="3"><li><p>k从2~10的数据集、训练集和测试集的SSE如图：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200524105029.jpg" alt="2020-05-24_104656" style="zoom:67%"></li><li><p>可以发现k=2~4时SSE下降较快，k=4~10时下降较慢，由于我们的目标是使SSE减小，因此由图可以得出k=4为解释数据较好的k。并且在k=2时，重复实验甚至会出现完全不同的聚类结果，说明k=2太小。在k&gt;=6之后，SSE基本不下降，说明k再加大没有多大意义。</p></li></ol><h2 id="六、附录"><a href="#六、附录" class="headerlink" title="六、附录"></a>六、附录</h2><p>kmeans.py：</p><ol start="0"><li><p>基本配置、全局参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="string">@Project: kmeans</span></span><br><span class="line"><span class="string">@Description: k-means算法</span></span><br><span class="line"><span class="string">@Version: 1.0</span></span><br><span class="line"><span class="string">@Author: 苇名一心</span></span><br><span class="line"><span class="string">@Date: 2020-05-22 21:25</span></span><br><span class="line"><span class="string">@LastEditors: 苇名一心</span></span><br><span class="line"><span class="string">@LastEditTime: 2020-05-22 21:25</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 全局变量</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">'font.sans-serif'</span>] = [<span class="string">'SimHei'</span>]</span><br><span class="line"><span class="comment"># 显示负号</span></span><br><span class="line">plt.rcParams[<span class="string">'axes.unicode_minus'</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 簇个数范围</span></span><br><span class="line">k_min = <span class="number">1</span></span><br><span class="line">k_max = <span class="number">1</span></span><br><span class="line">max_iteration = <span class="number">10</span>  <span class="comment"># 最大迭代次数</span></span><br><span class="line">test_rate = <span class="number">0.2</span>  <span class="comment"># 训练集所占比例</span></span><br><span class="line">all_point_num = <span class="number">0</span></span><br><span class="line">data_x = []  <span class="comment"># 点的x坐标列表</span></span><br><span class="line">data_y = []  <span class="comment"># 点的y坐标列表</span></span><br><span class="line">data_SSE_list = []  <span class="comment"># 数据集损失目标函数列表</span></span><br><span class="line">train_SSE_list = []  <span class="comment"># 训练集损失目标函数列表</span></span><br><span class="line">test_SSE_list = []  <span class="comment"># 测试集损失目标函数列表</span></span><br></pre></td></tr></table></figure></li></ol><ol><li><p>读入数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 读入数据</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_data</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> all_point_num</span><br><span class="line">    <span class="keyword">global</span> test_rate</span><br><span class="line">    <span class="keyword">global</span> max_iteration</span><br><span class="line">    <span class="keyword">global</span> k_min</span><br><span class="line">    <span class="keyword">global</span> k_max</span><br><span class="line">    data = open(path)  <span class="comment"># 打开数据文件</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> data:</span><br><span class="line">        <span class="comment"># 将数据文件的每一行按空格分隔，分别添加到x,y列表</span></span><br><span class="line">        data_x.append(float(line.split()[<span class="number">0</span>]))</span><br><span class="line">        data_y.append(float(line.split()[<span class="number">1</span>]))</span><br><span class="line">        all_point_num += <span class="number">1</span></span><br><span class="line">    print(<span class="string">"请输入k的范围（空格分隔，例如2 5，代表闭区间[2,5]）："</span>, end=<span class="string">""</span>)</span><br><span class="line">    k_min, k_max = map(int, input().split())</span><br><span class="line">    <span class="keyword">if</span> k_min &gt; k_max <span class="keyword">or</span> k_min &lt; <span class="number">1</span> <span class="keyword">or</span> k_max &lt; <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">"ERROR: 簇的个数输入错误！"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"请输入测试集所占比例："</span>, end=<span class="string">""</span>)</span><br><span class="line">    test_rate = float(input())</span><br><span class="line">    <span class="keyword">if</span> test_rate &lt; <span class="number">0</span> <span class="keyword">or</span> test_rate &gt; <span class="number">1</span>:</span><br><span class="line">        print(<span class="string">"ERROR: 测试集所占比例输入错误！"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"请输入最大迭代次数："</span>, end=<span class="string">""</span>)</span><br><span class="line">    max_iteration = int(input())</span><br><span class="line">    <span class="keyword">if</span> max_iteration &lt; <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"ERROR: 最大迭代次数输入错误！"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>算法计算</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 算法</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">algorithm</span><span class="params">(x, y, k)</span>:</span></span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    n = <span class="number">0</span>  <span class="comment"># 迭代次数</span></span><br><span class="line">    SSE = <span class="number">0</span>  <span class="comment"># 损失（目标）函数</span></span><br><span class="line">    point_array = np.array([x, y])  <span class="comment"># 生成点的numpy数组，例如三个点(1，-1),(2，-2),(3，-3)生成[[ 1  2  3 ][ -1 -2 -3 ]]</span></span><br><span class="line">    point_num = point_array.shape[<span class="number">1</span>]  <span class="comment"># 获取点的个数，所给的数据集为1000个点，取0.8为800个</span></span><br><span class="line">    <span class="comment"># 如果点的个数&lt;簇的个数，则报错异常退出</span></span><br><span class="line">    <span class="keyword">if</span> point_num &lt; k:</span><br><span class="line">        print(<span class="string">"ERROR: 点的个数&lt;簇的个数！"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    distance = np.zeros(k)  <span class="comment"># 初始化k维0向量，用来存储这个点到的k个簇中心的距离</span></span><br><span class="line">    point_distance = np.zeros(point_num)  <span class="comment"># 初始化point_num维0向量，用来存储每个点到其簇中心的距离</span></span><br><span class="line">    center = np.zeros((<span class="number">2</span>, k))  <span class="comment"># 生成2*k的零矩阵，初始化k个簇的中心点，后面将先计算每个簇的重心作为初始簇中心</span></span><br><span class="line">    point_k1 = np.arange(<span class="number">0</span>, k, <span class="number">1</span>)  <span class="comment"># 先生成0~k-1的数组，保证每个簇至少有一个点</span></span><br><span class="line">    point_k2 = np.random.randint(<span class="number">0</span>, k, size=point_num - k)  <span class="comment"># 将剩下的点随机分到任意一个簇，返回长度为point_num-k的向量，每个为0~k-1的随机整数</span></span><br><span class="line">    point_k = np.concatenate((point_k1, point_k2))  <span class="comment"># 将前两个数组合成为一个</span></span><br><span class="line">    np.random.shuffle(point_k)  <span class="comment"># 最后再打乱一次point_k数组，保证随机性</span></span><br><span class="line">    point_k_bak = point_k.copy()  <span class="comment"># point_k的备份，用于判断前后两次迭代是否发生变化</span></span><br><span class="line">    <span class="comment"># 输出相关信息</span></span><br><span class="line">    print(<span class="string">"点个数为："</span>, point_num, sep=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 开始K-means算法的迭代</span></span><br><span class="line">    <span class="comment"># 只要迭代次数没有超过最大迭代次数上限max_iteration并且两次迭代的结果还有变化，就继续迭代</span></span><br><span class="line">    <span class="keyword">while</span> n &lt;= max_iteration:</span><br><span class="line">        <span class="comment"># 计算每个簇的中心</span></span><br><span class="line">        size = np.bincount(point_k, minlength=k)  <span class="comment"># 计算每个簇的规模，k维向量，每一维为每个簇里点的个数</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(k):  <span class="comment"># 对于k个簇中的每一个簇i</span></span><br><span class="line">            <span class="comment"># 不是空簇，防止出现除数为0，空簇下面单独处理</span></span><br><span class="line">            <span class="keyword">if</span> size[i] != <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># point_sum是一个二维向量，代表i簇中的所有点的x,y坐标值的和</span></span><br><span class="line">                point_sum = np.zeros(<span class="number">2</span>)  <span class="comment"># 初始化为0</span></span><br><span class="line">                <span class="comment"># 计算i簇中的所有点的x,y坐标值的和</span></span><br><span class="line">                <span class="keyword">for</span> point <span class="keyword">in</span> range(point_num):  <span class="comment"># 对于每一个点point</span></span><br><span class="line">                    <span class="keyword">if</span> point_k[point] == i:  <span class="comment"># 如果这个点point属于簇i</span></span><br><span class="line">                        point_sum = point_sum + point_array[:, point]  <span class="comment"># 将这个点的x,y坐标加到point_sum上</span></span><br><span class="line">                        <span class="comment"># note: array[:, i]就是取array的第i列，刚好就是这个点</span></span><br><span class="line">                <span class="comment"># 求平均数，因此要/这个簇中点的个数size[i]</span></span><br><span class="line">                <span class="comment"># 将计算出的簇中心存在center矩阵中的第i列，代表第i个簇的中心点</span></span><br><span class="line">                center[:, i] = point_sum / size[i]</span><br><span class="line">        <span class="comment"># 对所有的空簇单独处理</span></span><br><span class="line">        <span class="comment"># 处理方式为把与自己所在的簇中心距离最大的点作为空簇的簇中心</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> np.where(size == <span class="number">0</span>)[<span class="number">0</span>]:</span><br><span class="line">            <span class="comment"># 将距离最大的点的所在簇改为空簇的簇号</span></span><br><span class="line">            point_k[np.argmax(point_distance)] = c</span><br><span class="line">            <span class="comment"># 将空簇中心改为这个点</span></span><br><span class="line">            center[:, c] = point_array[:, np.argmax(point_distance)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将每一个点分到与簇中心最近的簇</span></span><br><span class="line">        <span class="keyword">for</span> point <span class="keyword">in</span> range(point_num):  <span class="comment"># 对于每一个点point</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(k):  <span class="comment"># 对于k个簇中的每一个簇i</span></span><br><span class="line">                <span class="comment"># 计算该点point到该簇i的距离</span></span><br><span class="line">                <span class="comment"># note: 使用矩阵的2范式，来计算欧氏距离</span></span><br><span class="line">                <span class="comment">#  point_array[:, point] - center[:, i]得到向量[p_x-c_x, p_y-c_y]</span></span><br><span class="line">                <span class="comment">#  对该向量求2范式刚好是欧式距离sqrt((p_x-c_x)^2+(p_y-c_y)^2)</span></span><br><span class="line">                distance[i] = np.linalg.norm(point_array[:, point] - center[:, i])</span><br><span class="line">            <span class="comment"># 使用numpy的argmin()返回distance中最小值的下标，也就是点point到簇中心距离最小的簇</span></span><br><span class="line">            point_k[point] = np.argmin(distance)</span><br><span class="line">            <span class="comment"># 将该点到其簇中心的距离记录下来</span></span><br><span class="line">            point_distance[point] = distance[point_k[point]]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 迭代次数+1</span></span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="comment"># 判断两次迭代是否有变化，没有变化就跳出迭代循环</span></span><br><span class="line">        <span class="keyword">if</span> (point_k == point_k_bak).all():</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># 将point_k备份</span></span><br><span class="line">        point_k_bak = point_k.copy()</span><br><span class="line">        <span class="comment"># 输出每次迭代目标函数值</span></span><br><span class="line">        SSE = np.sum(point_distance)</span><br><span class="line">        print(<span class="string">"n="</span>, n - <span class="number">1</span>, <span class="string">"，SSE="</span>, SSE, sep=<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出相关信息</span></span><br><span class="line">    print(<span class="string">"总迭代次数为："</span>, n - <span class="number">1</span>, sep=<span class="string">""</span>)</span><br><span class="line">    print(<span class="string">"每个簇的中心："</span>, sep=<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(k):</span><br><span class="line">        print(<span class="string">"("</span>, center[<span class="number">0</span>, i], <span class="string">","</span>, center[<span class="number">1</span>, i], <span class="string">")"</span>, sep=<span class="string">""</span>)</span><br><span class="line">    print(<span class="string">"==================================================="</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SSE, point_k</span><br></pre></td></tr></table></figure></li></ol><ol start="3"><li><p>画图展示</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 画图展示</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 根据每个点所在的簇，获取点的颜色，返回一个列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_color_list</span><span class="params">(point_k, k)</span>:</span></span><br><span class="line">    <span class="comment"># 随机生成k个颜色</span></span><br><span class="line">    RGB = [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'D'</span>, <span class="string">'E'</span>, <span class="string">'F'</span>]</span><br><span class="line">    colors = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; k:</span><br><span class="line">        color = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            color += RGB[random.randint(<span class="number">0</span>, <span class="number">14</span>)]</span><br><span class="line">        <span class="comment"># 只有随机产生的颜色不相同，才加到colors中，颜色个数+1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"#"</span> + color <span class="keyword">not</span> <span class="keyword">in</span> colors <span class="keyword">and</span> color != <span class="string">"FFFFFF"</span>:</span><br><span class="line">            colors.append(<span class="string">"#"</span> + color)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 对每个点，根据point_k中记录的点所在的簇，将颜色添加到列表中</span></span><br><span class="line">    color_list = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> point_k:</span><br><span class="line">        color_list.append(colors[c])</span><br><span class="line">    <span class="keyword">return</span> color_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 画散点图展示聚类结果（数据集，训练集、测试集）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(x, y, result, x1, y1, result1, x2, y2, result2, k)</span>:</span></span><br><span class="line">    <span class="comment"># 数据集图</span></span><br><span class="line">    plt.subplot(<span class="number">131</span>)</span><br><span class="line">    <span class="comment"># 设置标题</span></span><br><span class="line">    plt.title(<span class="string">"K-Means数据集"</span>)</span><br><span class="line">    <span class="comment"># 绘制散点图</span></span><br><span class="line">    <span class="comment"># note: scatter函数支持传入颜色列表，对每一个点使用列表相应下标对应的颜色</span></span><br><span class="line">    plt.scatter(x, y, c=get_color_list(result, k))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 训练集图</span></span><br><span class="line">    plt.subplot(<span class="number">132</span>)</span><br><span class="line">    <span class="comment"># 设置标题</span></span><br><span class="line">    plt.title(<span class="string">"K-Means训练集"</span>)</span><br><span class="line">    <span class="comment"># 绘制散点图</span></span><br><span class="line">    plt.scatter(x1, y1, c=get_color_list(result1, k))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试集图</span></span><br><span class="line">    plt.subplot(<span class="number">133</span>)</span><br><span class="line">    <span class="comment"># 设置标题</span></span><br><span class="line">    plt.title(<span class="string">"K-Means测试集"</span>)</span><br><span class="line">    <span class="comment"># 绘制散点图</span></span><br><span class="line">    plt.scatter(x2, y2, c=get_color_list(result2, k))</span><br><span class="line">    <span class="comment"># 展示散点图</span></span><br><span class="line"></span><br><span class="line">    plt.show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 画折线图展示SSE对比</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_SSE</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 设置标题</span></span><br><span class="line">    plt.title(<span class="string">"K-Means在不同k下的损失"</span>)</span><br><span class="line">    <span class="comment"># 设置x轴坐标</span></span><br><span class="line">    plt.xlim(k_min - <span class="number">1</span>, k_max + <span class="number">2</span>)</span><br><span class="line">    plt.xlabel(<span class="string">"k"</span>)  <span class="comment"># 设置x轴标注</span></span><br><span class="line">    plt.ylabel(<span class="string">"SSE"</span>)  <span class="comment"># 设置y轴标注</span></span><br><span class="line">    <span class="comment"># 绘制K-Means在不同k下训练集和测试集的损失</span></span><br><span class="line">    plt.plot(range(k_min, k_max + <span class="number">1</span>), data_SSE_list, lw=<span class="number">1</span>, c=<span class="string">'blue'</span>, marker=<span class="string">'v'</span>, ms=<span class="number">4</span>, label=<span class="string">'数据集'</span>)</span><br><span class="line">    plt.plot(range(k_min, k_max + <span class="number">1</span>), train_SSE_list, lw=<span class="number">1</span>, c=<span class="string">'red'</span>, marker=<span class="string">'s'</span>, ms=<span class="number">4</span>, label=<span class="string">'训练集'</span>)</span><br><span class="line">    plt.plot(range(k_min, k_max + <span class="number">1</span>), test_SSE_list, lw=<span class="number">1</span>, c=<span class="string">'green'</span>, marker=<span class="string">'o'</span>, label=<span class="string">'测试集'</span>)</span><br><span class="line">    plt.legend()  <span class="comment"># 图例</span></span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure></li></ol><ol start="4"><li><p>开始运行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 开始运行</span></span><br><span class="line"><span class="comment">########################################################</span></span><br><span class="line"><span class="comment"># 读入数据</span></span><br><span class="line">read_data(<span class="string">"cluster.dat"</span>)</span><br><span class="line"><span class="comment"># 划分训练集和测试集</span></span><br><span class="line">train_x, test_x, train_y, test_y = train_test_split(data_x, data_y, test_size=test_rate, random_state=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 对k从2~5进行聚类</span></span><br><span class="line"><span class="keyword">for</span> k_num <span class="keyword">in</span> range(k_min, k_max + <span class="number">1</span>):</span><br><span class="line">    print(<span class="string">"###################################################"</span>)</span><br><span class="line">    print(<span class="string">"簇个数为："</span>, k_num, sep=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 数据集</span></span><br><span class="line">    print(<span class="string">"数据集："</span>)</span><br><span class="line">    data_SSE, data_result = algorithm(data_x, data_y, k_num)</span><br><span class="line">    data_SSE_list.append(data_SSE)</span><br><span class="line">    <span class="comment"># 训练集</span></span><br><span class="line">    print(<span class="string">"训练集："</span>)</span><br><span class="line">    train_SSE, train_result = algorithm(train_x, train_y, k_num)</span><br><span class="line">    train_SSE_list.append(train_SSE)</span><br><span class="line">    <span class="comment"># 测试集</span></span><br><span class="line">    print(<span class="string">"测试集："</span>)</span><br><span class="line">    test_SSE, test_result = algorithm(test_y, test_y, k_num)</span><br><span class="line">    test_SSE_list.append(test_SSE)</span><br><span class="line">    <span class="comment"># 输出平均SSE</span></span><br><span class="line">    print(<span class="string">"数据集最终平均损失函数AVG_SSE："</span>, data_SSE / all_point_num)</span><br><span class="line">    print(<span class="string">"训练集最终平均损失函数AVG_SSE："</span>, train_SSE / (all_point_num * (<span class="number">1</span> - test_rate)))</span><br><span class="line">    print(<span class="string">"测试集最终平均损失函数AVG_SSE："</span>, test_SSE / (all_point_num * test_rate))</span><br><span class="line">    <span class="comment"># 画图</span></span><br><span class="line">    show(data_x, data_y, data_result, train_x, train_y, train_result, test_x, test_y, test_result, k_num)</span><br><span class="line"><span class="comment"># 画图展示SSE</span></span><br><span class="line">show_SSE()</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于经典聚类算法K-Means的代码实现。&lt;/p&gt;
    
    </summary>
    
    
      <category term="机器学习" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="Python" scheme="https://666wxy666.github.io/tags/Python/"/>
    
      <category term="机器学习" scheme="https://666wxy666.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="K-Means" scheme="https://666wxy666.github.io/tags/K-Means/"/>
    
      <category term="聚类" scheme="https://666wxy666.github.io/tags/%E8%81%9A%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>机器学习 知识拓展 条件熵</title>
    <link href="https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E7%9F%A5%E8%AF%86%E6%8B%93%E5%B1%95-%E6%9D%A1%E4%BB%B6%E7%86%B5/"/>
    <id>https://666wxy666.github.io/2020/05/24/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E7%9F%A5%E8%AF%86%E6%8B%93%E5%B1%95-%E6%9D%A1%E4%BB%B6%E7%86%B5/</id>
    <published>2020-05-24T06:23:52.012Z</published>
    <updated>2020-05-24T06:30:25.545Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于条件熵的知识拓展。</p><a id="more"></a><h2 id="一、问题："><a href="#一、问题：" class="headerlink" title="一、问题："></a>一、问题：</h2><p>假定数据库有𝑁个人，第𝑛个人的先验概率$\gamma_n$，有𝐾个问题，假定第𝑛个人对第𝑘个问题答案为“是”的概率为$a_{nk}$，请给出给定第𝑘个问题条件下，数据集的条件熵的计算公式。</p><h2 id="二、解析"><a href="#二、解析" class="headerlink" title="二、解析"></a>二、解析</h2><p>原来的条件熵公式为：<br>$$<br>H(Y|X)=\sum_{x}{P(x)H(Y|X=x)}<br>$$<br>因为此题中X的取值只有两个即‘是’和‘否’，因此公式变为：<br>$$<br>H(Y|X)=P(X=是)H(Y|X=是)+P(X=否)H(Y|X=否)<br>$$<br>因此先计算对于第k个问题，X=‘是’的样本占总样本的概率P(X=是)和X=‘否’的样本占总样本的概率P(X=否)。</p><p>分子为对于第k个问题回答为‘是’的个数即：<br>$$<br>\sum^{N}<em>{i=1}{(N\times\gamma_i\times a</em>{ik})}<br>$$<br>分母为总数N，因此P(X=是)：<br>$$<br>P(X=是)=\frac{\sum^{N}<em>{i=1}{(N\times\gamma_i\times a</em>{ik}})}{N}=\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}<br>$$<br>同理，P(X=否)：<br>$$<br>P(X=否)=\frac{\sum^{N}<em>{i=1}{[N\times\gamma_i\times (1-a</em>{ik})}]}{N}=\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{ik})]}<br>$$<br>然后在计算对于第k个问题，X=‘是’的数据集上Y的信息熵和X=‘否’的数据集上Y的信息熵，也就是：<br>$$<br>H(Y|X=是)=-\sum^{N}_{j=1}{(p(x_j)\log p(x_j))}<br>$$</p><p>$$<br>H(Y|X=否)=-\sum^{N}_{j=1}{(q(x_j)\log q(x_j))}<br>$$</p><p>因此要先计算对于第k个问题，X=‘是’的时候，对应每个人‘j’的概率$p(x_j)$。</p><p>分子为对于第k个问题，X=‘是’的时候，‘j’这个人的个数：<br>$$<br>N\times\gamma_j\times{a_{jk}}<br>$$<br>分母为对于第k个问题所有X=‘是’的个数，也就是上述的P(X=是)的分子：<br>$$<br>\sum^{N}<em>{i=1}{(N\times\gamma_i\times a</em>{ik})}<br>$$<br>或者写为：<br>$$<br>P(X=是)\times{N}<br>$$<br>因此$p(x_j)$：<br>$$<br>p(x_j)=\frac{N\times\gamma_j\times{a_{jk}}}{\sum^{N}<em>{i=1}{(N\times\gamma_i\times a</em>{ik}})}=\frac{\gamma_j\times{a_{jk}}}{\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}}<br>$$<br>同理X=‘否’的时候，对应每个人‘j’的概率$q(x_j)$:<br>$$<br>q(x_j)=\frac{N\times\gamma_j\times{(1-a_{jk})}}{\sum^{N}<em>{i=1}{[N\times\gamma_i\times (1-a</em>{jk})}]}=\frac{\gamma_j\times{(1-a_{jk})}}{\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{jk})]}}<br>$$<br>综上所述，可以得出条件熵的最终公式为：<br>$$<br>\begin{align}<br>H(Y|X)=&amp;P(X=是)H(Y|X=是)+P(X=否)H(Y|X=否)\<br>=&amp;\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}\times[-\sum^{N}<em>{j=1}{(p(x_j)\log p(x_j))}]\<br>&amp;+\sum^{N}</em>{i=1}{[\gamma_i\times (1-a_{ik})]}\times[-\sum^{N}<em>{j=1}{(q(x_j)\log q(x_j))}]\<br>=&amp;\sum^{N}</em>{i=1}{(\gamma_i\times a_{ik})}\times[-\sum^{N}<em>{j=1}{\left(\frac{\gamma_j\times{a</em>{jk}}}{\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}}\log \frac{\gamma_j\times{a_{jk}}}{\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}}\right)}]\<br>&amp;+\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{ik})]}\<br>&amp;\times[-\sum^{N}<em>{j=1}{\left(\frac{\gamma_j\times{(1-a</em>{jk})}}{\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{jk})]}}\log \frac{\gamma_j\times{(1-a_{jk})}}{\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{jk})]}}\right)}]\<br>=&amp;-\sum^{N}<em>{j=1}{\left(\gamma_j\times{a</em>{jk}}\times\log \frac{\gamma_j\times{a_{jk}}}{\sum^{N}<em>{i=1}{(\gamma_i\times a</em>{ik})}}\right)}\<br>&amp;-\sum^{N}<em>{j=1}{\left(\gamma_j\times{(1-a</em>{jk})}\times\log \frac{\gamma_j\times{(1-a_{jk})}}{\sum^{N}<em>{i=1}{[\gamma_i\times (1-a</em>{ik})]}}\right)}<br>\end{align}<br>$$</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于条件熵的知识拓展。&lt;/p&gt;
    
    </summary>
    
    
      <category term="机器学习" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="知识拓展" scheme="https://666wxy666.github.io/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E7%9F%A5%E8%AF%86%E6%8B%93%E5%B1%95/"/>
    
    
      <category term="拓展" scheme="https://666wxy666.github.io/tags/%E6%8B%93%E5%B1%95/"/>
    
      <category term="机器学习" scheme="https://666wxy666.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="知识" scheme="https://666wxy666.github.io/tags/%E7%9F%A5%E8%AF%86/"/>
    
      <category term="条件熵" scheme="https://666wxy666.github.io/tags/%E6%9D%A1%E4%BB%B6%E7%86%B5/"/>
    
  </entry>
  
  <entry>
    <title>Linux 上机实战4 SimpleShell</title>
    <link href="https://666wxy666.github.io/2020/05/21/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%984-SimpleShell/"/>
    <id>https://666wxy666.github.io/2020/05/21/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%984-SimpleShell/</id>
    <published>2020-05-21T14:15:28.772Z</published>
    <updated>2020-05-29T02:15:01.712Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>本文是关于Linux中的一个简单的shell，支持运行多个命令以[;]分割，支持管道和重定向，支持CTRL-C终止内部命令而不终止simple shell本身，有完善的错误处理及醒目的颜色提示。</strong></p><a id="more"></a><h2 id="一、实验环境"><a href="#一、实验环境" class="headerlink" title="一、实验环境"></a>一、实验环境</h2><p>硬件：</p><ul><li>Intel i7 7700HQ，内存16GB；</li></ul><p>软件：</p><ul><li><p>基于Arch Linux的Manjaro</p></li><li><p>Linux内核：Linux 5.4.39-1-MANJARO x86_64</p></li><li><p>C语言</p></li></ul><h2 id="二、基本步骤"><a href="#二、基本步骤" class="headerlink" title="二、基本步骤"></a>二、基本步骤</h2><ol><li><p>编写代码grep+wc.c（代码源码见附件grep+wc.c或本文最后的附录）：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_212437.png" alt="Screenshot_20200521_212437" style="zoom:80%"></li></ol><ol start="2"><li><p>编译</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_211357.png" alt="Screenshot_20200521_211357" style="zoom:80%"></li><li><p>在grep+wc.c的基础上进行拓展，编写代码simple_shell.c（代码源码见附件simple_shell.c或本文最后的附录）：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_21306.png" alt="Screenshot_20200521_21306" style="zoom:80%"><p>在编写时遇到了一个棘手的问题，就是关于“子进程对父进程信号的继承情况”。总结一下就是：</p><ul><li><p>仅fork时子进程会继承父进程fork之前所设置的信号处理方式。</p></li><li><p>当有exec加载新程序时</p><ul><li>子进程继承的处理方式是忽略或默认处理方式时，exec新程序后设置依然有效。</li><li>如果子进程继承是捕获处理方式时，exec新程序后将被还原为默认处理方式。</li></ul></li></ul><p>详细请查看这位大佬的文章<a href="https://blog.csdn.net/qq_43648751/article/details/104623880" target="_blank" rel="external nofollow noopener noreferrer">子进程对父进程信号的继承情况详细分析（信号）【linux】（zs）</a>。</p></li><li><p>编译</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_210259.png" alt="Screenshot_20200521_210259" style="zoom:80%"></li></ol><h2 id="三、测试样例"><a href="#三、测试样例" class="headerlink" title="三、测试样例"></a>三、测试样例</h2><h3 id="0、在Shell（zsh）里运行所给命令"><a href="#0、在Shell（zsh）里运行所给命令" class="headerlink" title="0、在Shell（zsh）里运行所给命令"></a>0、在Shell（zsh）里运行所给命令</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214711.png" alt="Screenshot_20200521_214711" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214739.png" alt="Screenshot_20200521_214739" style="zoom:80%"><h3 id="1、grep-wc"><a href="#1、grep-wc" class="headerlink" title="1、grep+wc"></a>1、grep+wc</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_213548.png" alt="Screenshot_20200521_213548" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_213619.png" alt="Screenshot_20200521_213619" style="zoom:80%"><h3 id="2、simple-shell"><a href="#2、simple-shell" class="headerlink" title="2、simple_shell"></a>2、simple_shell</h3><h4 id="1-特殊命令"><a href="#1-特殊命令" class="headerlink" title="1.特殊命令"></a>1.特殊命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_213811.png" alt="Screenshot_20200521_213811" style="zoom:80%"><h4 id="2-普通命令"><a href="#2-普通命令" class="headerlink" title="2.普通命令"></a>2.普通命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214038.png" alt="Screenshot_20200521_214038" style="zoom:80%"><h4 id="3-重定向命令"><a href="#3-重定向命令" class="headerlink" title="3.重定向命令"></a>3.重定向命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214206.png" alt="Screenshot_20200521_214206" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214238.png" alt="Screenshot_20200521_214238" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214321.png" alt="Screenshot_20200521_214321" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214356.png" alt="Screenshot_20200521_214356" style="zoom:80%"><h4 id="4-管道命令"><a href="#4-管道命令" class="headerlink" title="4.管道命令"></a>4.管道命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214436.png" alt="Screenshot_20200521_214436" style="zoom:80%"><h4 id="5-综合命令"><a href="#5-综合命令" class="headerlink" title="5.综合命令"></a>5.综合命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214527.png" alt="Screenshot_20200521_214527" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_214606.png" alt="Screenshot_20200521_214606" style="zoom:80%"><h4 id="6-错误命令"><a href="#6-错误命令" class="headerlink" title="6.错误命令"></a>6.错误命令</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_215944.png" alt="Screenshot_20200521_215944" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_220012.png" alt="Screenshot_20200521_220012" style="zoom:80%"><h4 id="7-CTRL-C"><a href="#7-CTRL-C" class="headerlink" title="7.CTRL-C"></a>7.CTRL-C</h4><p>输入<code>find / -name hello</code>，在运行期间输入<code>CTRL-C</code>杀死正在运行的find程序。可以发现find命令停止，但是Simple Shell并没有退出（输入exit可以正常退出）。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/Screenshot_20200521_220213.png" alt="Screenshot_20200521_220213" style="zoom:80%"><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><p><strong><em>PS:程序源码均有详细的注释</em></strong></p><h3 id="1、grep-wc-c"><a href="#1、grep-wc-c" class="headerlink" title="1、grep+wc.c"></a>1、grep+wc.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: grep -v usr &lt; /etc/passwd | wc –l &gt; r.txt; cat r.txt</span></span><br><span class="line"><span class="comment"> * @Version: 1.0</span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-05-21 09:44:26</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-05-21 21:23:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sv;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    pipe(fd);</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 输入重定向</span></span><br><span class="line">        <span class="keyword">int</span> fd0 = <span class="number">-1</span>;</span><br><span class="line">        fd0 = <span class="built_in">open</span>(<span class="string">"/etc/passwd"</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd0 != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            dup2(fd0, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">close</span>(fd0);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 管道输入端</span></span><br><span class="line">        dup2(fd[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">// 执行管道前的命令</span></span><br><span class="line">        execlp(<span class="string">"grep"</span>, <span class="string">"grep"</span>, <span class="string">"-v"</span>, <span class="string">"usr"</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 输出重定向</span></span><br><span class="line">            <span class="keyword">int</span> fd1 = <span class="number">-1</span>;</span><br><span class="line">            fd1 = <span class="built_in">open</span>(<span class="string">"r.txt"</span>, O_CREAT | O_WRONLY | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">            <span class="keyword">if</span> (fd1 != <span class="number">-1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dup2(fd1, <span class="number">1</span>);</span><br><span class="line">                <span class="built_in">close</span>(fd1);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 管道输出端</span></span><br><span class="line">            dup2(fd[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 执行管道后的命令</span></span><br><span class="line">            execlp(<span class="string">"wc"</span>, <span class="string">"wc"</span>, <span class="string">"-l"</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">    wait(&amp;sv);</span><br><span class="line">    wait(&amp;sv);</span><br><span class="line">    <span class="comment">// 执行第二个命令</span></span><br><span class="line">    execlp(<span class="string">"cat"</span>, <span class="string">"cat"</span>, <span class="string">"r.txt"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、simple-shell-c"><a href="#2、simple-shell-c" class="headerlink" title="2、simple_shell.c"></a>2、simple_shell.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: Simple Shell</span></span><br><span class="line"><span class="comment"> * @Version: 1.0</span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-05-21 09:44:26</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-05-21 21:56:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 颜色</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NONE <span class="meta-string">"\e[0m"</span>   <span class="comment">// 复原</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED <span class="meta-string">"\e[0;31m"</span> <span class="comment">// ERROR</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> version[] = <span class="string">"1.0"</span>; <span class="comment">// 版本号</span></span><br><span class="line"><span class="keyword">int</span> pipe_flag = <span class="number">0</span>;      <span class="comment">// 是否使用管道</span></span><br><span class="line"><span class="keyword">static</span> jmp_buf env;</span><br><span class="line"><span class="keyword">int</span> sv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CTRL-C回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        wait(&amp;sv);</span><br><span class="line">        wait(&amp;sv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(&amp;sv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    siglongjmp(env, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印帮助</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"**********************************************************\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%27sHELP%27s\n**********************************************************\n"</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Simple Shell %s by 苇名一心 May 21 2020\n"</span>, version);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: [COMMAND] [OPTION]... (&lt; [INFILE]) (| [COMMAND] [OPTION]... (&gt; [OUTFILE])) (;...;...)\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Simple shell with redirect and pipe(Can also run multiple commands)\nSpecial commands:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\thelp\tDisplay this help and continue\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\texit\tExit simple shell\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"**********************************************************\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">256</span>], *argv1[<span class="number">256</span>], **p, *argv2[<span class="number">256</span>], *buf, *<span class="built_in">end</span>, *cmd2, *in, *out;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// CTRL-C信号自行处理</span></span><br><span class="line">    signal(SIGINT, sig_handler);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        sigsetjmp(env, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 打印提示符</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"=&gt; "</span>);</span><br><span class="line">        <span class="comment">// 获取命令</span></span><br><span class="line">        <span class="keyword">if</span> (fgets(<span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>), <span class="built_in">stdin</span>) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//没有输入任何命令</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">buffer</span>) == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 命令最后加;用于判断</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">buffer</span>[<span class="built_in">strlen</span>(<span class="built_in">buffer</span>) - <span class="number">2</span>] != <span class="string">';'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">buffer</span>[<span class="built_in">strlen</span>(<span class="built_in">buffer</span>) - <span class="number">1</span>] = <span class="string">';'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取每一条;分割的命令，依次执行</span></span><br><span class="line">        <span class="keyword">for</span> (buf = <span class="built_in">buffer</span>; <span class="built_in">end</span> = <span class="built_in">strstr</span>(buf, <span class="string">";"</span>); buf = <span class="built_in">end</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *<span class="built_in">end</span>++ = <span class="string">'\0'</span>;</span><br><span class="line">            pipe_flag = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 获取管道命令，输入重定向文件和输出重定向文件</span></span><br><span class="line">            <span class="comment">// note:必须先获取管道命令，in和out在进行分词操作，因为分词会修改buf，导致获取管道命令，in和out出错</span></span><br><span class="line">            cmd2 = <span class="built_in">strstr</span>(buf, <span class="string">"|"</span>);</span><br><span class="line">            in = <span class="built_in">strstr</span>(buf, <span class="string">"&lt;"</span>);</span><br><span class="line">            out = <span class="built_in">strstr</span>(buf, <span class="string">"&gt;"</span>);</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *in++ = <span class="string">'\0'</span>;</span><br><span class="line">                in = strtok(in, <span class="string">" \t\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                *out++ = <span class="string">'\0'</span>;</span><br><span class="line">                out = strtok(out, <span class="string">" \t\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cmd2 != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                pipe_flag = <span class="number">1</span>;</span><br><span class="line">                *cmd2++ = <span class="string">'\0'</span>;</span><br><span class="line">                <span class="keyword">for</span> (p = &amp;argv2[<span class="number">0</span>], *p = strtok(cmd2, <span class="string">" \t\n"</span>); *p != <span class="literal">NULL</span>; *++p = strtok(<span class="literal">NULL</span>, <span class="string">" \t\n"</span>))</span><br><span class="line">                    ;</span><br><span class="line">                <span class="keyword">if</span> (argv2[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** No command 2 input!\n"</span> NONE);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (p = &amp;argv1[<span class="number">0</span>], *p = strtok(buf, <span class="string">" \t\n"</span>); *p != <span class="literal">NULL</span>; *++p = strtok(<span class="literal">NULL</span>, <span class="string">" \t\n"</span>))</span><br><span class="line">                ;</span><br><span class="line">            <span class="comment">// 没有命令输入</span></span><br><span class="line">            <span class="keyword">if</span> (argv1[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** No command 1 input!\n"</span> NONE);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 输入了exit</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv1[<span class="number">0</span>], <span class="string">"exit"</span>) == <span class="number">0</span>)</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 输入了help</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv1[<span class="number">0</span>], <span class="string">"help"</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                help();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 使用了管道</span></span><br><span class="line">            <span class="keyword">if</span> (pipe_flag)</span><br><span class="line">            &#123;</span><br><span class="line">                pipe(fd);</span><br><span class="line">                <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 输入重定向</span></span><br><span class="line">                    <span class="keyword">int</span> fd0 = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (in != <span class="literal">NULL</span>)</span><br><span class="line">                        fd0 = <span class="built_in">open</span>(in, O_RDONLY);</span><br><span class="line">                    <span class="keyword">if</span> (fd0 != <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        dup2(fd0, <span class="number">0</span>);</span><br><span class="line">                        <span class="built_in">close</span>(fd0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (in != <span class="literal">NULL</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** No such file or directory: %s\n"</span> NONE, in);</span><br><span class="line">                        help();</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 管道输入端</span></span><br><span class="line">                    dup2(fd[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">                    <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">                    <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">                    <span class="comment">// 执行管道前的命令</span></span><br><span class="line">                    execvp(argv1[<span class="number">0</span>], argv1);</span><br><span class="line">                    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** Bad command 1: %m\n"</span> NONE);</span><br><span class="line">                    help();</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 输出重定向</span></span><br><span class="line">                        <span class="keyword">int</span> fd1 = <span class="number">-1</span>;</span><br><span class="line">                        <span class="keyword">if</span> (out != <span class="literal">NULL</span>)</span><br><span class="line">                            fd1 = <span class="built_in">open</span>(out, O_CREAT | O_WRONLY | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">                        <span class="keyword">if</span> (fd1 != <span class="number">-1</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            dup2(fd1, <span class="number">1</span>);</span><br><span class="line">                            <span class="built_in">close</span>(fd1);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 管道输出端</span></span><br><span class="line">                        dup2(fd[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">                        <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">                        <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">                        <span class="comment">// 执行管道后的命令</span></span><br><span class="line">                        execvp(argv2[<span class="number">0</span>], argv2);</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** Bad command 2: %m\n"</span> NONE);</span><br><span class="line">                        help();</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">                wait(&amp;sv);</span><br><span class="line">                wait(&amp;sv);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 没有使用管道</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> fd0 = <span class="number">-1</span>, fd1 = <span class="number">-1</span>;</span><br><span class="line">                    <span class="comment">// 输入重定向</span></span><br><span class="line">                    <span class="keyword">if</span> (in != <span class="literal">NULL</span>)</span><br><span class="line">                        fd0 = <span class="built_in">open</span>(in, O_RDONLY);</span><br><span class="line">                    <span class="keyword">if</span> (fd0 != <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        dup2(fd0, <span class="number">0</span>);</span><br><span class="line">                        <span class="built_in">close</span>(fd0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (in != <span class="literal">NULL</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** No such file or directory: %s\n"</span> NONE, in);</span><br><span class="line">                        help();</span><br><span class="line">                        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 输出重定向</span></span><br><span class="line">                    <span class="keyword">if</span> (out != <span class="literal">NULL</span>)</span><br><span class="line">                        fd1 = <span class="built_in">open</span>(out, O_CREAT | O_WRONLY | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">                    <span class="keyword">if</span> (fd1 != <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        dup2(fd1, <span class="number">1</span>);</span><br><span class="line">                        <span class="built_in">close</span>(fd1);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 执行命令</span></span><br><span class="line">                    execvp(argv1[<span class="number">0</span>], argv1);</span><br><span class="line">                    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, RED <span class="string">"** Bad command 1: %m\n"</span> NONE);</span><br><span class="line">                    help();</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                wait(&amp;sv);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;本文是关于Linux中的一个简单的shell，支持运行多个命令以[;]分割，支持管道和重定向，支持CTRL-C终止内部命令而不终止simple shell本身，有完善的错误处理及醒目的颜色提示。&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/categories/Linux/"/>
    
      <category term="上机实战" scheme="https://666wxy666.github.io/categories/Linux/%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/tags/Linux/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="shell脚本程序" scheme="https://666wxy666.github.io/tags/shell%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>计算机系统结构 实验 指令调度与延迟分支</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E6%8C%87%E4%BB%A4%E8%B0%83%E5%BA%A6%E4%B8%8E%E5%BB%B6%E8%BF%9F%E5%88%86%E6%94%AF/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E6%8C%87%E4%BB%A4%E8%B0%83%E5%BA%A6%E4%B8%8E%E5%BB%B6%E8%BF%9F%E5%88%86%E6%94%AF/</id>
    <published>2020-05-18T12:51:47.994Z</published>
    <updated>2020-05-18T13:02:19.553Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于计算机系统结构实验五，指令调度与延迟分支。</p><a id="more"></a><h2 id="一、实验目的"><a href="#一、实验目的" class="headerlink" title="一、实验目的"></a>一、实验目的</h2><ol><li>加深对指令调度技术的理解。</li><li>加深对延迟分支技术的理解。</li><li>熟练掌握用指令调度技术解决流水线中的数据冲突的方法。</li><li>进一步理解指令调度技术对 CPU 性能的改进。</li><li>进一步理解延迟分支技术对 CPU 性能的改进。</li></ol><h2 id="二、实验步骤及结果分析"><a href="#二、实验步骤及结果分析" class="headerlink" title="二、实验步骤及结果分析"></a>二、实验步骤及结果分析</h2><h3 id="1、启动-MIPSsim。"><a href="#1、启动-MIPSsim。" class="headerlink" title="1、启动 MIPSsim。"></a>1、启动 MIPSsim。</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175654.jpg" alt="2020-05-07_175631" style="zoom:50%"><h3 id="2、根据实验2的相关知识中关于流水线各段操作的描述，进一步理解流水线窗口中各段的功能，掌握各流水线寄存器的含义（双击各段，就可以看到各流水线寄存器中的内容）。"><a href="#2、根据实验2的相关知识中关于流水线各段操作的描述，进一步理解流水线窗口中各段的功能，掌握各流水线寄存器的含义（双击各段，就可以看到各流水线寄存器中的内容）。" class="headerlink" title="2、根据实验2的相关知识中关于流水线各段操作的描述，进一步理解流水线窗口中各段的功能，掌握各流水线寄存器的含义（双击各段，就可以看到各流水线寄存器中的内容）。"></a>2、根据实验2的相关知识中关于流水线各段操作的描述，进一步理解流水线窗口中各段的功能，掌握各流水线寄存器的含义（双击各段，就可以看到各流水线寄存器中的内容）。</h3><h4 id="①IF段："><a href="#①IF段：" class="headerlink" title="①IF段："></a>①IF段：</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517210511.jpg" alt="2020-05-17_210337" style="zoom:80%"><h4 id="②ID段："><a href="#②ID段：" class="headerlink" title="②ID段："></a>②ID段：</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517210543.jpg" alt="2020-05-17_210358" style="zoom:80%"><h4 id="③EX段："><a href="#③EX段：" class="headerlink" title="③EX段："></a>③EX段：</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517210648.jpg" alt="2020-05-17_210409" style="zoom:80%"><h4 id="④MEM段："><a href="#④MEM段：" class="headerlink" title="④MEM段："></a>④MEM段：</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517210657.jpg" alt="2020-05-17_210417" style="zoom:80%"><h4 id="⑤WB段："><a href="#⑤WB段：" class="headerlink" title="⑤WB段："></a>⑤WB段：</h4><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517210729.jpg" alt="2020-05-17_210423" style="zoom:80%"><h3 id="3、选择“配置”→“流水方式”选项，使模拟器工作在流水方式下。"><a href="#3、选择“配置”→“流水方式”选项，使模拟器工作在流水方式下。" class="headerlink" title="3、选择“配置”→“流水方式”选项，使模拟器工作在流水方式下。"></a>3、选择“配置”→“流水方式”选项，使模拟器工作在流水方式下。</h3><h3 id="4、用指令调度技术解决流水线中的结构冲突与数据冲突："><a href="#4、用指令调度技术解决流水线中的结构冲突与数据冲突：" class="headerlink" title="4、用指令调度技术解决流水线中的结构冲突与数据冲突："></a>4、用指令调度技术解决流水线中的结构冲突与数据冲突：</h3><ol><li><p>启动 MIPSsim。用 MIPSsim 的“文件”-&gt;“载入程序”选项来加载 schedule.s（在模拟器所在文件夹下的“样例程序”文件夹中）。关闭定向功能，这是通过“配置“-&gt;”定向“选项来实现的。执行所载入的程序，通过查看统计数据和时钟周期图，找出并记录程序执行过程中各种冲突发生的次数，发生冲突的指令组合以及程序执行的总时钟周期数。</p><p>载入的程序：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517211348.jpg" alt="2020-05-17_211340" style="zoom:80%"><p>执行结果：</p><ul><li><p>寄存器的值</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517211749.jpg" alt="2020-05-17_211604" style="zoom:80%"></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517211814.jpg" alt="2020-05-17_211620" style="zoom:80%"></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517211909.jpg" alt="2020-05-17_211525" style="zoom:80%"><p>发现总共执行了33个周期，执行了15条指令，8次RAW停顿，RAW停顿有16个周期，RAW停顿占周期总数的百分比为48.48485%，所有的停顿为17个周期，占周期总数的百分比为51.51515%。<br>$$<br>吞吐率TP_1=\frac{15}{33\Delta{t}}<br>$$</p><p>$$<br>加速比S_1=\frac{15\times{5\Delta{t}}}{33\Delta{t}}\approx{2.27}<br>$$</p><p>冲突的指令组合：</p><p>1-1和2-1，2-1和2-2，2-2和2-3，3-1和3-2，4-1和4-2，4-2和4-3，4-3和4-4，5-1和5-2共8对冲突，1-5组组内冲突，组间没有关联。</p><p>schedule.s：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU  $r1,$r0,A# 1-1</span><br><span class="line"></span><br><span class="line">LW     $r2,0($r1)# 2-1</span><br><span class="line">ADD    $r4,$r0,$r2# 2-2</span><br><span class="line">SW     $r4,0($r1)# 2-3</span><br><span class="line"></span><br><span class="line">LW     $r6,4($r1)# 3-1</span><br><span class="line">ADD    $r8,$r6,$r1# 3-2</span><br><span class="line"></span><br><span class="line">MUL    $r12,$r10,$r1# 4-1</span><br><span class="line">ADD    $r16,$r12,$r1# 4-2</span><br><span class="line">ADD    $r18,$r16,$r1# 4-3</span><br><span class="line">SW     $r18,16($r1)# 4-4</span><br><span class="line"></span><br><span class="line">LW     $r20,8($r1)# 5-1</span><br><span class="line">MUL    $r22,$r20,$r14# 5-2</span><br><span class="line"></span><br><span class="line">MUL    $r24,$r26,$r14# 6-1</span><br><span class="line"></span><br><span class="line">TEQ    $r0,$r0# 7-1</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">A: </span><br><span class="line">.word 4,6,8</span><br></pre></td></tr></table></figure></li></ul></li></ol><ol start="2"><li><p>自己采用调度技术对程序进行指令调度，消除冲突（自己修改源程序）。将调度（修改）后的程序重新命名为 afer-schedule.s。（注意：调度方法灵活多样，在保证程序正确性的前提下自己随意调度，尽量减少冲突即可，不要求要达到最优。）载入 afer-schedule.s，执行该程序，观察程序在流水线中的执行情况，记录程序执行的总时钟周期数。 比较调度前和调度后的性能，论述指令调度对提高 CPU 性能的作用。</p><p><strong><em>PS：调度后的程序见附录。</em></strong></p><p>载入的程序：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517213848.jpg" alt="2020-05-17_213739" style="zoom:80%"><p>执行结果：</p><ul><li><p>寄存器的值</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517213909.jpg" alt="2020-05-17_213757" style="zoom:80%"><p>与不调度前完全一致，调度没有改变结果，调度正确。</p></li><li><p>时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517214016.jpg" alt="2020-05-17_213828" style="zoom:80%"></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517213944.jpg" alt="2020-05-17_213812" style="zoom:80%"><p>发现总共执行了18个周期，执行了15条指令，1次RAW停顿，RAW停顿有1个周期，RAW停顿占周期总数的百分比为5.555555%，较没有静态调度的48.48485%少了很多，所有的停顿为2个周期，占周期总数的百分比为11.111111%，较没有静态调度的51.51515%也少了很多。<br>$$<br>吞吐率TP_2=\frac{15}{18\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{15\times{5\Delta{t}}}{18\Delta{t}}\approx{4.17}<br>$$</p><p>吞吐率和加速比是没有静态调度时的$\frac{33}{18}\approx{1.83}$倍。</p></li></ul></li></ol><h3 id="5、用延迟分支技术减少分支指令对性能的影响："><a href="#5、用延迟分支技术减少分支指令对性能的影响：" class="headerlink" title="5、用延迟分支技术减少分支指令对性能的影响："></a>5、用延迟分支技术减少分支指令对性能的影响：</h3><ol><li><p>在 MIPSsim 中载入 branch.s 样例程序（在本模拟器目录的“样例程序”文件夹中。关闭延迟分支功能。这是通过在“配置”-&gt;“延迟槽”选项来实现的。执行该程序，观察并记录发生分支延迟的时刻，记录该程序执行的总时钟周期数。</p><ol><li><p>载入的程序：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517220107.jpg" alt="2020-05-17_215518" style="zoom:80%"><p>执行结果：</p><ul><li><p>寄存器的值</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517220117.jpg" alt="2020-05-17_215540" style="zoom:80%"></li><li><p>部分时钟周期图</p><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517220131.jpg" alt="2020-05-17_215609"></p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517220148.jpg" alt="2020-05-17_215554" style="zoom:80%"><p>发现总共执行了38个周期，执行了18条指令，8次RAW停顿，RAW停顿有16个周期，RAW停顿占周期总数的百分比为42.10526%，控制停顿有2个周期，占周期总数的百分比为5.263158%，所有的停顿为19个周期，占周期总数的百分比为50%。发生分支延迟的时刻为第15个周期，延迟了2个周期。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517220910.png" alt="img" style="zoom:80%"> $$ 吞吐率TP_1=\frac{18}{38\Delta{t}} $$<p>$$<br>加速比S_1=\frac{18\times{5\Delta{t}}}{38\Delta{t}}\approx{2.37}<br>$$</p><p>冲突的指令组合：</p><p>2-1和2-2，2-2和2-3，3-1和3-2，3-2和3-3共4对冲突，2组和3组组内冲突，组间没有关联。</p><p>branch.s：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDI  $r2,$r0,1024# 1-1</span><br><span class="line">ADD   $r3,$r0,$r0# 1-2</span><br><span class="line">ADDI  $r4,$r0,8# 1-3</span><br><span class="line"></span><br><span class="line">loop:  </span><br><span class="line">LW    $r1,0($r2)# 2-1</span><br><span class="line">ADDI  $r1,$r1,1# 2-2</span><br><span class="line">SW    $r1,0($r2)# 2-3</span><br><span class="line"></span><br><span class="line">ADDI  $r3,$r3,4# 3-1</span><br><span class="line">SUB   $r5,$r4,$r3# 3-2</span><br><span class="line">BGTZ  $r5,loop# 3-3</span><br><span class="line"></span><br><span class="line">ADD   $r7,$r0,$r6# 4-1</span><br><span class="line"></span><br><span class="line">TEQ   $r0,$r0# 5-1</span><br></pre></td></tr></table></figure></li></ul></li></ol></li></ol><ol start="2"><li><p>假设延迟槽为一个，自己对 branch.s 程序进行指令调度（自己修改源程序），将调度后的程序重新命名为 delayed-branch.s。 载入 delayed-branch.s，打开延迟分支功能，执行该程序，观察其时钟周期图，记录程序执行的总时钟周期数。</p><ol start="2"><li><p><strong><em>PS：调度后的程序见附录。</em></strong></p><p>载入的程序：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517221827.jpg" alt="2020-05-17_221307" style="zoom:80%"><p>执行结果：</p><ul><li><p>寄存器的值</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517221840.jpg" alt="2020-05-17_221458" style="zoom:80%"><p>与不调度前完全一致，调度没有改变结果，调度正确。</p></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517221906.jpg" alt="2020-05-17_221439" style="zoom:80%"></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200517221920.jpg" alt="2020-05-17_221507" style="zoom:80%"><p>发现总共执行了25个周期，执行了19条指令，4次RAW停顿，RAW停顿有4个周期，RAW停顿占周期总数的百分比为16%，较没有静态调度的42.10526%少了很多，控制停顿有0个周期，占周期总数的百分比为0%，比没有使用延迟分支技术的5.263158%少了，所有的停顿为5个周期，占周期总数的百分比为20%，较没有静态调度和延迟分支技术的50%也减少了。可以发现使用延迟分支技术后，控制停顿消失了。<br>$$<br>吞吐率TP_2=\frac{19}{25\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{19\times{5\Delta{t}}}{25\Delta{t}}={3.8}<br>$$</p><p>吞吐率和加速比是没有静态调度和延迟分支技术时的$\frac{19\times{38}}{25\times{18}}\approx{1.60}$倍。</p></li></ul></li></ol></li></ol><h2 id="四、实验结论"><a href="#四、实验结论" class="headerlink" title="四、实验结论"></a>四、实验结论</h2><p>​ 静态调度优化代码和定向技术都能在一定程度上减少甚至消除数据冲突，尤其是RAW停顿，可以很好地提高性能，但是这两种方法对分支控制停顿没有任何帮助。但是延迟分支技术是由编译器通过重排指令序列，在分支指令后紧跟一条或几条延迟槽指令，不管分支是否成功，都顺序执行延迟槽中的指令，从而逻辑上“延长”分支指令的执行时间，减少甚至消除了控制停顿。因此这几种方法都能大幅度的减少停顿，从而提高CPU性能。</p><p>​ 在查看延迟分支技术的统计信息时，发现使用延迟分支技术比不使用延迟分支技术多执行了一条指令，可能是由于分支取消机制当分支的实际执行方向和事先所预测的一样时，执行分支延迟槽中的指令，否则就将分支延迟槽中的指令转化成一个空操作，这条指令确实已经执行了，只是分支条件判断完后发现不该执行，然后就将执行的回滚，因此比不使用延迟分支技术多执行了一条指令。</p><h2 id="五、附录"><a href="#五、附录" class="headerlink" title="五、附录"></a>五、附录</h2><h3 id="1、after-schedule-s"><a href="#1、after-schedule-s" class="headerlink" title="1、after-schedule.s"></a>1、after-schedule.s</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU  $r1,$r0,A# 1-1</span><br><span class="line">MUL    $r24,$r26,$r14# 6-1</span><br><span class="line"></span><br><span class="line">MUL    $r12,$r10,$r1# 4-1</span><br><span class="line">LW     $r2,0($r1)# 2-1</span><br><span class="line">LW     $r6,4($r1)# 3-1</span><br><span class="line"></span><br><span class="line">ADD    $r16,$r12,$r1# 4-2</span><br><span class="line">ADD    $r4,$r0,$r2# 2-2</span><br><span class="line">LW     $r20,8($r1)# 5-1</span><br><span class="line"></span><br><span class="line">ADD    $r18,$r16,$r1# 4-3</span><br><span class="line">SW     $r4,0($r1)# 2-3</span><br><span class="line">MUL    $r22,$r20,$r14# 5-2</span><br><span class="line"></span><br><span class="line">SW     $r18,16($r1)# 4-4</span><br><span class="line">ADD    $r8,$r6,$r1# 3-2</span><br><span class="line">TEQ    $r0,$r0# 7-1</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">A: </span><br><span class="line">.word 4,6,8</span><br></pre></td></tr></table></figure><h3 id="2、delay-branch-s"><a href="#2、delay-branch-s" class="headerlink" title="2、delay-branch.s"></a>2、delay-branch.s</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDI  $r2,$r0,1024# 1-1</span><br><span class="line">ADD   $r3,$r0,$r0# 1-2</span><br><span class="line">ADDI  $r4,$r0,8# 1-3</span><br><span class="line"></span><br><span class="line">loop:  </span><br><span class="line">LW    $r1,0($r2)# 2-1</span><br><span class="line">ADDI  $r3,$r3,4# 3-1</span><br><span class="line">ADDI  $r1,$r1,1# 2-2</span><br><span class="line">SUB   $r5,$r4,$r3# 3-2</span><br><span class="line">SW    $r1,0($r2)# 2-3</span><br><span class="line">BGTZ  $r5,loop# 3-3</span><br><span class="line"></span><br><span class="line">ADD   $r7,$r0,$r6# 4-1</span><br><span class="line"></span><br><span class="line">TEQ   $r0,$r0# 5-1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于计算机系统结构实验五，指令调度与延迟分支。&lt;/p&gt;
    
    </summary>
    
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="汇编" scheme="https://666wxy666.github.io/tags/%E6%B1%87%E7%BC%96/"/>
    
      <category term="MIPS" scheme="https://666wxy666.github.io/tags/MIPS/"/>
    
  </entry>
  
  <entry>
    <title>计算机系统结构 实验 使用MIPS指令实现冒泡排序法</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E4%BD%BF%E7%94%A8MIPS%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E6%B3%95/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E4%BD%BF%E7%94%A8MIPS%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E6%B3%95/</id>
    <published>2020-05-18T12:51:32.120Z</published>
    <updated>2020-05-18T12:59:55.210Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于计算机系统结构实验四，使用MIPS指令实现冒泡排序法。</p><a id="more"></a><h2 id="一、实验目的"><a href="#一、实验目的" class="headerlink" title="一、实验目的"></a>一、实验目的</h2><ol><li>掌握静态调度方法</li><li>增强汇编语言编程能力</li><li>学会使用模拟器中的定向功能进行优化</li></ol><h2 id="二、实验原理"><a href="#二、实验原理" class="headerlink" title="二、实验原理"></a>二、实验原理</h2><p>​ 通过编写MIPS汇编程序，实现冒泡排序的功能。在模拟器MIPSsim上执行所写的汇编程序，查看结果，判断所写的汇编程序是否正确。然后观察时钟周期图窗口的执行过程和冲突的指令，查看统计窗口的信息，来判断定向前后和优化前后的执行效率高低。</p><h2 id="三、实验步骤及结果分析"><a href="#三、实验步骤及结果分析" class="headerlink" title="三、实验步骤及结果分析"></a>三、实验步骤及结果分析</h2><h3 id="1、自行编写一个实现冒泡排序的汇编程序，该程序要求可以实现对一维整数数组进行冒泡排序。"><a href="#1、自行编写一个实现冒泡排序的汇编程序，该程序要求可以实现对一维整数数组进行冒泡排序。" class="headerlink" title="1、自行编写一个实现冒泡排序的汇编程序，该程序要求可以实现对一维整数数组进行冒泡排序。"></a>1、自行编写一个实现冒泡排序的汇编程序，该程序要求可以实现对一维整数数组进行冒泡排序。</h3><p>冒泡排序算法的运作如下：</p><ol><li>比较相邻的元素。如果第一个比第二个大，就交换他们两个。</li><li>对每一对相邻元素作同样的工作，从开始第一对到结尾的最后一对。在这一点， 最后的元素应该会是最大的数。</li><li>针对所有的元素重复以上的步骤，除了最后一个。</li><li>持续每次对越来越少的元素重复上面的步骤，直到没有任何一对数字需要比较。</li></ol><p>要求数组长度不得小于10</p><p><strong><em>PS：汇编程序见附录。</em></strong></p><h3 id="2、启动-MIPSsim。"><a href="#2、启动-MIPSsim。" class="headerlink" title="2、启动 MIPSsim。"></a>2、启动 MIPSsim。</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175654.jpg" alt="2020-05-07_175631" style="zoom:50%"><h3 id="3、载入自己编写的程序，观察流水线输出结果。"><a href="#3、载入自己编写的程序，观察流水线输出结果。" class="headerlink" title="3、载入自己编写的程序，观察流水线输出结果。"></a>3、载入自己编写的程序，观察流水线输出结果。</h3><p>载入的代码：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514192648.jpg" alt="2020-05-14_192636" style="zoom:80%"><p>执行结果：</p><ul><li><p>内存中的数组</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514192757.jpg" alt="2020-05-14_192747" style="zoom:80%"><p>原数组是{5,4,11,3,7,1,10,6,8,9,2}，排序后是{1,2,3,4,5,6,7,8,9,10,11}，结果符合预期，说明编写的汇编程序正确。</p></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514211749.jpg" alt="2020-05-14_193022" style="zoom:80%"><p>可以看到有非常多的停顿，主要是DSUB命令与BGTZ命令的RAW停顿，还有一些控制停顿。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514211802.jpg" alt="2020-05-14_193232" style="zoom:80%"><p>发现RAW停顿有417个周期，停顿次数非常多，可以进行优化。共执行了1076个周期，RAW停顿占周期总数的百分比为38.75465%，所有的停顿为537个周期，占周期总数的百分比为49.90706%，效率很低。<br>$$<br>吞吐率TP_1=\frac{538}{1076\Delta{t}}<br>$$</p><p>$$<br>加速比S_1=\frac{538\times{5\Delta{t}}}{1076\Delta{t}}={2.5}<br>$$</p></li></ul><h3 id="4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。"><a href="#4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。" class="headerlink" title="4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。"></a>4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。</h3><ul><li><p>内存中的数组</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514193632.jpg" alt="2020-05-14_193627" style="zoom:80%"><p>结果正确。</p></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514211946.jpg" alt="2020-05-14_193708" style="zoom:80%"><p>在使用定向技术后，发现停顿明显减少。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514211954.jpg" alt="2020-05-14_194050" style="zoom:80%"><p>发现RAW停顿有175个周期，停顿周期数比没有定向技术时的417个少了很多；</p><p>共执行了834个周期，比没有定向技术时的1076个也少了很多；</p><p>RAW停顿占周期总数的百分比为20.98321%，较没有定向技术时的38.75465%也减少了很多；</p><p>所有的停顿为295个周期，占周期总数的百分比为35.3717%，较没有定向技术时的49.90706%也减少了很多；</p><p>$$<br>吞吐率TP_2=\frac{538}{834\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{538\times{5\Delta{t}}}{834\Delta{t}}\approx{3.23}<br>$$<br>吞吐率和加速比是没有定向技术时的$\frac{1076}{834}\approx{1.29}$倍。</p></li></ul><h3 id="5、采用静态调度方法重排指令序列，减少相关，优化程序"><a href="#5、采用静态调度方法重排指令序列，减少相关，优化程序" class="headerlink" title="5、采用静态调度方法重排指令序列，减少相关，优化程序"></a>5、采用静态调度方法重排指令序列，减少相关，优化程序</h3><p>因为主要是DSUB命令与BGTZ命令的RAW停顿，分支指令的操作数需要用到前面的结果，因此将后面pass中执行的<code>ADDIU $r4, $r4, 1</code>和<code>DSUB $r8, $r2, $r4</code>拿到loop2中执行，从而减少RAW停顿。</p><p><strong><em>PS：静态调度后的汇编程序见附录。</em></strong></p><ul><li><p>载入代码</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514205322.jpg" alt="2020-05-14_205303" style="zoom:80%"></li><li><p>内存中的数组</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514205458.jpg" alt="2020-05-14_205419" style="zoom:80%"><p>结果正确。</p></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514212233.jpg" alt="2020-05-14_211607" style="zoom:80%"><p>在使用静态调度后，发现停顿少了很多。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514212255.jpg" alt="2020-05-14_211624" style="zoom:80%"><p>发现RAW停顿有142个周期，停顿周期数比没有静态调度时的417个少了很多；</p><p>共执行了801个周期，比没有静态调度时的1076个也少了很多；</p><p>RAW停顿占周期总数的百分比为17.72784%，较没有静态调度时的38.75465%也减少了很多；</p><p>所有的停顿为262个周期，占周期总数的百分比为32.70911%，较没有静态调度时的49.90706%也减少了很多；</p><p>$$<br>吞吐率TP_3=\frac{538}{801\Delta{t}}<br>$$</p><p>$$<br>加速比S_3=\frac{538\times{5\Delta{t}}}{801\Delta{t}}\approx{3.36}<br>$$</p><p>吞吐率和加速比是没有静态调度时的$\frac{1076}{801}\approx{1.34}$倍。</p></li></ul><h3 id="6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。"><a href="#6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。" class="headerlink" title="6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。"></a>6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。</h3><ul><li><p>内存中的数组</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514205458.jpg" alt="2020-05-14_205419" style="zoom:80%"><p>结果正确。</p></li><li><p>部分时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514212858.jpg" alt="2020-05-14_211701" style="zoom:80%"><p>在使用静态调度和定向技术后，发现所有的RAW停顿几乎没有了，几乎只剩下了控制停顿。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514212914.jpg" alt="2020-05-14_211714" style="zoom:80%"><p>发现RAW停顿有10个周期，停顿周期数比没有静态调度和定向技术时的417个少了非常多；</p><p>共执行了669个周期，比没有静态调度和定向技术时的1076个也少了非常多；</p><p>RAW停顿占周期总数的百分比为1.494768%，较没有静态调度和定向技术时的38.75465%也减少了非常多；</p><p>所有的停顿为130个周期，占周期总数的百分比为19.43199%，较没有静态调度和定向技术时的49.90706%也减少了很多；</p><p>$$<br>吞吐率TP_4=\frac{538}{669\Delta{t}}<br>$$</p><p>$$<br>加速比S_4=\frac{538\times{5\Delta{t}}}{669\Delta{t}}\approx{4.02}<br>$$</p><p>吞吐率和加速比是没有静态调度和定向技术时的$\frac{1076}{669}\approx{1.61}$倍。</p></li></ul><h2 id="四、实验遇到的问题"><a href="#四、实验遇到的问题" class="headerlink" title="四、实验遇到的问题"></a>四、实验遇到的问题</h2><p>​ 本次实验中遇到了一个问题，如果main到下一个标签（比如loop1）只有一行汇编代码，在载入程序时，loop1的基地址就会和main重合，变为0x00000000，这样就导致loop1被覆盖，使载入的程序与自己编写的汇编程序不符，产生错误或者结果出错。但是如果&gt;=2行汇编代码就不会有问题，我怀疑是MIPSsim程序的bug。</p><h2 id="五、附录"><a href="#五、附录" class="headerlink" title="五、附录"></a>五、附录</h2><h3 id="1、初始的汇编代码"><a href="#1、初始的汇编代码" class="headerlink" title="1、初始的汇编代码"></a>1、初始的汇编代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU $r1, $r0, 11# 数组长度n&#x3D;11</span><br><span class="line">ADDIU $r2, $r1, -1# 外循环i&#x3D;n-1&#x3D;10</span><br><span class="line"></span><br><span class="line">loop1:</span><br><span class="line">ADDIU $r3, $r0, array# 数组起始地址</span><br><span class="line">ADDIU $r4, $r0, 0# 内循环j&#x3D;0</span><br><span class="line"></span><br><span class="line">loop2:</span><br><span class="line">LW $r5, 0($r3)# a[j]</span><br><span class="line">LW $r6, 4($r3)# a[j+1]</span><br><span class="line">DSUB $r7, $r6, $r5# a[j+1]-a[j]</span><br><span class="line">BGTZ $r7, pass# a[j+1]&gt;a[j]，不交换，跳到pass；</span><br><span class="line"></span><br><span class="line">SW $r6, 0($r3)# a[j+1]&lt;a[j]，交换</span><br><span class="line">SW $r5, 4($r3)</span><br><span class="line"></span><br><span class="line">pass:</span><br><span class="line">ADDIU $r4, $r4, 1# j++</span><br><span class="line">ADDIU $r3, $r3, 4# 取数组的下一个元素</span><br><span class="line">DSUB $r8, $r2, $r4# i-j</span><br><span class="line">BGTZ $r8, loop2# i&gt;j，跳转到loop2，继续内循环</span><br><span class="line"></span><br><span class="line">ADDIU $r2, $r2, -1# i--</span><br><span class="line">BGTZ $r2, loop1# i&gt;0，跳转到loop1，继续外循环</span><br><span class="line"></span><br><span class="line">TEQ $r0, $r0</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">array: .word 5,4,11,3,7,1,10,6,8,9,2</span><br></pre></td></tr></table></figure><h3 id="2、经过静态调度后的汇编代码"><a href="#2、经过静态调度后的汇编代码" class="headerlink" title="2、经过静态调度后的汇编代码"></a>2、经过静态调度后的汇编代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU $r1, $r0, 11# 数组长度n&#x3D;11</span><br><span class="line">ADDIU $r2, $r1, -1# 外循环i&#x3D;n-1&#x3D;10</span><br><span class="line"></span><br><span class="line">loop1:</span><br><span class="line">ADDIU $r3, $r0, array# 数组起始地址</span><br><span class="line">ADDIU $r4, $r0, 0# 内循环j&#x3D;0</span><br><span class="line"></span><br><span class="line">loop2:</span><br><span class="line">LW $r5, 0($r3)# a[j]</span><br><span class="line">LW $r6, 4($r3)# a[j+1]</span><br><span class="line">ADDIU $r4, $r4, 1# j++</span><br><span class="line">DSUB $r7, $r6, $r5# a[j+1]-a[j]</span><br><span class="line">DSUB $r8, $r2, $r4# i-j</span><br><span class="line">BGTZ $r7, pass# a[j+1]&gt;a[j]，不交换，跳到pass；</span><br><span class="line"></span><br><span class="line">SW $r6, 0($r3)# a[j+1]&lt;a[j]，交换</span><br><span class="line">SW $r5, 4($r3)</span><br><span class="line"></span><br><span class="line">pass:</span><br><span class="line">ADDIU $r3, $r3, 4# 取数组的下一个元素</span><br><span class="line">BGTZ $r8, loop2# i&gt;j，跳转到loop2，继续内循环</span><br><span class="line"></span><br><span class="line">ADDIU $r2, $r2, -1# i--</span><br><span class="line">BGTZ $r2, loop1# i&gt;0，跳转到loop1，继续外循环</span><br><span class="line"></span><br><span class="line">TEQ $r0, $r0</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">array: .word 5,4,11,3,7,1,10,6,8,9,2</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于计算机系统结构实验四，使用MIPS指令实现冒泡排序法。&lt;/p&gt;
    
    </summary>
    
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="汇编" scheme="https://666wxy666.github.io/tags/%E6%B1%87%E7%BC%96/"/>
    
      <category term="MIPS" scheme="https://666wxy666.github.io/tags/MIPS/"/>
    
  </entry>
  
  <entry>
    <title>计算机系统结构 实验 使用MIPS指令实现求两个数组的点积</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E4%BD%BF%E7%94%A8MIPS%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E6%B1%82%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9A%84%E7%82%B9%E7%A7%AF/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-%E4%BD%BF%E7%94%A8MIPS%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E6%B1%82%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84%E7%9A%84%E7%82%B9%E7%A7%AF/</id>
    <published>2020-05-18T12:51:25.120Z</published>
    <updated>2020-05-18T12:57:55.901Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于计算机系统结构实验三，使用MIPS指令实现求两个数组的点积。</p><a id="more"></a><h2 id="一、实验目的"><a href="#一、实验目的" class="headerlink" title="一、实验目的"></a>一、实验目的</h2><ol><li>通过实验熟悉实验 1 和实验 2 的内容。</li><li>增强汇编语言编程能力。</li><li>学会使用模拟器中的定向功能进行优化。</li><li>了解对代码进行优化的方法。</li></ol><h2 id="二、实验原理"><a href="#二、实验原理" class="headerlink" title="二、实验原理"></a>二、实验原理</h2><p>​ 通过编写MIPS汇编程序，实现向量点积的功能。在模拟器MIPSsim上执行所写的汇编程序，连续执行，查看寄存器相关结果，判断所写的汇编程序是否正确。然后观察时钟周期图窗口的执行过程和冲突的指令，查看统计窗口的信息，来判断定向前后和优化前后的执行效率高低。</p><h2 id="三、实验步骤及结果分析"><a href="#三、实验步骤及结果分析" class="headerlink" title="三、实验步骤及结果分析"></a>三、实验步骤及结果分析</h2><h3 id="1、自行编写一个计算两个向量点积的汇编程序，该程序要求可以实现求两个向量点积计算后的结果。"><a href="#1、自行编写一个计算两个向量点积的汇编程序，该程序要求可以实现求两个向量点积计算后的结果。" class="headerlink" title="1、自行编写一个计算两个向量点积的汇编程序，该程序要求可以实现求两个向量点积计算后的结果。"></a>1、自行编写一个计算两个向量点积的汇编程序，该程序要求可以实现求两个向量点积计算后的结果。</h3><p>向量的点积：假设有两个 n 维向量 a、b，则 a 与 b 的点积为：<br>$$<br>a{\cdot}b=\sum_{i=1}^na_ib_i=a_1b_1+a_2b_2+\cdots+a_nb_n<br>$$<br>两个向量元素使用数组进行数据存储，要求向量的维度不得小于10</p><p><strong><em>PS：汇编程序见附录。</em></strong></p><h3 id="2、启动-MIPSsim。"><a href="#2、启动-MIPSsim。" class="headerlink" title="2、启动 MIPSsim。"></a>2、启动 MIPSsim。</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175654.jpg" alt="2020-05-07_175631" style="zoom:50%"><h3 id="3、载入自己编写的程序，观察流水线输出结果。"><a href="#3、载入自己编写的程序，观察流水线输出结果。" class="headerlink" title="3、载入自己编写的程序，观察流水线输出结果。"></a>3、载入自己编写的程序，观察流水线输出结果。</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175822.jpg" alt="2020-05-07_175742" style="zoom:50%"><p>载入的代码：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175853.jpg" alt="2020-05-07_175807" style="zoom:80%"><p>执行：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507175940.jpg" alt="2020-05-07_175927" style="zoom:50%"><p>执行到结束：</p><ul><li><p>寄存器</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507180201.jpg" alt="2020-05-07_180059" style="zoom:80%"><p>我编写的汇编程序是向量$(1,2,3,4,5,6,7,8,9,10,11,12)\cdot(1,2,3,4,5,6,7,8,9,10,11,12)$=650，R7为结果寄存器，发现结果符合预期，说明编写的汇编程序正确。</p></li><li><p>时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507180230.jpg" alt="2020-05-07_180040" style="zoom:50%"><p>可以看到有较多停顿，主要是LW命令与MUL命令，MUL命令与ADD命令和一些控制停顿。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507180242.jpg" alt="2020-05-07_180112" style="zoom:80%"><p>发现RAW停顿有72个周期，停顿次数较多，可以进行优化。共执行了187个周期，RAW停顿占周期总数的百分比为38.50267%，所有的停顿为84个周期，占周期总数的百分比为44.91978%，效率很低。<br>$$<br>吞吐率TP_1=\frac{102}{187\Delta{t}}<br>$$</p><p>$$<br>加速比S_1=\frac{102\times{5\Delta{t}}}{187\Delta{t}}\approx{2.73}<br>$$</p></li></ul><h3 id="4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。"><a href="#4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。" class="headerlink" title="4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。"></a>4、使用定向功能再次执行代码，与刚才执行结果进行比较，观察执行效率的不同。</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507181100.jpg" alt="2020-05-07_181050" style="zoom:50%"><ul><li><p>寄存器</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507181210.jpg" alt="2020-05-07_181031" style="zoom:80%"><p>结果正确。</p></li><li><p>时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507181322.jpg" alt="2020-05-07_181255" style="zoom:50%"><p>在使用定向技术后，发现停顿明显减少。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507181345.jpg" alt="2020-05-07_181305" style="zoom:80%"><p>发现RAW停顿有24个周期，停顿次数比没有定向技术时的72个少了很多。共执行了139个周期，比没有定向技术时的187个也少了很多，RAW停顿占周期总数的百分比为17.26619%，所有的停顿为36个周期，占周期总数的百分比为25.89928%，较没有定向技术时的44.91978%也减少了很多。</p></li></ul><p>$$<br>吞吐率TP_2=\frac{102}{139\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{102\times{5\Delta{t}}}{139\Delta{t}}\approx{3.67}<br>$$<br>吞吐率和加速比是没有定向技术时的$\frac{187}{139}\approx{1.35}$倍。</p><h3 id="5、采用静态调度方法重排指令序列，减少相关，优化程序"><a href="#5、采用静态调度方法重排指令序列，减少相关，优化程序" class="headerlink" title="5、采用静态调度方法重排指令序列，减少相关，优化程序"></a>5、采用静态调度方法重排指令序列，减少相关，优化程序</h3><p><strong><em>PS：静态调度后的汇编程序见附录。</em></strong></p><ul><li><p>载入代码</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507194134.jpg" alt="2020-05-07_193938" style="zoom:80%"></li><li><p>寄存器</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507194149.jpg" alt="2020-05-07_193959" style="zoom:80%"><p>结果正确。</p></li><li><p>时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507194226.jpg" alt="2020-05-07_194041" style="zoom:50%"><p>在使用静态调度后，发现停顿几乎没有了。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507194203.jpg" alt="2020-05-07_194021" style="zoom:80%"><p>发现RAW停顿有12个周期，停顿次数比没有静态调度时的72个少了很多。共执行了127个周期，比没有静态调度时的187个也少了很多，RAW停顿占周期总数的百分比为9.448819%，所有的停顿为24个周期，占周期总数的百分比为18.89764%，较没有静态调度时的44.91978%也减少了很多。</p></li></ul><p>$$<br>吞吐率TP_3=\frac{102}{127\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{102\times{5\Delta{t}}}{127\Delta{t}}\approx{4.02}<br>$$<br>吞吐率和加速比是没有静态调度时的$\frac{187}{127}\approx{1.47}$倍。</p><h3 id="6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。"><a href="#6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。" class="headerlink" title="6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。"></a>6、对优化后的程序使用定向功能执行，与刚才执行结果进行比较，观察执行效率的不同。</h3><ul><li><p>寄存器</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507195018.jpg" alt="2020-05-07_194713" style="zoom:80%"><p>结果正确。</p></li><li><p>时钟周期图</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507195031.jpg" alt="2020-05-07_194926" style="zoom:50%"><p>在使用静态调度和分支技术后，发现所有的RAW停顿都没有了，只剩下了控制停顿。</p></li><li><p>统计</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507195110.jpg" alt="2020-05-07_195000" style="zoom:80%"><p>发现没有RAW停顿。共执行了115个周期，比没有静态调度和定向技术时的187个也少了非常多，RAW停顿占周期总数的百分比为0%，所有的停顿为12个周期，全都是控制停顿，占周期总数的百分比为10.43478%，较没有静态调度和定向技术时的44.91978%也减少了非常多，没有RAW停顿也说明这个静态调度是最优调度。</p></li></ul><p>$$<br>吞吐率TP_4=\frac{102}{115\Delta{t}}<br>$$</p><p>$$<br>加速比S_2=\frac{102\times{5\Delta{t}}}{115\Delta{t}}\approx{4.43}<br>$$<br>吞吐率和加速比是没有静态调度和定向技术时的$\frac{187}{115}\approx{1.63}$倍。</p><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><h3 id="1、初始的汇编代码"><a href="#1、初始的汇编代码" class="headerlink" title="1、初始的汇编代码"></a>1、初始的汇编代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU $r1,$r0,array1</span><br><span class="line">ADDIU $r2,$r0,array2</span><br><span class="line">ADDIU $r3,$r0,12</span><br><span class="line">ADDIU $r7,$r0,0</span><br><span class="line">loop:</span><br><span class="line">LW $r4,0($r1)</span><br><span class="line">LW $r5,0($r2)</span><br><span class="line">MUL $r6,$r4,$r5</span><br><span class="line">ADD $r7,$r7,$r6</span><br><span class="line">ADDI $r1,$r1,4</span><br><span class="line">ADDI $r2,$r2,4</span><br><span class="line">ADDI $r3,$r3,-1</span><br><span class="line">BGTZ $r3,loop</span><br><span class="line">TEQ $r0,$r0</span><br><span class="line">.data</span><br><span class="line">array1: .word 1,2,3,4,5,6,7,8,9,10,11,12</span><br><span class="line">array2: .word 1,2,3,4,5,6,7,8,9,10,11,12</span><br></pre></td></tr></table></figure><h3 id="2、经过静态调度后的汇编代码"><a href="#2、经过静态调度后的汇编代码" class="headerlink" title="2、经过静态调度后的汇编代码"></a>2、经过静态调度后的汇编代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">main:</span><br><span class="line">ADDIU $r1,$r0,array1</span><br><span class="line">ADDIU $r2,$r0,array2</span><br><span class="line">ADDIU $r3,$r0,12</span><br><span class="line">ADDIU $r7,$r0,0</span><br><span class="line">loop:</span><br><span class="line">LW $r4,0($r1)</span><br><span class="line">LW $r5,0($r2)</span><br><span class="line">ADDI $r1,$r1,4</span><br><span class="line">ADDI $r2,$r2,4</span><br><span class="line">MUL $r6,$r4,$r5</span><br><span class="line">ADDI $r3,$r3,-1</span><br><span class="line">ADD $r7,$r7,$r6</span><br><span class="line">BGTZ $r3,loop</span><br><span class="line">TEQ $r0,$r0</span><br><span class="line">.data</span><br><span class="line">array1: .word 1,2,3,4,5,6,7,8,9,10,11,12</span><br><span class="line">array2: .word 1,2,3,4,5,6,7,8,9,10,11,12</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于计算机系统结构实验三，使用MIPS指令实现求两个数组的点积。&lt;/p&gt;
    
    </summary>
    
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="汇编" scheme="https://666wxy666.github.io/tags/%E6%B1%87%E7%BC%96/"/>
    
      <category term="MIPS" scheme="https://666wxy666.github.io/tags/MIPS/"/>
    
  </entry>
  
  <entry>
    <title>计算机系统结构 实验 1和2遇到的问题</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-1%E5%92%8C2%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84-%E5%AE%9E%E9%AA%8C-1%E5%92%8C2%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</id>
    <published>2020-05-18T12:51:07.129Z</published>
    <updated>2020-05-18T13:11:54.425Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于计算机系统结构实验一（MIPS指令系统和MIPS体系结构）和实验二（流水线及流水线中的冲突），遇到的一些问题。</p><a id="more"></a><h2 id="一、关于字"><a href="#一、关于字" class="headerlink" title="一、关于字"></a>一、关于字</h2><p>B:byte 字节指令</p><p>H:half word 半字节指令</p><p>W:word 字节指令</p><h2 id="二、关于访存"><a href="#二、关于访存" class="headerlink" title="二、关于访存"></a>二、关于访存</h2><p>按字或半字访存，无论给定地址是字（半字）中的哪一个字节的地址，都会自动转换为该字（半字）的首字节的地址。例如：MIPS中字长4字节，32位（红色框）；半字2字节，16位（蓝色框）。无论你给定的是第一个红框里的7C(0x00000000)/00(0x00000001)/08(0x00000002)/24(0x00000003)的哪一的地址，只要是按字访存，都会自动转换为7C的地址0x00000000，取出的内容都是2408007C，<strong><em>一定要注意，这里是小端法存储</em></strong>。</p><ul><li><p>小端法：高内存地址放整数的高位，低内存地址放整数的低位，这种方式叫倒着放，术语叫小端对齐。电脑X86和手机ARM都是小端对齐的。</p></li><li><p>大端法：高内存地址放整数的低位，低内存地址放整数的高位，这种方式叫正着放，术语叫大端对齐。很多Unix服务器的cpu都是大端对齐的。</p></li></ul><p>大端和小端字节序不是由操作系统决定的，而是由cpu架构决定的。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200419150741.png" alt="2020-04-19_150338" style="zoom:80%"><h2 id="三、关于返回地址"><a href="#三、关于返回地址" class="headerlink" title="三、关于返回地址"></a>三、关于返回地址</h2><p>关于这里的<strong><em>返回地址</em></strong>，后面的所有其他跳转指令的返回地址均指的是：当前指令的下一条指令的地址，也就是跳转指令如果不跳转（分支失败）的下一条指令的地址。例如：当前的指令的地址是0x00000068，那么返回地址就是0x00000072。还要注意offset要左移两位并进行符号位扩展后才能与PC相加得到转移地址。这里左移两位的目的是，将offset*4，使之成为4的倍数。也就是说PC+offset&lt;&lt;2代表了PC的后offset+1（因为PC+offset&lt;&lt;2的PC已经+1了）条指令为转移指令。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200419152615.png" alt="QQ图片20200419152549" style="zoom:80%"><h2 id="四、关于定向技术"><a href="#四、关于定向技术" class="headerlink" title="四、关于定向技术"></a>四、关于定向技术</h2><p>在定向技术中，因为其采用的是静态指令调度。非运算类指令必须在 ID段 得到之前指令的定向数据。并不能像运算类执行一样在 EX段 得到定向数据；如图所示：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518210441.jpg" alt="307-实验二-第二组" style="zoom:80%"><h2 id="五、关于STALL"><a href="#五、关于STALL" class="headerlink" title="五、关于STALL"></a>五、关于STALL</h2><p>“绿色<font color="red">ID</font>后跟绿色ID” 和 “绿色STALL后跟绿色ID”的区别：<br>绿色<font color="red">ID</font>表示该周期ID可以执行，但是存在RAW冲突，因此执行失败，因此紧接着要做绿色ID；<br>绿色STALL表示该周期由于上一条指令的红色STALL，导致该指令此周期停顿，下一周期执行绿色ID。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于计算机系统结构实验一（MIPS指令系统和MIPS体系结构）和实验二（流水线及流水线中的冲突），遇到的一些问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="实验" scheme="https://666wxy666.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="实验" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E9%AA%8C/"/>
    
      <category term="计算机系统结构" scheme="https://666wxy666.github.io/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/"/>
    
      <category term="汇编" scheme="https://666wxy666.github.io/tags/%E6%B1%87%E7%BC%96/"/>
    
      <category term="MIPS" scheme="https://666wxy666.github.io/tags/MIPS/"/>
    
  </entry>
  
  <entry>
    <title>大数据实战 Spark Streaming 实时计算Kafka数据</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-Streaming-%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97Kafka%E6%95%B0%E6%8D%AE/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-Streaming-%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97Kafka%E6%95%B0%E6%8D%AE/</id>
    <published>2020-05-18T11:40:43.154Z</published>
    <updated>2020-05-19T04:05:54.426Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于大数据通过Spark Streaming实现流计算Kafka数据进行单词计数。</p><a id="more"></a><h2 id="一、实验环境："><a href="#一、实验环境：" class="headerlink" title="一、实验环境："></a>一、实验环境：</h2><ul><li>虚拟机数量：3(一主两从，主机名分别为：master、slave01、slave02)</li><li>系统版本：Centos 7.5</li><li>Zookeeper版本： Apache Zookeeper 3.4.10</li><li>Kafka版本：kafka_2.11-0.10.2.1</li><li>Spark版本：Apache Spark 2.1.1</li></ul><h2 id="二、实验内容："><a href="#二、实验内容：" class="headerlink" title="二、实验内容："></a>二、实验内容：</h2><ul><li>通过创建Kafka topic，使用Kafka Producer产生消息，然后通过编写spark<br>Streaming程序处理这些消息。</li><li>主要步骤：<ul><li>创建Spark Streaming项目工程</li><li>编写streaming程序</li><li>启动Zookeeper，Kafka集群</li><li>创建topic</li><li>启动Kafka生产者</li><li>准备作业环境</li><li>提交作业</li></ul></li></ul><h2 id="三、实验步骤："><a href="#三、实验步骤：" class="headerlink" title="三、实验步骤："></a>三、实验步骤：</h2><h3 id="3-1打开IDEA软件"><a href="#3-1打开IDEA软件" class="headerlink" title="3.1打开IDEA软件"></a>3.1打开IDEA软件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">cd idea-IC-172.4574.19/</span><br><span class="line">bin/idea.sh &amp;</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184342.jpg" alt="2020-05-18_160617" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184356.jpg" alt="2020-05-18_160648" style="zoom:80%"><h3 id="3-2创建项目"><a href="#3-2创建项目" class="headerlink" title="3.2创建项目"></a>3.2创建项目</h3><p>3.2.1创建同之前章节结构一致的项目spark_test, 设置语言级别为8。</p><p>3.2.2点击 Create New Project，进入如下图界面，按照图标依次点击，最后点击next。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211601.jpg" alt="2020-04-23_185224" style="zoom:80%"><p>3.2.3依次输入GroupId和ArtifactId和Version的值，随后点击next。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211619.jpg" alt="2020-04-23_185405" style="zoom:80%"><p>3.2.4进入如下界面，设置本地Maven项目的setting.xml文件和warehouse仓库，点击next按钮。</p><p>3.2.4.1本地setting.xml文件在/home/zkpk/apache-maven-3.5.0/conf目录下。</p><p>3.2.4.2本地仓库文件夹warehouse在/home/zkpk/apache-maven-3.5.0/warehouse。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211646.jpg" alt="2020-04-23_185452" style="zoom:80%"><p>3.2.5进入如下界面，输入工程名称spark_test，然后点击next，OK。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211749.jpg" alt="2020-04-23_185533" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211810.jpg" alt="2020-04-23_185546" style="zoom:80%"><p>3.2.6工程创建完成后会自动打开一个名为zkpk的xml文件，按照以下修改：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.zkpk.lab<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkpk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">inceptionYear</span>&gt;</span>2008<span class="tag">&lt;/<span class="name">inceptionYear</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scala.version</span>&gt;</span>2.11.11<span class="tag">&lt;/<span class="name">scala.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hadoop.version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">hadoop.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kafka.version</span>&gt;</span>0.10.2.1<span class="tag">&lt;/<span class="name">kafka.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>scala-tools.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Scala-Tools Maven2 Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://scala-tools.org/repo-releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>scala-tools.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Scala-Tools Maven2 Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://scala-tools.org/repo-releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-streaming-kafka-0-10_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;kafka.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/scala<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-scala-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-target:jvm-1.5<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-eclipse-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">downloadSources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">downloadSources</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">buildcommands</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">buildcommand</span>&gt;</span>ch.epfl.lamp.sdt.core.scalabuilder<span class="tag">&lt;/<span class="name">buildcommand</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">buildcommands</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">additionalProjectnatures</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">projectnature</span>&gt;</span>ch.epfl.lamp.sdt.core.scalanature<span class="tag">&lt;/<span class="name">projectnature</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">additionalProjectnatures</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">classpathContainers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classpathContainer</span>&gt;</span>org.eclipse.jdt.launching.JRE_CONTAINER<span class="tag">&lt;/<span class="name">classpathContainer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classpathContainer</span>&gt;</span>ch.epfl.lamp.sdt.launching.SCALA_CONTAINER<span class="tag">&lt;/<span class="name">classpathContainer</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">classpathContainers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">reporting</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-scala-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3.2.7保存修改的pom.xml文件后，点击工程名，依次选择Maven——&gt;Reimport，即可根据pom.xml文件导入依赖包。</p><p>3.2.8设置语言环境language level，点击菜单栏中的file，选择Project Structure，弹出如下对话框，选择Modules，选择Language level为8，然后点击Apply，点击OK。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212331.jpg" alt="2020-04-23_190537" style="zoom:80%"><p>3.2.9设置Java Compiler环境，点击菜单栏中的file，选择Setting，弹出如下对话框，依次选择Build，Execution——&gt;Compiler——&gt;Java Compiler，设置图中的Project bytecode version为1.8，设置图中的Target bytecode version为1.8，然后依次点击Apply和OK。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212433.jpg" alt="2020-04-23_190657" style="zoom:80%"><p>至此，Spark Maven工程创建完毕。</p><p>3.2.10在项目sclaa文件下的org.zkpk.lab下新建“kafka_streaming”Object。</p><p>创建完成后的工程结构：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184547.jpg" alt="2020-05-18_163207" style="zoom:80%"><h3 id="3-3编写scala代码"><a href="#3-3编写scala代码" class="headerlink" title="3.3编写scala代码"></a>3.3编写scala代码</h3><p>下面是部分代码截图，具体代码在本文的附录中。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184610.jpg" alt="2020-05-18_170115" style="zoom:80%"><h3 id="3-4使用maven打包程序"><a href="#3-4使用maven打包程序" class="headerlink" title="3.4使用maven打包程序"></a>3.4使用maven打包程序</h3><p>开始打包。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184749.jpg" alt="2020-05-18_170203" style="zoom:80%"><p>打包完成。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184800.jpg" alt="2020-05-18_170204" style="zoom:80%"><h3 id="3-5启动Zookeeper集群"><a href="#3-5启动Zookeeper集群" class="headerlink" title="3.5启动Zookeeper集群"></a>3.5启动Zookeeper集群</h3><p>3.5.1分别登录master和slave01、slave02节点，进入zookeeper安装目录，启动服务。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518184917.jpg" alt="2020-05-18_170527" style="zoom:80%"><p>3.5.2在三个节点上分别运行<code>bin/zkServer.sh status</code>命令查看状态，出现follower或leader表示ZK启动成功。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518185007.jpg" alt="2020-05-18_170817" style="zoom:80%"><h3 id="3-6启动Kafka集群"><a href="#3-6启动Kafka集群" class="headerlink" title="3.6启动Kafka集群"></a>3.6启动Kafka集群</h3><p>在 master 和 slave01、slave02节点分别启动 Kafka。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518185051.jpg" alt="2020-05-18_171119" style="zoom:80%"><h3 id="3-7创建Kafka-topic"><a href="#3-7创建Kafka-topic" class="headerlink" title="3.7创建Kafka topic"></a>3.7创建Kafka topic</h3><p>名称需要和代码中保持一致。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518191546.jpg" alt="2020-05-18_171340" style="zoom:80%"><h3 id="3-8在一个终端上启动一个生产者-准备生产"><a href="#3-8在一个终端上启动一个生产者-准备生产" class="headerlink" title="3.8在一个终端上启动一个生产者,准备生产"></a>3.8在一个终端上启动一个生产者,准备生产</h3><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518191639.jpg" alt="2020-05-18_171502" style="zoom:80%"><h3 id="3-9使用spark-submit提交spark-应用"><a href="#3-9使用spark-submit提交spark-应用" class="headerlink" title="3.9使用spark-submit提交spark 应用"></a>3.9使用spark-submit提交spark 应用</h3><p>3.9.1将生成的jar包文件复制到/home/zkpk下。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518191855.jpg" alt="2020-05-18_171718" style="zoom:80%"><p>3.9.2提交sparkjob之前需要将spark-streaming-kafka-0-10_2.11-2.1.0，kafka-clients-0.10.2.这两个jar添加到spark_home/jars/路径下，否则程序提交会报错。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518191929.jpg" alt="2020-05-18_172111" style="zoom:80%"><p>3.9.3新开一个终端，在/home/zkpk目录下提交程序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --class org.zkpk.lab.kafka_streaming zkpk-1.0.jar</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518191955.jpg" alt="2020-05-18_174524" style="zoom:80%"><h3 id="3-10输入内容，查看结果"><a href="#3-10输入内容，查看结果" class="headerlink" title="3.10输入内容，查看结果"></a>3.10输入内容，查看结果</h3><p>切换到之前的Kafka生产者终端中输入如下内容，然后切换到sparkStreaming任务界面查看结果。</p><ul><li><p>输入：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192227.jpg" alt="2020-05-18_174619" style="zoom:80%"><p>结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192249.jpg" alt="2020-05-18_174609" style="zoom:80%"></li><li><p>输入：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192408.jpg" alt="2020-05-18_174732" style="zoom:80%"><p>结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192418.jpg" alt="2020-05-18_174721" style="zoom:80%"></li><li><p>输入：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192431.jpg" alt="2020-05-18_174825" style="zoom:80%"><p>结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518192450.jpg" alt="2020-05-18_174817" style="zoom:80%"></li></ul><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><h3 id="kafka-streaming-scala"><a href="#kafka-streaming-scala" class="headerlink" title="kafka_streaming.scala"></a>kafka_streaming.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.lab</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.<span class="type">StringDeserializer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010._</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010.<span class="type">LocationStrategies</span>.<span class="type">PreferConsistent</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka010.<span class="type">ConsumerStrategies</span>.<span class="type">Subscribe</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">kafka_streaming</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setMaster(<span class="string">"local[2]"</span>).setAppName(<span class="string">"kafka_test"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">Object</span>](</span><br><span class="line">      <span class="string">"bootstrap.servers"</span> -&gt; <span class="string">"master:9092"</span>,</span><br><span class="line">      <span class="string">"key.deserializer"</span> -&gt; classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="string">"value.deserializer"</span> -&gt; classOf[<span class="type">StringDeserializer</span>],</span><br><span class="line">      <span class="string">"group.id"</span> -&gt; <span class="string">"example"</span>,</span><br><span class="line">      <span class="string">"auto.offset.reset"</span> -&gt; <span class="string">"latest"</span>,</span><br><span class="line">      <span class="string">"enable.auto.commit"</span> -&gt; (<span class="literal">false</span>: java.lang.<span class="type">Boolean</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> topics = <span class="type">List</span>(<span class="string">"test_kafka"</span>).toSet</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> stream = <span class="type">KafkaUtils</span>.createDirectStream</span><br><span class="line">      [<span class="type">String</span>,<span class="type">String</span>](</span><br><span class="line">        ssc,</span><br><span class="line">        <span class="type">PreferConsistent</span>,</span><br><span class="line">        <span class="type">Subscribe</span>[<span class="type">String</span>,<span class="type">String</span>](topics,kafkaParams)</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> lines = stream.map(_.value)</span><br><span class="line">    <span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">" "</span>))</span><br><span class="line">    <span class="keyword">val</span> wordcounts = words.map((_,<span class="number">1</span>)).reduceByKey(_+_)</span><br><span class="line">    wordcounts.print()</span><br><span class="line"></span><br><span class="line">    ssc.start()</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于大数据通过Spark Streaming实现流计算Kafka数据进行单词计数。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Spark" scheme="https://666wxy666.github.io/tags/Spark/"/>
    
      <category term="单词计数" scheme="https://666wxy666.github.io/tags/%E5%8D%95%E8%AF%8D%E8%AE%A1%E6%95%B0/"/>
    
      <category term="Scala" scheme="https://666wxy666.github.io/tags/Scala/"/>
    
      <category term="流计算" scheme="https://666wxy666.github.io/tags/%E6%B5%81%E8%AE%A1%E7%AE%97/"/>
    
      <category term="Streaming" scheme="https://666wxy666.github.io/tags/Streaming/"/>
    
      <category term="Kafka" scheme="https://666wxy666.github.io/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>大数据实战 Spark Java单词计数</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-Java%E5%8D%95%E8%AF%8D%E8%AE%A1%E6%95%B0/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%AE%9E%E6%88%98-Spark-Java%E5%8D%95%E8%AF%8D%E8%AE%A1%E6%95%B0/</id>
    <published>2020-05-18T11:40:38.355Z</published>
    <updated>2020-05-18T12:29:15.247Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是关于大数据通过Spark实现Java单词计数。</p><a id="more"></a><h2 id="一、实验环境："><a href="#一、实验环境：" class="headerlink" title="一、实验环境："></a>一、实验环境：</h2><ul><li>虚拟机数量：1</li><li>系统版本：Centos 7.5</li><li>Spark版本：Apache Spark 2.1.1</li><li>JDK版本： jdk-8u131-linux-x64</li><li>IDEA版本：ideaIC-2017.2.7</li></ul><h2 id="二、实验内容："><a href="#二、实验内容：" class="headerlink" title="二、实验内容："></a>二、实验内容：</h2><ul><li>创建spark项目</li><li>使用Java API 编写wordcount</li><li>打印结果</li></ul><h2 id="三、实验步骤："><a href="#三、实验步骤：" class="headerlink" title="三、实验步骤："></a>三、实验步骤：</h2><h3 id="3-1新建数据源"><a href="#3-1新建数据源" class="headerlink" title="3.1新建数据源"></a>3.1新建数据源</h3><p>3.1.1在/home/zkpk目录下创建worddata.txt文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">vim worddata.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423203009.jpg" alt="2020-04-23_184840" style="zoom:80%"><p>3.1.2输入以下内容作为JavaWordCount程序的源数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hello hi hi spark</span><br><span class="line">hello spark hello hi sparksql</span><br><span class="line">hello hi hi sparkstreaming</span><br><span class="line">hello hi sparkgraphx</span><br><span class="line">hello hello world</span><br><span class="line">hello java c python</span><br><span class="line">hello scala go html</span><br><span class="line">hi hi hello spark hdfs</span><br><span class="line">hello hadoop</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211155.jpg" alt="2020-04-23_184956" style="zoom:80%"><p>3.1.3打开IDEA，创建Java任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">cd idea-IC-172.4574.19/</span><br><span class="line">bin/idea.sh &amp;</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211241.jpg" alt="2020-04-23_185042" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211258.jpg" alt="2020-04-23_185058" style="zoom:80%"><h3 id="3-2创建Spark-Maven工程，使用Java-API-编写wordcount"><a href="#3-2创建Spark-Maven工程，使用Java-API-编写wordcount" class="headerlink" title="3.2创建Spark Maven工程，使用Java API 编写wordcount"></a>3.2创建Spark Maven工程，使用Java API 编写wordcount</h3><p>3.2.1点击 Create New Project</p><p>3.2.2进入如下图界面，按照图标依次点击，最后点击next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211601.jpg" alt="2020-04-23_185224" style="zoom:80%"><p>3.2.3依次输入GroupId和ArtifactId和Version的值，随后点击next</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211619.jpg" alt="2020-04-23_185405" style="zoom:80%"><p>3.2.4进入如下界面，设置本地Maven项目的setting.xml文件和warehouse仓库，点击next按钮</p><p>3.2.4.1本地setting.xml文件在/home/zkpk/apache-maven-3.5.0/conf目录下</p><p>3.2.4.2本地仓库文件夹warehouse在/home/zkpk/apache-maven-3.5.0/warehouse</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211646.jpg" alt="2020-04-23_185452" style="zoom:80%"><p>3.2.5进入如下界面，输入工程名称spark_test，然后点击next，OK</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211749.jpg" alt="2020-04-23_185533" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423211810.jpg" alt="2020-04-23_185546" style="zoom:80%"><p>3.2.6工程创建完成后会自动打开一个名为zkpk的xml文件，按照以下修改：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.zkpk.lab<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkpk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">inceptionYear</span>&gt;</span>2008<span class="tag">&lt;/<span class="name">inceptionYear</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scala.version</span>&gt;</span>2.11.11<span class="tag">&lt;/<span class="name">scala.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spark.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">spark.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>scala-tools.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Scala-Tools Maven2 Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://scala-tools.org/repo-releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>scala-tools.org<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Scala-Tools Maven2 Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://scala-tools.org/repo-releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>scala-library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-core_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.spark<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spark-sql_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spark.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sourceDirectory</span>&gt;</span>src/main/scala<span class="tag">&lt;/<span class="name">sourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">testSourceDirectory</span>&gt;</span>src/test/scala<span class="tag">&lt;/<span class="name">testSourceDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-scala-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>testCompile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-target:jvm-1.5<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-eclipse-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">downloadSources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">downloadSources</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">buildcommands</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">buildcommand</span>&gt;</span>ch.epfl.lamp.sdt.core.scalabuilder<span class="tag">&lt;/<span class="name">buildcommand</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">buildcommands</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">additionalProjectnatures</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">projectnature</span>&gt;</span>ch.epfl.lamp.sdt.core.scalanature<span class="tag">&lt;/<span class="name">projectnature</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">additionalProjectnatures</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">classpathContainers</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classpathContainer</span>&gt;</span>org.eclipse.jdt.launching.JRE_CONTAINER<span class="tag">&lt;/<span class="name">classpathContainer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">classpathContainer</span>&gt;</span>ch.epfl.lamp.sdt.launching.SCALA_CONTAINER<span class="tag">&lt;/<span class="name">classpathContainer</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">classpathContainers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">reporting</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.scala-tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-scala-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scalaVersion</span>&gt;</span>$&#123;scala.version&#125;<span class="tag">&lt;/<span class="name">scalaVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3.2.7保存修改的pom.xml文件后，点击工程名，依次选择Maven——&gt;Reimport，即可根据pom.xml文件导入依赖包，出现下图就代表正在导入依赖包</p><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212207.jpg" alt="2020-04-23_190350"></p><p>3.2.8设置语言环境language level，点击菜单栏中的file，选择Project Structure，弹出如下对话框，选择Modules，选择Language level为8，然后点击Apply，点击OK</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212331.jpg" alt="2020-04-23_190537" style="zoom:80%"><p>3.2.9设置Java Compiler环境，点击菜单栏中的file，选择Setting，弹出如下对话框，依次选择Build，Execution——&gt;Compiler——&gt;Java Compiler，设置图中的Project bytecode version为1.8，设置图中的Target bytecode version为1.8，然后依次点击Apply和OK</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212433.jpg" alt="2020-04-23_190657" style="zoom:80%"><p>至此，Spark Maven工程创建完毕</p><p>3.2.10在main文件夹下新建文件夹，在弹出的对话框中，输入新文件夹名称为java，点击ok</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212556.jpg" alt="2020-04-23_190754" style="zoom:80%"><p>3.2.11右击先创建的java目录，依次选择Mark Directory as—&gt;Sources Root，此时就可以在java目录中创建类了，我们右键点击java目录，依次选择New——&gt;Java——&gt;Class，弹出对话框，输入Java Class的名字：JavaWordCount，然后点击ok</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423212726.jpg" alt="2020-04-23_190850" style="zoom:80%"><p>3.2.12编写如下Java代码，实现词频统计，我在原有的参考答案上又新增了可以根据次品的大小，从大到小排序展示的功能，下面是代码截图，具体代码在本文的附录中</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423213015.jpg" alt="2020-04-23_192501" style="zoom:80%"><h3 id="3-3运行程序，查看结果"><a href="#3-3运行程序，查看结果" class="headerlink" title="3.3运行程序，查看结果"></a>3.3运行程序，查看结果</h3><p>选中程序JavaWordCount，在代码界面点击鼠标右键，出现如下提示框，选择并点击Run JavaWordCount.main()，运行程序，并在终端界面查看程序输出结果</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200423213208.png" alt="2020-04-23_192611" style="zoom:80%"><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><h3 id="1、JavaWordCount-java"><a href="#1、JavaWordCount-java" class="headerlink" title="1、JavaWordCount.java"></a>1、JavaWordCount.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.SparkSession;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaWordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern SPACE = Pattern.compile(<span class="string">" "</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        SparkSession ss = SparkSession</span><br><span class="line">                .builder()</span><br><span class="line">                .master(<span class="string">"local"</span>)</span><br><span class="line">                .appName(<span class="string">"JavaWordCount"</span>)</span><br><span class="line">                .getOrCreate();</span><br><span class="line"></span><br><span class="line">        JavaRDD&lt;String&gt; lines =</span><br><span class="line">                ss.read().textFile(<span class="string">"file:///home/zkpk/worddata.txt"</span>).javaRDD();</span><br><span class="line"></span><br><span class="line">        JavaRDD&lt;String&gt; words =</span><br><span class="line">                lines.flatMap(s -&gt; Arrays.asList(SPACE.split(s)).iterator());</span><br><span class="line"></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; wordAndOne =</span><br><span class="line">                words.mapToPair(s -&gt; <span class="keyword">new</span> Tuple2&lt;&gt;(s, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; wordAndNum =</span><br><span class="line">                wordAndOne.reduceByKey((i1, i2) -&gt; i1 + i2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自己额外实现了可以根据词频的大小，从大到小排序展示的功能</span></span><br><span class="line">        List&lt;Tuple2&lt;String, Integer&gt;&gt; result = wordAndNum</span><br><span class="line">                <span class="comment">//先将key和value交换</span></span><br><span class="line">                .mapToPair((row) -&gt;  <span class="keyword">new</span> Tuple2&lt;&gt;(row._2,row._1))</span><br><span class="line">                <span class="comment">//按照交换后的key也就是词频倒排序</span></span><br><span class="line">                .sortByKey(<span class="keyword">false</span>)</span><br><span class="line">                <span class="comment">//再将key和value交换回来，回到单词在前，词频在后的状态</span></span><br><span class="line">                .mapToPair((row) -&gt;  <span class="keyword">new</span> Tuple2&lt;&gt;(row._2,row._1))</span><br><span class="line">                .collect();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Tuple2&lt;?,?&gt; tuple : result)&#123;</span><br><span class="line">            System.out.println(tuple._1() + <span class="string">": "</span> + tuple._2());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ss.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、ScalaWordCount-scala"><a href="#2、ScalaWordCount-scala" class="headerlink" title="2、ScalaWordCount.scala"></a>2、ScalaWordCount.scala</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.zkpk.lab</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalaWordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">ScalaWordCount</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> list = <span class="type">List</span>(<span class="string">"hello hi hi spark "</span>,</span><br><span class="line">      <span class="string">"hello spark hello hi sparksql "</span>,</span><br><span class="line">      <span class="string">"hello hi hi sparkstreaming "</span>,</span><br><span class="line">      <span class="string">"hello hi sparkgraphx"</span>)</span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"word-count"</span>).setMaster(<span class="string">"local[*]"</span>)</span><br><span class="line">    <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(sparkConf)</span><br><span class="line">    <span class="keyword">val</span> lines: <span class="type">RDD</span>[<span class="type">String</span>] = sc.parallelize(list)</span><br><span class="line">    <span class="keyword">val</span> words: <span class="type">RDD</span>[<span class="type">String</span>] =</span><br><span class="line">        lines.flatMap((line: <span class="type">String</span>) =&gt; &#123;line.split(<span class="string">" "</span>)&#125;)</span><br><span class="line">    <span class="keyword">val</span> wordAndOne: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] =</span><br><span class="line">        words.map((word: <span class="type">String</span>) =&gt; &#123;(word, <span class="number">1</span>)&#125;)</span><br><span class="line">    <span class="keyword">val</span> wordAndNum: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Int</span>)] =</span><br><span class="line">      wordAndOne.reduceByKey((count1: <span class="type">Int</span>, count2: <span class="type">Int</span>) =&gt; &#123;count1+ count2&#125;)</span><br><span class="line">    <span class="keyword">val</span> ret = wordAndNum.sortBy(kv =&gt; kv._2, <span class="literal">false</span>)</span><br><span class="line">    println(ret.collect().mkString(<span class="string">","</span>))</span><br><span class="line">    ret.saveAsTextFile(args(<span class="number">0</span>))</span><br><span class="line">    sc.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文是关于大数据通过Spark实现Java单词计数。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Spark" scheme="https://666wxy666.github.io/tags/Spark/"/>
    
      <category term="单词计数" scheme="https://666wxy666.github.io/tags/%E5%8D%95%E8%AF%8D%E8%AE%A1%E6%95%B0/"/>
    
      <category term="Java" scheme="https://666wxy666.github.io/tags/Java/"/>
    
      <category term="Scala" scheme="https://666wxy666.github.io/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>现代交换原理 MOOC习题 5~6章</title>
    <link href="https://666wxy666.github.io/2020/05/18/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86-MOOC%E4%B9%A0%E9%A2%98-5~6%E7%AB%A0/"/>
    <id>https://666wxy666.github.io/2020/05/18/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86-MOOC%E4%B9%A0%E9%A2%98-5~6%E7%AB%A0/</id>
    <published>2020-05-18T01:45:04.913Z</published>
    <updated>2020-06-14T02:42:25.014Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>自己随便整理了一下在学习“现代交换原理”网课时遇到的一些习题，易错点之类的。接上文<a href="/2020/05/07/现代交换原理-MOOC习题-1~4章/">现代交换原理 MOOC习题 1~4章</a>。</p><a id="more"></a><h2 id="第五章-信令与协议"><a href="#第五章-信令与协议" class="headerlink" title="第五章 信令与协议"></a>第五章 信令与协议</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518094712.jpg" alt="2020-05-18_094257" style="zoom:80%"><blockquote><p>通话所需的媒体资源可以理解为控制呼叫的接续和拆线和通信网管理和维护的信息资源。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518094755.png" alt="QQ图片20200518094332" style="zoom:80%"><blockquote><p>通信网中为用户建立连接和拆除连接，需要网中各个相关设备协调工作，为此在各个设备间传输的控制信号和规约称为信令。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518095101.jpg" alt="2020-05-18_094308" style="zoom:80%"><blockquote><p>路由标记供MTP3级进行消息寻址和路由，而MTP3的路由标记是由信令点编码实现的。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518095738.jpg" alt="20200518094345" style="zoom:80%"><blockquote><ol start="4"><li><p>电信网（现代通信网）的三大支撑网络：同步网，管理网，信令网。</p></li><li><p>SIP与普通电话用户进行通话时要进行协议转换，SIP-&gt;七号信令。SIP协议中SDP的媒体端口号由网关（中继网关）保存。中继网关是分组网和电路网边界设备，实现不同媒体协议的转换。</p><p>注意中继网关（Trunk Gateway）跟代理服务器（Proxy Server）不是一个东西。</p><p>中继网关也叫落地设备，简称TG。用于VOIP网络电话系统或呼叫中心、软交换等，将模拟信号与数字信号相互转换。是voip解决方案的重要组成部分，它位于NGN网络的边缘接入层，连接PSTN和voip网络，实现IP包转TDM的功能。 承载着IP域与电路域的语音汇接任务。</p></li><li><p>常识问题。</p></li></ol></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518095251.jpg" alt="2020-05-18_094440" style="zoom:80%"><blockquote><ol start="7"><li><p>显然错误，MTP1的通路也要经过TST交换网络。</p></li><li><p>错误，不多解释。</p></li><li><p>模拟用户信令：主要包括用户向交换机发送的监视信令和选择信令，交换机向用户发送的铃流和忙音等音信号。<strong><em>用于PSTN</em></strong>。</p><ul><li>状态信令：用户线的忙闲状态，如主、被叫的摘、挂机状态；</li><li>地址信令：主叫所拨的被叫号码，直流脉冲或双音频；</li><li>铃流和信号音：交换机向用户发送的信号。振铃信号、信号音、来电显示的FSK信号；</li></ul><p>数字用户信令：通过消息的形式传送以上信息，<strong><em>用于ISDN用户</em></strong>。例如：DSS1 30B+D</p><p>在用户线上传输的信令叫用户线信令，No.7信令是专为电话局之间交互控制信息而设计的，所以是局间信令，也就是在中继线上交互的信令，以数字信号方式传送。它跟能否携带电话号码没关系。</p></li></ol></blockquote><h2 id="第六章-移动交换"><a href="#第六章-移动交换" class="headerlink" title="第六章 移动交换"></a>第六章 移动交换</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531205352.jpg" alt="2020-05-31_205201" style="zoom:80%"><blockquote><p>MSC是移动交换中心，主要功能有：</p><ol><li>信道的管理和分配；</li><li>呼叫的处理和控制；</li><li>用户位置信息的登记与管理；</li><li>越区切换和漫游的控制；</li><li>号码的登记和管理；</li><li>服务类型的鉴权；</li><li>用户的鉴权；</li><li>提供链路接口；</li></ol></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531210710.jpg" alt="2020-05-31_205837" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531210722.jpg" alt="2020-05-31_210158" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531210742.jpg" alt="2020-05-31_210414" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531210756.jpg" alt="2020-05-31_210611" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200531210809.jpg" alt="2020-05-31_210653" style="zoom:80%"><blockquote><p>相关签约信息及4G位置信息不是存在MME中，而是HSS。</p></blockquote><details><summary><p>所有的习题：</p></summary><div class="content"><p><a href="/2020/05/07/现代交换原理-MOOC习题-1~4章/">现代交换原理 MOOC习题 1~4章</a></p><p><a href="/2020/05/18/现代交换原理-MOOC习题-5~6章/">现代交换原理 MOOC习题 5~6章</a></p></div></details>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;自己随便整理了一下在学习“现代交换原理”网课时遇到的一些习题，易错点之类的。接上文&lt;a href=&quot;/2020/05/07/现代交换原理-MOOC习题-1~4章/&quot;&gt;现代交换原理 MOOC习题 1~4章&lt;/a&gt;。&lt;/p&gt;
    
    </summary>
    
    
      <category term="现代交换原理" scheme="https://666wxy666.github.io/categories/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/"/>
    
      <category term="习题" scheme="https://666wxy666.github.io/categories/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/%E4%B9%A0%E9%A2%98/"/>
    
    
      <category term="习题" scheme="https://666wxy666.github.io/tags/%E4%B9%A0%E9%A2%98/"/>
    
      <category term="易错点" scheme="https://666wxy666.github.io/tags/%E6%98%93%E9%94%99%E7%82%B9/"/>
    
      <category term="网课" scheme="https://666wxy666.github.io/tags/%E7%BD%91%E8%AF%BE/"/>
    
      <category term="MOOC" scheme="https://666wxy666.github.io/tags/MOOC/"/>
    
      <category term="现代交换原理" scheme="https://666wxy666.github.io/tags/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Linux 上机实战2 遍历目录</title>
    <link href="https://666wxy666.github.io/2020/05/08/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%982-%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95/"/>
    <id>https://666wxy666.github.io/2020/05/08/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%982-%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95/</id>
    <published>2020-05-08T14:10:54.416Z</published>
    <updated>2020-06-14T02:16:50.897Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>本文是关于Linux中的ls的简化版，遍历目录小程序。</strong></p><a id="more"></a><h2 id="一、题目要求"><a href="#一、题目要求" class="headerlink" title="一、题目要求"></a>一、题目要求</h2><p><strong>编程实现程序list.c，列表普通磁盘文件，包括文件名和文件大小。</strong></p><ol><li>使用vi编辑文件，熟悉工具vi。</li><li>使用Linux的系统调用和库函数。</li><li>体会Shell文件通配符的处理方式以及命令对选项的处理方式。</li></ol><p><strong>对选项的处理，自行编程逐个分析命令行参数。不考虑多选项挤在一个命令行<br>参数内的情况。</strong></p><p><strong>与ls命令类似，处理对象可以有0到多个</strong></p><ul><li><p>0个：列出当前目录下所有文件</p></li><li><p>普通文件：列出文件</p></li><li><p>目录：列出目录下所有文件</p></li></ul><p><strong>实现自定义选项r,a,l,h,m以及–</strong></p><ul><li>r 递归方式列出子目录（每项要含路径，类似find的-print输出风格，需<br>要设计递归程序）</li><li>a 列出文件名第一个字符为圆点的普通文件（默认情况下不列出文件名<br>首字符为圆点的文件）</li><li>l 后跟一整数，限定文件大小的最小值（字节）</li><li>h 后跟一整数，限定文件大小的最大值（字节）</li><li>m 后跟一整数n，限定文件的最近修改时间必须在n天内</li><li>– 显式地终止命令选项分析</li></ul><p><strong>编辑，编译</strong></p><ul><li>vi list.c</li><li>make list 或者gcc list.c –o list</li></ul><p><strong>运行举例</strong></p><ul><li>./list –l 100 –h 5000 /bin /etc 列出大小在100~5000之间的文件</li><li>./list –a -r -l 50000 –m 2 递归式列出当前目录树下大小超50KB且2天内修改过的文件（包括文件名首字符为圆点的文件）</li><li>./list – -l</li><li>./list *</li></ul><h2 id="二、基本步骤"><a href="#二、基本步骤" class="headerlink" title="二、基本步骤"></a>二、基本步骤</h2><ol><li>使用<strong><em>Xshell</em></strong>登录到Ubuntu服务器</li></ol><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413160150.jpg" alt="2020-04-13_160129" style="zoom:67%"><ol start="2"><li><p>开始编写代码<strong><em>list.c</em></strong>：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim list.c</span><br></pre></td></tr></table></figure></li><li><p>编写代码（代码源码见附件list.c和list2.c和本文最后的附录）</p></li></ol><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413160407.jpg" alt="2020-04-13_160309" style="zoom:67%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413160427.jpg" alt="2020-04-13_160349" style="zoom:67%"><ol start="4"><li><p>编写完成后保存退出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:wq</span><br></pre></td></tr></table></figure></li><li><p>编译</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall list.c -o list</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall list2.c -o list2</span><br></pre></td></tr></table></figure></li></ol><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413160759.jpg" alt="2020-04-13_160739"><h2 id="三、测试样例"><a href="#三、测试样例" class="headerlink" title="三、测试样例"></a>三、测试样例</h2><h3 id="1、说明（重要）"><a href="#1、说明（重要）" class="headerlink" title="1、说明（重要）"></a><strong><em>1、说明（重要）</em></strong></h3><p><strong><em>v1.0是基本要求，但是在基础要求上增加了</em></strong>：</p><ul><li>-？帮助选项</li><li>-d 详细模式选项，类似ls命令，可以显示权限，类型，link数，所有者，修改日期，路径……</li><li>选项在路径之前和之后均可分析</li><li>不同种类的文件分不同颜色显示：白色为普通磁盘文件，黄色为目录文件，青色为其他文件，红色为ERROR</li><li>完备的差错控制，从分析指令到执行指令阶段，均有完善的差错控制。在执行阶段遇到的文件权限等非致命错误不会打断程序的运行，程序会在屏幕上输出错误信息后继续读取下面的文件</li></ul><p><strong><em>v2.0是在v1.0的基础上进行修改的版本，除保留有v1.0的全部功能外，又增加了：</em></strong></p><ul><li>支持输入长选项（具体使用请使用–help或-？查看）</li><li>支持长短选项混合</li></ul><h3 id="2、测试样例"><a href="#2、测试样例" class="headerlink" title="2、测试样例"></a>2、测试样例</h3><h4 id="①帮助"><a href="#①帮助" class="headerlink" title="①帮助"></a>①帮助</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -?</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413161225.jpg" alt="2020-04-13_161216" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 -?</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413161333.jpg" alt="2020-04-13_161323" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 --help</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413161419.jpg" alt="2020-04-13_161411" style="zoom:80%"><h4 id="②正常运行"><a href="#②正常运行" class="headerlink" title="②正常运行"></a>②正常运行</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -l 100 -h 5000 /bin /etc</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413161518.jpg" alt="2020-04-13_161128" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 -low=100 -high=5000 /bin /etc</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413161840.jpg" alt="2020-04-13_161825" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -a -r -l 50000 -m 2</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413163601.jpg" alt="2020-04-13_163455" style="zoom:67%"><p>也可以混合输入长短选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 --all --r --low=50000 -m 2</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/2020041316373.jpg" alt="2020-04-13_163646" style="zoom:67%"><p>使用–终止选项分析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -- -l</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413164245.jpg" alt="2020-04-13_164002" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 -- -l</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413164302.jpg" alt="2020-04-13_164044" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list *</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413164504.jpg" alt="2020-04-13_164426" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 *</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413164514.jpg" alt="2020-04-13_164443" style="zoom:67%"><p>增加的-d(–detail)功能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -d -a</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413165924.jpg" alt="2020-04-13_165909" style="zoom:67%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 --detail --recursive</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170102.jpg" alt="2020-04-13_170054" style="zoom:67%"><h4 id="③出错处理"><a href="#③出错处理" class="headerlink" title="③出错处理"></a>③出错处理</h4><p>两个版本的出错控制基本一致，就不对每一个命令都展示两个版本了</p><p>例如输错了选项</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list -la /home/wxy</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413165459.jpg" alt="2020-04-13_165447" style="zoom:67%"><p>-h后面没有参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list /home/wxy -h</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170152.jpg" alt="2020-04-13_170142" style="zoom:67%"><p>-l后面虽然有参数，但是不是整数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 --low=abc /home/wxy</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170255.jpg" alt="2020-04-13_170248" style="zoom:67%"><p>长选项格式输入错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 -l=12a</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170339.jpg" alt="2020-04-13_170328" style="zoom:67%"><p>长选项格式输入错误</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 --m1abc</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170450.jpg" alt="2020-04-13_170443" style="zoom:67%"><p>路径不存在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list /12345</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170535.jpg" alt="2020-04-13_170527"></p><p>没有权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./list2 /root -all -recursive</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200413170649.jpg" alt="2020-04-13_170614"></p><p>等等情况，不再一一展示</p><h2 id="四、附录"><a href="#四、附录" class="headerlink" title="四、附录"></a>四、附录</h2><p><strong><em>PS:程序源码均有详细的注释</em></strong></p><h3 id="1、list-c"><a href="#1、list-c" class="headerlink" title="1、list.c"></a>1、list.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: 列表Linux文件，在Ubuntu 18.04上进行的编程</span></span><br><span class="line"><span class="comment"> * @Version: 1.0</span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-04-09 17:57:29</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-04-13 14:08:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//颜色</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NONE <span class="meta-string">"\e[0m"</span>      <span class="comment">//复原</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED <span class="meta-string">"\e[0;31m"</span>    <span class="comment">//ERROR</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> YELLOW <span class="meta-string">"\e[0;33m"</span> <span class="comment">//目录</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN <span class="meta-string">"\e[0;36m"</span>   <span class="comment">//除普通文件和目录文件外的文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OPTION_NUM 7      <span class="comment">//选项种类数目（除'--'以外）</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//****************选项枚举****************</span></span><br><span class="line"><span class="keyword">enum</span> OPT</span><br><span class="line">&#123;</span><br><span class="line">    _r,    <span class="comment">//-r 递归方式列出子目录</span></span><br><span class="line">    _a,    <span class="comment">//-a 列出文件名第一个字符为圆点的普通文件</span></span><br><span class="line">    _d,    <span class="comment">//-d 展示文件的详细信息（默认只展示文件路径）</span></span><br><span class="line">    _l,    <span class="comment">//-l 后跟一整数，限定文件大小的最小值（字节）</span></span><br><span class="line">    _h,    <span class="comment">//-h 后跟一整数，限定文件大小的最大值（字节）</span></span><br><span class="line">    _m,    <span class="comment">//-m 后跟一整数n，限定文件的最近修改时间必须在n天内</span></span><br><span class="line">    _help, <span class="comment">//-? 显示帮助</span></span><br><span class="line">&#125; opt;</span><br><span class="line"><span class="comment">//-- 显式地终止命令选项分析</span></span><br><span class="line"><span class="comment">//**************************************</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> split[] = <span class="string">"****************************************\n"</span>; <span class="comment">//分割线</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> version[] = <span class="string">"1.0"</span>;     <span class="comment">//版本号</span></span><br><span class="line"><span class="keyword">char</span> **path;                <span class="comment">//路径</span></span><br><span class="line"><span class="keyword">int</span> path_num = <span class="number">0</span>;           <span class="comment">//用于记录路径的数目</span></span><br><span class="line"><span class="keyword">int</span> opts[OPTION_NUM] = &#123;<span class="number">0</span>&#125;; <span class="comment">//用来存储选项是否开启，数组的每个位置对应相应选项，值为0表示未开启，为1表示开启</span></span><br><span class="line"><span class="keyword">long</span> max_size = <span class="number">0</span>;          <span class="comment">//最大文件尺寸</span></span><br><span class="line"><span class="keyword">long</span> min_size = <span class="number">0</span>;          <span class="comment">//最小文件尺寸</span></span><br><span class="line"><span class="keyword">time_t</span> limit_day = <span class="number">0</span>;       <span class="comment">//最早修改在几天前</span></span><br><span class="line"><span class="keyword">time_t</span> current_time = <span class="number">0</span>;    <span class="comment">//当前系统时间</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_path</span><span class="params">()</span></span>;                                 <span class="comment">//释放path分配的空间</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span>;                                      <span class="comment">//打印帮助信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">analyse_input</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span>; <span class="comment">//分析输入的命令的函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_analyse_result</span><span class="params">()</span></span>;                       <span class="comment">//输出命令解析的结果</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">char</span> *path)</span></span>;                             <span class="comment">//对一个路径按照选项运行命令</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_mode</span><span class="params">(<span class="keyword">mode_t</span> mode)</span></span>;                      <span class="comment">//输出文件的权限及文件类型（用于-d选项中）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(struct stat st, <span class="keyword">char</span> *path)</span></span>;            <span class="comment">//展示文件信息</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    time(&amp;current_time);       <span class="comment">//获取指令执行时的时间</span></span><br><span class="line">    analyse_input(argc, argv); <span class="comment">//分析用户的输入</span></span><br><span class="line">    <span class="comment">//用户加了帮助选项，输出帮助信息后退出</span></span><br><span class="line">    <span class="keyword">if</span> (opts[_help])</span><br><span class="line">    &#123;</span><br><span class="line">        help();</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用户没有帮助选项，输出命令解析的结果并运行该命令</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        show_analyse_result();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">run</span>(path[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free_path();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: free_path</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 释放path分配的空间</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_path</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">        <span class="built_in">free</span>(path[i]);</span><br><span class="line">    <span class="built_in">free</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: help</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 打印帮助信息</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%18sHELP%18s\n%s"</span>, <span class="string">""</span>, <span class="string">""</span>, split);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"List %s by 苇名一心 Apr 10 2020\n"</span>, version);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./list [OPTION]... [PATH]...\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"List informaton about the FILEs in these PATHs(the current directory by default)\nOptions:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-r\t\tList subdirectories recursively\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-a\t\tDo not hide entries starting with .\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-d\t\tShow detail information of file(only file path by default)\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-l &lt;bytes&gt;\tMinmum of file size\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-h &lt;bytes&gt;\tMaxmum of file size\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-m &lt;days&gt;\tLimit file last changed time\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-?\t\tDisplay this help and exit\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Color:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\tWHITE: Regular file\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(YELLOW <span class="string">"\tYELLOW: Directory file\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(CYAN <span class="string">"\tCYAN: Other file\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(RED <span class="string">"\tRED: Error\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: analyse_input</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 分析输入的命令的函数</span></span><br><span class="line"><span class="comment"> * @param: 同main函数</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">analyse_input</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    path = (<span class="keyword">char</span> **)<span class="built_in">malloc</span>(argc * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">1</span>; <span class="comment">//记录选项分析是否终止，终止为0，未终止为1</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//以-开头的是选项</span></span><br><span class="line">        <span class="keyword">if</span> (flag &amp;&amp; argv[i][<span class="number">0</span>] == <span class="string">'-'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                help();</span><br><span class="line">                free_path();</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) == <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (argv[i][<span class="number">1</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">                    opts[_r] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">                    opts[_a] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">                    opts[_d] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'l'</span>:</span><br><span class="line">                    opts[_l] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-l选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            min_size = <span class="built_in">size</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -l wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -l wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">                    opts[_h] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-h选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            max_size = <span class="built_in">size</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -h wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -h wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'m'</span>:</span><br><span class="line">                    opts[_m] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-m选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> day = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            limit_day = day;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -m wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -m wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">                    opts[_help] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">                    flag = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                    help();</span><br><span class="line">                    free_path();</span><br><span class="line">                    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                help();</span><br><span class="line">                free_path();</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//不是-开头的认为是路径或者--后面的全部认为是路径</span></span><br><span class="line">            path[path_num] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(argv[i]) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">            <span class="built_in">strcpy</span>(path[path_num++], argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts[_l] &amp;&amp; opts[_h])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (min_size &gt; max_size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Min size of file is less than Max size of file, please input the right option\n"</span> NONE);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">            help();</span><br><span class="line">            free_path();</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有输入路径，默认为当前工作目录</span></span><br><span class="line">    <span class="keyword">if</span> (path_num == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        path[path_num] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">255</span>);</span><br><span class="line">        <span class="keyword">if</span> (!getcwd(path[path_num++], <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">255</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Get current work path wrong\n"</span> NONE);</span><br><span class="line">            free_path();</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show_analyse_result</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 输出命令解析的结果</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_analyse_result</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Input Analyse Results are:\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; OPTION_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (i)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> _r:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-r: True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-r: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _a:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-a: True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-a: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _d:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-d: True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-d: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _l:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-l: True\tMin Size:%ld\n"</span>, min_size);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-l: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _h:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-h: True\tMax Size:%ld\n"</span>, max_size);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-h: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _m:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-m: True\tLimit Day:%ld\n"</span>, limit_day);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-m: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _help:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-?: True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-?: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Unknown error, please consult me\n"</span> NONE);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Path Count is: %d\nPath:\n"</span>, path_num);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, path[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: run</span></span><br><span class="line"><span class="comment"> * @msg: 对一个路径按照选项运行命令</span></span><br><span class="line"><span class="comment"> * @param： path为这个路径</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">char</span> *path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span>         <span class="comment">//stat结构体</span></span><br><span class="line">    DIR *dir;               <span class="comment">//目录句柄</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span>   <span class="comment">//dirent结构体</span></span><br><span class="line">    <span class="keyword">char</span> current_path[<span class="number">255</span>]; <span class="comment">//当前的路径，最长255</span></span><br><span class="line">    <span class="comment">//note:一定要用lstat，否则可能会出现有些文件打不开的情况，下面同理</span></span><br><span class="line">    <span class="keyword">int</span> ret = lstat(path, &amp;st); <span class="comment">//取出当前路径的i节点信息</span></span><br><span class="line">    <span class="comment">//成功获取stat</span></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果是目录</span></span><br><span class="line">        <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//打开目录</span></span><br><span class="line">            dir = opendir(path);</span><br><span class="line">            <span class="comment">//打开失败</span></span><br><span class="line">            <span class="keyword">if</span> (dir == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] open dir \"%s\": %s\n"</span> NONE, errno, path, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//打开成功</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                entry = readdir(dir);</span><br><span class="line">                <span class="comment">//只要没有读到目录尾就一直读</span></span><br><span class="line">                <span class="keyword">while</span> (entry != <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//去掉目录中的.和..</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">"."</span>) != <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">".."</span>) != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//构造当前目录下各文件路径</span></span><br><span class="line">                        <span class="built_in">strcpy</span>(current_path, path);</span><br><span class="line">                        <span class="comment">//忽略路径最后一个字符为‘/’</span></span><br><span class="line">                        <span class="keyword">if</span> (current_path[<span class="built_in">strlen</span>(current_path) - <span class="number">1</span>] != <span class="string">'/'</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">strcat</span>(current_path, <span class="string">"/"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">strcat</span>(current_path, entry-&gt;d_name);</span><br><span class="line">                        <span class="comment">//获取当前目录下面各文件的stat</span></span><br><span class="line">                        ret = lstat(current_path, &amp;st);</span><br><span class="line">                        <span class="comment">//成功获取stat</span></span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//输出</span></span><br><span class="line">                            <span class="comment">//是否显示.开头的文件(包括目录文件)</span></span><br><span class="line">                            <span class="keyword">if</span> (opts[_a] || entry-&gt;d_name[<span class="number">0</span>] != <span class="string">'.'</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                show(st, current_path);</span><br><span class="line">                                <span class="comment">//如果还是目录并且指定了选项-r，则进行递归</span></span><br><span class="line">                                <span class="comment">//也就是说current_path一定是目录</span></span><br><span class="line">                                <span class="keyword">if</span> (S_ISDIR(st.st_mode) &amp;&amp; opts[_r])</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="built_in">run</span>(current_path);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//失败输出错误信息</span></span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] read file \"%s\": %s\n"</span> NONE, errno, current_path, strerror(errno));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//继续读下一个</span></span><br><span class="line">                    entry = readdir(dir);</span><br><span class="line">                &#125;</span><br><span class="line">                closedir(dir);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果是文件，直接打印</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            show(st, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//失败输出错误信息</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] read file \"%s\": %s\n"</span> NONE, errno, path, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show_mode</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: //输出文件的权限及文件类型（用于-d选项中）</span></span><br><span class="line"><span class="comment"> * @param：mode_t mode，文件的mode </span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_mode</span><span class="params">(<span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"----------"</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(mode))</span><br><span class="line">        str[pos] = <span class="string">'-'</span>; <span class="comment">//普通文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISBLK(mode))</span><br><span class="line">        str[pos] = <span class="string">'b'</span>; <span class="comment">//块设备文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISDIR(mode))</span><br><span class="line">        str[pos] = <span class="string">'d'</span>; <span class="comment">//目录文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISCHR(mode))</span><br><span class="line">        str[pos] = <span class="string">'c'</span>; <span class="comment">//字符设备文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISLNK(mode))</span><br><span class="line">        str[pos] = <span class="string">'l'</span>; <span class="comment">//符号连接文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISFIFO(mode))</span><br><span class="line">        str[pos] = <span class="string">'p'</span>; <span class="comment">//命名管道文件</span></span><br><span class="line">    <span class="comment">//按位取与，获得文件所有者权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IRUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="comment">//按位取与，获得同组用户权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IRGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="comment">//按位取与，获得其他用户权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IROTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWOTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXOTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 展示文件信息</span></span><br><span class="line"><span class="comment"> * @param: st为文件stat结构体，path为文件路径 </span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(struct stat st, <span class="keyword">char</span> *path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//是否对文件大小最小值有要求</span></span><br><span class="line">    <span class="comment">//如果opts[_l]为1，说明有要求，!opts[_l]=0</span></span><br><span class="line">    <span class="comment">//0||st.st_size &gt; min_size=st.st_size &gt; min_size</span></span><br><span class="line">    <span class="comment">//因此刚好可以限制文件大小</span></span><br><span class="line">    <span class="comment">//如果opts[_l]为0，说明没有要求，!opts[_l]=1</span></span><br><span class="line">    <span class="comment">//1||st.st_size &gt; min_size=1</span></span><br><span class="line">    <span class="comment">//因此限制无效，直接通过，没有限制文件大小</span></span><br><span class="line">    <span class="comment">//以下其他命令同理</span></span><br><span class="line">    <span class="keyword">if</span> (!opts[_l] || st.st_size &gt;= min_size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//是否对文件大小最大值有要求</span></span><br><span class="line">        <span class="keyword">if</span> (!opts[_h] || st.st_size &lt;= max_size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//是否对文件修改时间有要求</span></span><br><span class="line">            <span class="comment">//st_mtime域代表了文件的最近改变时间</span></span><br><span class="line">            <span class="comment">//((current_time - st.st_mtime) / (24 * 60 * 60))可以得到天数</span></span><br><span class="line">            <span class="keyword">if</span> (!opts[_m] || ((current_time - st.st_mtime) / (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>)) &lt; limit_day)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (opts[_d])</span><br><span class="line">                &#123;</span><br><span class="line">                    show_mode(st.st_mode);</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">user</span>;</span></span><br><span class="line">                    user = getpwuid(st.st_uid);</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">group</span>;</span></span><br><span class="line">                    group = getgrgid(st.st_gid);</span><br><span class="line">                    <span class="keyword">char</span> *time_str;</span><br><span class="line">                    time_str = ctime(&amp;st.st_ctime);</span><br><span class="line">                    <span class="comment">//将日期最后的'\n'去掉</span></span><br><span class="line">                    time_str[<span class="built_in">strlen</span>(time_str) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">                    <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  "</span> YELLOW <span class="string">"%s\n"</span> NONE,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  %s\n"</span>,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  "</span> CYAN <span class="string">"%s\n"</span> NONE,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(YELLOW <span class="string">"%s\n"</span> NONE, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(CYAN <span class="string">"%s\n"</span> NONE, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、list2-c"><a href="#2、list2-c" class="headerlink" title="2、list2.c"></a>2、list2.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: 列表Linux文件，在Ubuntu 18.04上进行的编程，较1.0版本增加了长选项分析的功能</span></span><br><span class="line"><span class="comment"> * @Version: 2.0</span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-04-09 17:57:29</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-04-13 14:10:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pwd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;grp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//颜色</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NONE <span class="meta-string">"\e[0m"</span>      <span class="comment">//复原</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED <span class="meta-string">"\e[0;31m"</span>    <span class="comment">//ERROR</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> YELLOW <span class="meta-string">"\e[0;33m"</span> <span class="comment">//目录</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN <span class="meta-string">"\e[0;36m"</span>   <span class="comment">//除普通文件和目录文件外的文件</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OPTION_NUM 7      <span class="comment">//选项种类数目（除'--'以外）</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//****************选项枚举****************</span></span><br><span class="line"><span class="keyword">enum</span> OPT</span><br><span class="line">&#123;</span><br><span class="line">    _r,    <span class="comment">//-r, --recursive 递归方式列出子目录</span></span><br><span class="line">    _a,    <span class="comment">//-a, --all       列出文件名第一个字符为圆点的普通文件</span></span><br><span class="line">    _d,    <span class="comment">//-d, --detail    展示文件的详细信息（默认只展示文件路径）</span></span><br><span class="line">    _l,    <span class="comment">//-l, --low       后跟一整数，限定文件大小的最小值（字节）</span></span><br><span class="line">    _h,    <span class="comment">//-h, --high      后跟一整数，限定文件大小的最大值（字节）</span></span><br><span class="line">    _m,    <span class="comment">//-m, --mdays     后跟一整数n，限定文件的最近修改时间必须在n天内</span></span><br><span class="line">    _help, <span class="comment">//-?, --help      显示帮助</span></span><br><span class="line">&#125; opt;</span><br><span class="line"><span class="comment">//-- 显式地终止命令选项分析</span></span><br><span class="line"><span class="comment">//**************************************</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> split[] = <span class="string">"****************************************\n"</span>; <span class="comment">//分割线</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> version[] = <span class="string">"2.0"</span>;     <span class="comment">//版本号</span></span><br><span class="line"><span class="keyword">char</span> **path;                <span class="comment">//路径</span></span><br><span class="line"><span class="keyword">int</span> path_num = <span class="number">0</span>;           <span class="comment">//用于记录路径的数目</span></span><br><span class="line"><span class="keyword">int</span> opts[OPTION_NUM] = &#123;<span class="number">0</span>&#125;; <span class="comment">//用来存储选项是否开启，数组的每个位置对应相应选项，值为0表示未开启，为1表示开启</span></span><br><span class="line"><span class="keyword">long</span> max_size = <span class="number">0</span>;          <span class="comment">//最大文件尺寸</span></span><br><span class="line"><span class="keyword">long</span> min_size = <span class="number">0</span>;          <span class="comment">//最小文件尺寸</span></span><br><span class="line"><span class="keyword">time_t</span> limit_day = <span class="number">0</span>;       <span class="comment">//最早修改在几天前</span></span><br><span class="line"><span class="keyword">time_t</span> current_time = <span class="number">0</span>;    <span class="comment">//当前系统时间</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_path</span><span class="params">()</span></span>;                                 <span class="comment">//释放path分配的空间</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span>;                                      <span class="comment">//打印帮助信息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">analyse_input</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span>; <span class="comment">//分析输入的命令的函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_analyse_result</span><span class="params">()</span></span>;                       <span class="comment">//输出命令解析的结果</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">char</span> *path)</span></span>;                             <span class="comment">//对一个路径按照选项运行命令</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_mode</span><span class="params">(<span class="keyword">mode_t</span> mode)</span></span>;                      <span class="comment">//输出文件的权限及文件类型（用于-d选项中）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(struct stat st, <span class="keyword">char</span> *path)</span></span>;            <span class="comment">//展示文件信息</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    time(&amp;current_time);       <span class="comment">//获取指令执行时的时间</span></span><br><span class="line">    analyse_input(argc, argv); <span class="comment">//分析用户的输入</span></span><br><span class="line">    <span class="comment">//用户加了帮助选项，输出帮助信息后退出</span></span><br><span class="line">    <span class="keyword">if</span> (opts[_help])</span><br><span class="line">    &#123;</span><br><span class="line">        help();</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用户没有帮助选项，输出命令解析的结果并运行该命令</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        show_analyse_result();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">run</span>(path[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free_path();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: free_path</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 释放path分配的空间</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_path</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">        <span class="built_in">free</span>(path[i]);</span><br><span class="line">    <span class="built_in">free</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: help</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 打印帮助信息</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">help</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%18sHELP%18s\n%s"</span>, <span class="string">""</span>, <span class="string">""</span>, split);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"List %s by 苇名一心 Apr 13 2020\n"</span>, version);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./list [OPTION]... [PATH]...\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"List informaton about the FILEs in these PATHs(the current directory by default)\nOptions:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-r, --recursive\t\tList subdirectories recursively\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-a, --all\t\tDo not hide entries starting with .\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-d, --detail\t\tShow detail information of file(only file path by default)\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-l, --low=&lt;bytes&gt;\tMinmum of file size\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-h, --high=&lt;bytes&gt;\tMaxmum of file size\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-m, --mdays=&lt;days&gt;\tLimit file last changed time\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\t-?, --help\t\tDisplay this help and exit\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Color:\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\tWHITE: Regular file\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(YELLOW <span class="string">"\tYELLOW: Directory file\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(CYAN <span class="string">"\tCYAN: Other file\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(RED <span class="string">"\tRED: Error\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: analyse_input</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 分析输入的命令的函数</span></span><br><span class="line"><span class="comment"> * @param: 同main函数</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">analyse_input</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    path = (<span class="keyword">char</span> **)<span class="built_in">malloc</span>(argc * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">1</span>; <span class="comment">//记录选项分析是否终止，终止为0，未终止为1</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//以-开头的是选项</span></span><br><span class="line">        <span class="keyword">if</span> (flag &amp;&amp; argv[i][<span class="number">0</span>] == <span class="string">'-'</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                help();</span><br><span class="line">                free_path();</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) == <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (argv[i][<span class="number">1</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'r'</span>:</span><br><span class="line">                    opts[_r] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">                    opts[_a] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">                    opts[_d] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'l'</span>:</span><br><span class="line">                    opts[_l] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-l选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            min_size = <span class="built_in">size</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -l wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -l wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'h'</span>:</span><br><span class="line">                    opts[_h] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-h选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            max_size = <span class="built_in">size</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -h wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -h wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'m'</span>:</span><br><span class="line">                    opts[_m] = <span class="number">1</span>;</span><br><span class="line">                    <span class="comment">//判断-m选项后面有没有参数</span></span><br><span class="line">                    <span class="keyword">if</span> (i &lt; argc - <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                        <span class="keyword">long</span> <span class="keyword">int</span> day = strtol(argv[++i], &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                        <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            limit_day = day;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -m wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option -m wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'?'</span>:</span><br><span class="line">                    opts[_help] = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> <span class="string">'-'</span>:</span><br><span class="line">                    flag = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                    help();</span><br><span class="line">                    free_path();</span><br><span class="line">                    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//长度&gt;2的情况，也就是长选项</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strchr</span>(argv[i], <span class="string">'='</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[i], <span class="string">"--low="</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_l] = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//判断--low选项后面有没有参数</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) &gt; <span class="number">6</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                            <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[i] + <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">6</span>, &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                            <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                min_size = <span class="built_in">size</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --low wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                                help();</span><br><span class="line">                                free_path();</span><br><span class="line">                                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --low wrong, there is no required min size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[i], <span class="string">"--high="</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_h] = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//判断--high选项后面有没有参数</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) &gt; <span class="number">7</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                            <span class="keyword">long</span> <span class="keyword">int</span> <span class="built_in">size</span> = strtol(argv[i] + <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">7</span>, &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                            <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                max_size = <span class="built_in">size</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --high wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                                help();</span><br><span class="line">                                free_path();</span><br><span class="line">                                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --high wrong, there is no required max size, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[i], <span class="string">"--mdays="</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_m] = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">//判断--mdays选项后面有没有参数</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[i]) &gt; <span class="number">8</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">char</span> *<span class="built_in">stop</span>;</span><br><span class="line">                            <span class="keyword">long</span> <span class="keyword">int</span> day = strtol(argv[i] + <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">8</span>, &amp;<span class="built_in">stop</span>, <span class="number">10</span>);</span><br><span class="line">                            <span class="comment">//stop长度为0代表进行了有效的转换</span></span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">strlen</span>(<span class="built_in">stop</span>) == <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                limit_day = day;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --mdays wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                                help();</span><br><span class="line">                                free_path();</span><br><span class="line">                                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option --mdays wrong, there is no required limit day, please input the right option\n"</span> NONE);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                            help();</span><br><span class="line">                            free_path();</span><br><span class="line">                            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"--recursive"</span>, argv[i]) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_r] = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"--all"</span>, argv[i]) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_a] = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"--detail"</span>, argv[i]) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_d] = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">"--help"</span>, argv[i]) == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        opts[_help] = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(RED <span class="string">"ERROR: Input option wrong, please input the right option\n"</span> NONE);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">                        help();</span><br><span class="line">                        free_path();</span><br><span class="line">                        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//不是-开头的认为是路径或者--后面的全部认为是路径</span></span><br><span class="line">            path[path_num] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(argv[i]) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">            <span class="built_in">strcpy</span>(path[path_num++], argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts[_l] &amp;&amp; opts[_h])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (min_size &gt; max_size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Min size of file is less than Max size of file, please input the right option\n"</span> NONE);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Here are some tips:\n"</span>);</span><br><span class="line">            help();</span><br><span class="line">            free_path();</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//没有输入路径，默认为当前工作目录</span></span><br><span class="line">    <span class="keyword">if</span> (path_num == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        path[path_num] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">255</span>);</span><br><span class="line">        <span class="keyword">if</span> (!getcwd(path[path_num++], <span class="keyword">sizeof</span>(<span class="keyword">char</span>) * <span class="number">255</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Get current work path wrong\n"</span> NONE);</span><br><span class="line">            free_path();</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show_analyse_result</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 输出命令解析的结果</span></span><br><span class="line"><span class="comment"> * @param: 无</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_analyse_result</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Input Analyse Results are:\n"</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; OPTION_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (i)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> _r:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-r, --recursive: True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-r, --recursive: False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _a:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-a, --all:\t True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-a, --all:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _d:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-d, --detail:\t True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-d, --detail:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _l:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-l, --low:\t True\tMin Size:%ld\n"</span>, min_size);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-l, --low:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _h:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-h, --high:\t True\tMax Size:%ld\n"</span>, max_size);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-h, --high:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _m:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-m, --mdays:\t True\tLimit Day:%ld\n"</span>, limit_day);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-m, --mdays:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _help:</span><br><span class="line">            <span class="keyword">if</span> (opts[i])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-?, --help:\t True\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"-?, --help:\t False\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(RED <span class="string">"ERROR: Unknown error, please consult me\n"</span> NONE);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Path Count is: %d\nPath:\n"</span>, path_num);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; path_num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, path[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, split);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: run</span></span><br><span class="line"><span class="comment"> * @msg: 对一个路径按照选项运行命令</span></span><br><span class="line"><span class="comment"> * @param： path为这个路径</span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">char</span> *path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span>         <span class="comment">//stat结构体</span></span><br><span class="line">    DIR *dir;               <span class="comment">//目录句柄</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span>   <span class="comment">//dirent结构体</span></span><br><span class="line">    <span class="keyword">char</span> current_path[<span class="number">255</span>]; <span class="comment">//当前的路径，最长255</span></span><br><span class="line">    <span class="comment">//note:一定要用lstat，否则可能会出现有些文件打不开的情况，下面同理</span></span><br><span class="line">    <span class="keyword">int</span> ret = lstat(path, &amp;st); <span class="comment">//取出当前路径的i节点信息</span></span><br><span class="line">    <span class="comment">//成功获取stat</span></span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果是目录</span></span><br><span class="line">        <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//打开目录</span></span><br><span class="line">            dir = opendir(path);</span><br><span class="line">            <span class="comment">//打开失败</span></span><br><span class="line">            <span class="keyword">if</span> (dir == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] open dir \"%s\": %s\n"</span> NONE, errno, path, strerror(errno));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//打开成功</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                entry = readdir(dir);</span><br><span class="line">                <span class="comment">//只要没有读到目录尾就一直读</span></span><br><span class="line">                <span class="keyword">while</span> (entry != <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//去掉目录中的.和..</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">"."</span>) != <span class="number">0</span> &amp;&amp; <span class="built_in">strcmp</span>(entry-&gt;d_name, <span class="string">".."</span>) != <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//构造当前目录下各文件路径</span></span><br><span class="line">                        <span class="built_in">strcpy</span>(current_path, path);</span><br><span class="line">                        <span class="comment">//忽略路径最后一个字符为‘/’</span></span><br><span class="line">                        <span class="keyword">if</span> (current_path[<span class="built_in">strlen</span>(current_path) - <span class="number">1</span>] != <span class="string">'/'</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">strcat</span>(current_path, <span class="string">"/"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">strcat</span>(current_path, entry-&gt;d_name);</span><br><span class="line">                        <span class="comment">//获取当前目录下面各文件的stat</span></span><br><span class="line">                        ret = lstat(current_path, &amp;st);</span><br><span class="line">                        <span class="comment">//成功获取stat</span></span><br><span class="line">                        <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//输出</span></span><br><span class="line">                            <span class="comment">//是否显示.开头的文件(包括目录文件)</span></span><br><span class="line">                            <span class="keyword">if</span> (opts[_a] || entry-&gt;d_name[<span class="number">0</span>] != <span class="string">'.'</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                                show(st, current_path);</span><br><span class="line">                                <span class="comment">//如果还是目录并且指定了选项-r，则进行递归</span></span><br><span class="line">                                <span class="comment">//也就是说current_path一定是目录</span></span><br><span class="line">                                <span class="keyword">if</span> (S_ISDIR(st.st_mode) &amp;&amp; opts[_r])</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="built_in">run</span>(current_path);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//失败输出错误信息</span></span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] read file \"%s\": %s\n"</span> NONE, errno, current_path, strerror(errno));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//继续读下一个</span></span><br><span class="line">                    entry = readdir(dir);</span><br><span class="line">                &#125;</span><br><span class="line">                closedir(dir);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果是文件，直接打印</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            show(st, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//失败输出错误信息</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(RED <span class="string">"ERROR[%d] read file \"%s\": %s\n"</span> NONE, errno, path, strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show_mode</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: //输出文件的权限及文件类型（用于-d选项中）</span></span><br><span class="line"><span class="comment"> * @param：mode_t mode，文件的mode </span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_mode</span><span class="params">(<span class="keyword">mode_t</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> str[] = <span class="string">"----------"</span>;</span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(mode))</span><br><span class="line">        str[pos] = <span class="string">'-'</span>; <span class="comment">//普通文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISBLK(mode))</span><br><span class="line">        str[pos] = <span class="string">'b'</span>; <span class="comment">//块设备文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISDIR(mode))</span><br><span class="line">        str[pos] = <span class="string">'d'</span>; <span class="comment">//目录文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISCHR(mode))</span><br><span class="line">        str[pos] = <span class="string">'c'</span>; <span class="comment">//字符设备文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISLNK(mode))</span><br><span class="line">        str[pos] = <span class="string">'l'</span>; <span class="comment">//符号连接文件</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISFIFO(mode))</span><br><span class="line">        str[pos] = <span class="string">'p'</span>; <span class="comment">//命名管道文件</span></span><br><span class="line">    <span class="comment">//按位取与，获得文件所有者权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IRUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXUSR &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="comment">//按位取与，获得同组用户权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IRGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXGRP &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="comment">//按位取与，获得其他用户权限</span></span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IROTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'r'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IWOTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'w'</span>;</span><br><span class="line">    pos++;</span><br><span class="line">    <span class="keyword">if</span> (S_IXOTH &amp; mode)</span><br><span class="line">        str[pos] = <span class="string">'x'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name: show</span></span><br><span class="line"><span class="comment"> * @author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @msg: 展示文件信息</span></span><br><span class="line"><span class="comment"> * @param: st为文件stat结构体，path为文件路径 </span></span><br><span class="line"><span class="comment"> * @return: 无</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(struct stat st, <span class="keyword">char</span> *path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//是否对文件大小最小值有要求</span></span><br><span class="line">    <span class="comment">//如果opts[_l]为1，说明有要求，!opts[_l]=0</span></span><br><span class="line">    <span class="comment">//0||st.st_size &gt; min_size=st.st_size &gt; min_size</span></span><br><span class="line">    <span class="comment">//因此刚好可以限制文件大小</span></span><br><span class="line">    <span class="comment">//如果opts[_l]为0，说明没有要求，!opts[_l]=1</span></span><br><span class="line">    <span class="comment">//1||st.st_size &gt; min_size=1</span></span><br><span class="line">    <span class="comment">//因此限制无效，直接通过，没有限制文件大小</span></span><br><span class="line">    <span class="comment">//以下其他命令同理</span></span><br><span class="line">    <span class="keyword">if</span> (!opts[_l] || st.st_size &gt;= min_size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//是否对文件大小最大值有要求</span></span><br><span class="line">        <span class="keyword">if</span> (!opts[_h] || st.st_size &lt;= max_size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//是否对文件修改时间有要求</span></span><br><span class="line">            <span class="comment">//st_mtime域代表了文件的最近改变时间</span></span><br><span class="line">            <span class="comment">//((current_time - st.st_mtime) / (24 * 60 * 60))可以得到天数</span></span><br><span class="line">            <span class="keyword">if</span> (!opts[_m] || ((current_time - st.st_mtime) / (<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>)) &lt; limit_day)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (opts[_d])</span><br><span class="line">                &#123;</span><br><span class="line">                    show_mode(st.st_mode);</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">user</span>;</span></span><br><span class="line">                    user = getpwuid(st.st_uid);</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">group</span>;</span></span><br><span class="line">                    group = getgrgid(st.st_gid);</span><br><span class="line">                    <span class="keyword">char</span> *time_str;</span><br><span class="line">                    time_str = ctime(&amp;st.st_ctime);</span><br><span class="line">                    <span class="comment">//将日期最后的'\n'去掉</span></span><br><span class="line">                    time_str[<span class="built_in">strlen</span>(time_str) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">                    <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  "</span> YELLOW <span class="string">"%s\n"</span> NONE,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  %s\n"</span>,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%5lu  %-10s%-10s%-15ld%s  "</span> CYAN <span class="string">"%s\n"</span> NONE,</span><br><span class="line">                               st.st_nlink, user-&gt;pw_name, group-&gt;gr_name, st.st_size, time_str, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (S_ISDIR(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(YELLOW <span class="string">"%s\n"</span> NONE, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(st.st_mode))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(CYAN <span class="string">"%s\n"</span> NONE, path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;本文是关于Linux中的ls的简化版，遍历目录小程序。&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/categories/Linux/"/>
    
      <category term="上机实战" scheme="https://666wxy666.github.io/categories/Linux/%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/tags/Linux/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="ls" scheme="https://666wxy666.github.io/tags/ls/"/>
    
      <category term="遍历目录" scheme="https://666wxy666.github.io/tags/%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>Linux 上机实战3 shell脚本程序设计</title>
    <link href="https://666wxy666.github.io/2020/05/08/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%983-shell%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    <id>https://666wxy666.github.io/2020/05/08/Linux-%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%983-shell%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/</id>
    <published>2020-05-08T14:10:54.414Z</published>
    <updated>2020-05-21T14:17:53.842Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>本文是关于Linux中的shell脚本程序设计，有几个小Demo。</strong></p><a id="more"></a><h2 id="一、题目要求"><a href="#一、题目要求" class="headerlink" title="一、题目要求"></a>一、题目要求</h2><h3 id="1、生成TCP-活动状况报告"><a href="#1、生成TCP-活动状况报告" class="headerlink" title="1、生成TCP 活动状况报告"></a>1、生成TCP 活动状况报告</h3><p>​ netstat –statistics 命令可以列出tcp等协议的统计信息。编写 shell 脚本程序，每隔1分钟生成1行信息：当前时间；这一分钟内 TCP 发送了多少报文；接收了多少报文；收发报文总数；行尾给出符号+或-或空格（+表示这分钟收发报文数比上分钟多10包以上，差别在 10 包或以内用空格，否则用符号-）。</p><p>运行示例如下：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501212725.jpg" alt="2020-05-01_212705" style="zoom:80%"><h3 id="2、下载bing-图库中图片"><a href="#2、下载bing-图库中图片" class="headerlink" title="2、下载bing 图库中图片"></a>2、下载bing 图库中图片</h3><p>​ 编写脚本程序bing.sh ，将访问<a href="https://bing.ioliu.cn/?p=23" target="_blank" rel="external nofollow noopener noreferrer">这个图库</a>中照片全部下载下来存放到本地 bing 目录中，上面 URL 中p=23 可以换成 p=1 到p=126 可访问 126 个页，每页有 12 个图，每个图的日期，中文说明信息和下载地址及文件名 html 文件中可提取。要求下载后的文件命名为“ 日期 中文说明 .jpg ”</p><p>例如</p><p>2019-08-03 野花草甸上的一只欧亚雕鸮，德国莱茵兰 普法尔茨 .jpg</p><ul><li><p>命令行参数<br>./bing.sh 后面可以跟两个参数，通过指定页号区间限定下载范围，没有参数时页号区间为 1-126。</p></li><li><p>要允许多个程序并发</p><p>例如：一个终端上启动 ./bing.sh 1 63 ，另一个终端上启动 ./bing.sh 64 126 ，这样在两个终端上同时下载，以加快任务完成的速度。</p></li><li><p>不重复下载已下载的图片</p><p>检查图片是否已下载，如果已下载，则不再下载，这样在一定程度上支持批量任务在被中断后可以从断点继续。</p></li><li><p>考虑下载文件出现故障的情况</p><p>如果一 个图片有 5MB ，接收 1.5MB 后网络断开，则残存一个不完整的图片文件。避免这种现象发生的一种方法是， wget 下载时使用一个临时文件名。判断 wget 是否成功，若成功则将文件改名为正式名称；若失败，删除临时文件。临时文件名的选取要考虑前述的并发问题，至少不可以固定一个名字导致两进程的争夺。</p></li></ul><h3 id="3、选做：获取更多图片"><a href="#3、选做：获取更多图片" class="headerlink" title="3、选做：获取更多图片"></a>3、选做：获取更多图片</h3><p>对已设计好的bing sh 进一步扩充，允许下面的命令行参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh rand 500</span><br></pre></td></tr></table></figure><p>实现的功能为：执行500 次随机获取。每次成功的随机获取会得到一个图片，检查一下这个图片是否本地已存在。如果已存在，丢弃，否则保存。</p><p>访问https ://bing.ioliu.cn/v1/rand? json 可得到一个 json 数据，每次得到的内容是随机的，其中含有图片的日期、说明信息和获取它的 url 网址。新获得的文件命名方式与以前的程序相同。要求：文件名不同但是内容完全相同的图片丢弃，例如，下面两个文件虽然名字不同，但是内容是一样的，只保留其中一个文件。</p><p>2019-05-03 Ruff male displaying its plumage, Varanger Peninsula, Norway.jpg</p><p>2019-05-02 挪威瓦朗厄尔半岛上一只展示翎颌的雄性涉禽.jpg</p><h2 id="二、实验环境"><a href="#二、实验环境" class="headerlink" title="二、实验环境"></a>二、实验环境</h2><p>系统：Manjaro 20.0 基于 Arc Linux</p><p>编辑器：Visual Studio Code</p><h2 id="三、实验步骤"><a href="#三、实验步骤" class="headerlink" title="三、实验步骤"></a>三、实验步骤</h2><h3 id="1、生成TCP-活动状况报告-1"><a href="#1、生成TCP-活动状况报告-1" class="headerlink" title="1、生成TCP 活动状况报告"></a>1、生成TCP 活动状况报告</h3><ol><li><p>先在终端中运行命令查看输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat --statistics</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501213718.jpg" alt="Screenshot_20200430_200332" style="zoom:80%"></li><li><p>可以在Tcp下看到相关信息，我们感兴趣的内容是的上图红框圈起的部分，因此我们可以使用正则表达式配合grep、sed、awk命令，将它取出来。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat --statistics | grep segments</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214005.jpg" alt="Screenshot_20200430_200930" style="zoom:80%"></li><li><p>发现还不够，继续使用grep提取：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat --statistics | grep '[0-9][0-9]* segments</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214057.jpg" alt="Screenshot_20200430_201017" style="zoom:80%"></li><li><p>再添加一个过滤条件，最终成功获取了所需信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat --statistics | grep '[0-9][0-9]* segments [rs][e][cn]</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214307.jpg" alt="Screenshot_20200430_201123" style="zoom:80%"></li><li><p>这样，我们就可以直接使用awk命令，获取所需的列即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat --statistics | awk '/[0-9][0-9]* segments [rs][e][cn]/ &#123;print $1&#125;'</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214431.jpg" alt="Screenshot_20200430_201208" style="zoom:80%"></li><li><p>使用date命令，可以获取当前日期时间。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date '+%Y-%m-%d %H:%M'</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214633.jpg" alt="Screenshot_20200430_201338" style="zoom:80%"></li><li><p>因为要隔一分钟获取一次，程序的基本框架就是：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501214925.jpg" alt="2020-05-01_214903" style="zoom:80%"></li><li><p>详细的代码以及注释在最后的附录中，这里不再展示。</p></li><li><p>编写完后运行net.sh，发现不能运行，加上可执行权限即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x net.sh</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501215103.jpg" alt="Screenshot_20200430_201754"></p></li><li><p>运行程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./net.sh</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501215216.jpg" alt="Screenshot_20200430_203848" style="zoom:80%"></li></ol><h3 id="2、下载bing-图库中图片-1"><a href="#2、下载bing-图库中图片-1" class="headerlink" title="2、下载bing 图库中图片"></a>2、下载bing 图库中图片</h3><ol><li><p>先去<a href="https://bing.ioliu.cn/?p=1" target="_blank" rel="external nofollow noopener noreferrer">bing图库</a>看一下网页的源码。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501215608.jpg" alt="Screenshot_20200430_204133" style="zoom:80%"><p>打开开发者工具。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501215644.jpg" alt="Screenshot_20200430_204302" style="zoom:80%"><p>我们感兴趣的内容即为下图中用红框圈起的3个部分。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501215728.jpg" alt="Screenshot_20200430_204405" style="zoom:80%"></li><li><p>使用wget命令尝试下载网页和图片。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -O 1.html https://bing.ioliu.cn/\?p\=1</span><br><span class="line">wget -O photo.jpg http://h1.ioliu.cn/bing/WhiteStorksNest_ZH-CN9809680903_640x480.jpg\?imageslim</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501220206.jpg" alt="Screenshot_20200430_205012" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501220218.jpg" alt="Screenshot_20200430_204759" style="zoom:80%"></li><li><p>查看下载的内容。</p><p>网页：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi 1.html</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501220338.jpg" alt="Screenshot_20200430_205434" style="zoom:80%"><p>图片：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501220424.jpg" alt="photo" style="zoom:80%"></li><li><p>下面进行把html中我们感兴趣的内容通过正则表达式配合grep、sed、awk命令，将它取出来。</p><ul><li><p><strong><em>文字介绍</em></strong></p><ol><li><p>先将无用的标签删除。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501220914.jpg" alt="Screenshot_20200501_202154" style="zoom:80%"></li><li><p>发现我们想要的文字介绍都有符号“©”，因此使用awk可以轻松取出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/©/ &#123; print $0 &#125;' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501221054.jpg" alt="Screenshot_20200501_202308" style="zoom:80%"></li><li><p>最后，使用sed把后面无用的（）中的内容去掉即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/©/ &#123; print $0 &#125;' | sed 's/(.*)//g' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501221223.jpg" alt="Screenshot_20200501_202347" style="zoom:80%"></li></ol></li><li><p><strong><em>日期</em></strong></p><p>同样是先将无用的标签去掉，发现日期有共同的特点就是“数字-数字-数字”，因此用awk即可取出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/[0-9][0-9]*-[0-9][0-9]*-[0-9][0-9]*/ &#123; print $0 &#125;' | more</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501221416.jpg" alt="Screenshot_20200501_202429"></p></li><li><p><strong><em>网址</em></strong></p><ol><li><p>因为网址在标签中，我们就不能先将标签取出了。发现我们所需的内容在一行中，不好操作，因此先将“src=””替换为换行，刚好使我们所需的网址位于每行的开头。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/src="/\n/g' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501221727.jpg" alt="Screenshot_20200501_202520" style="zoom:80%"></li><li><p>发现所有的网址都以“http:”开头，因此使用awk即可轻松取出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501222020.jpg" alt="Screenshot_20200501_203215" style="zoom:80%"></li><li><p>最后，用sed删掉行尾无用的内容即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | sed 's/"&gt;&lt;a//g' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501222136.jpg" alt="Screenshot_20200501_203246" style="zoom:80%"></li><li><p>最新版本修复了分辨率的问题，再使用sed将640x480改为1920x1080即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat 1.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | sed -e 's/"&gt;&lt;a//g' -e 's/640x480/1920x1080/g' | more</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200505220912.jpg" alt="Screenshot_20200505_215024" style="zoom:80%"></li></ol></li></ul></li><li><p>详细的代码和注释见最后的附录。</p></li><li><p>运行程序，依然需要先赋予执行权限。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod u+x bing.sh</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501222341.jpg" alt="Screenshot_20200501_203357" style="zoom:80%"><ul><li><p>不带参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh</span><br></pre></td></tr></table></figure><p>发现程序正常运行。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225218.jpg" alt="Screenshot_20200501_224148" style="zoom:80%"><p>在运行过程中故意强制退出。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225230.jpg" alt="Screenshot_20200501_224207" style="zoom:80%"><p>因为程序强制退出，会留下一个下载未完全的文件。但是完全不会受到影响，下一次运行时，会自动接续下载。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225355.jpg" alt="Screenshot_20200501_224246" style="zoom:80%"></li><li><p>两个参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh 1 3</span><br></pre></td></tr></table></figure><p>因为上一个命令已经下载了一部分，已经下载过的不会再下载，接着上一次下载的位置继续下载。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225413.jpg" alt="Screenshot_20200501_203751" style="zoom:80%"><p>下载完成。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225521.jpg" alt="Screenshot_20200501_203831" style="zoom:80%"><p>查看下载的图片，发现是刚好36张，1-3页。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225606.jpg" alt="Screenshot_20200501_203644" style="zoom:80%"></li><li><p>一个参数（自己额外实现的功能）</p><p>如果只输入一个参数，那么将从第一页下载到输入的参数页数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing 2</span><br></pre></td></tr></table></figure><p>因为上面已经下载了1-3页，因此不会重复下载。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501225758.jpg" alt="Screenshot_20200501_204728" style="zoom:80%"></li><li><p>并发执行（自己额外实现的功能，下载的内容有冲突）</p><p>终端1：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh</span><br></pre></td></tr></table></figure><p>终端2：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh 1 3</span><br></pre></td></tr></table></figure><p>我写的代码，专门考虑了并发的情况，使用当前进程id作为缓冲文件名，从而不会与其他的程序产生冲突。我额外实现了，并发执行时，即使下载的内容有冲突，也不会产生错误。但是可能有一个小问题就是如果第一个程序检测到了a图片没有下载，开始下载了，但是在第一个程序还没下载完成时，刚好第二个程序也检测到了a图片没有下载，可能会重复下载，但是如果第二个程序检测到了a图片已经下载完成，则不会重复下载，所以也无伤大雅，不会产生致命错误。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230410.jpg" alt="Screenshot_20200501_205414" style="zoom:80%"><p>查看下载的图片：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230450.jpg" alt="Screenshot_20200501_205654" style="zoom:80%"></li><li><p>并发执行（下载的内容无冲突）</p><p>终端1：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh 1 3</span><br></pre></td></tr></table></figure><p>终端2：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing.sh 4 6</span><br></pre></td></tr></table></figure><p>如果下载的内容没有冲突就更不会产生任何问题了。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230501.jpg" alt="Screenshot_20200501_205800" style="zoom:80%"><p>完美下载完成。</p><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230518.jpg" alt="Screenshot_20200501_205820"></p><p>查看下载的图片，刚好是72张，1-6页。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230548.jpg" alt="Screenshot_20200501_205857" style="zoom:80%"></li><li><p>差错处理</p><p>各种错误处理的情况：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200501230858.jpg" alt="Screenshot_20200501_204336" style="zoom:80%"></li></ul></li></ol><h3 id="3、选做：获取更多图片-1"><a href="#3、选做：获取更多图片-1" class="headerlink" title="3、选做：获取更多图片"></a>3、选做：获取更多图片</h3><ol><li><p>先访问网址<a href="https://bing.ioliu.cn/v1/rand?type=json" target="_blank" rel="external nofollow noopener noreferrer">https://bing.ioliu.cn/v1/rand?type=json</a>查看json文件的格式</p><p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502182121.jpg" alt="2020-05-02_182006"></p></li><li><p>把json中我们感兴趣的内容通过正则表达式配合grep、sed、awk命令，将它取出来：</p><p>这些都比较简单，根据json的key就很轻松的取出来了</p><ul><li><p><strong>文字介绍</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat bing/$$.json | sed 's/.*"copyright":"\(.*\)(.*©.*)"&#125;,.*/\1/g'</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184129.jpg" alt="Screenshot_20200502_183642" style="zoom:80%"></li><li><p><strong>日期</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat bing/$$.json | sed 's/.*"enddate":"\([0-9][0-9][0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)",.*/\1-\2-\3/g'</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184145.jpg" alt="Screenshot_20200502_183756" style="zoom:80%"></li><li><p><strong>网址</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat bing/$$.json | sed 's/.*"url":"\(http:.*imageslim\)",.*/\1/g'</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184156.jpg" alt="Screenshot_20200502_183849" style="zoom:80%"></li></ul></li><li><p>详细的代码和注释见最后的附录。</p></li><li><p>运行程序，依然需要先赋予执行权限。</p><p><strong><em>PS：v2.0在v1.0的基础上进行了修改，优化了部分代码，除了这次的功能，完全保留了v1.0的功能，并且random模式也可以并发，就不展示了。</em></strong></p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184252.jpg" alt="Screenshot_20200502_171455" style="zoom:80%"><p>查看下载的图片：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184324.jpg" alt="Screenshot_20200502_173042" style="zoom:80%"></li><li><p>差错处理</p><p>各种错误处理的情况：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200502184415.jpg" alt="Screenshot_20200502_171600" style="zoom:80%"></li></ol><h3 id="4、升级版bing-sh"><a href="#4、升级版bing-sh" class="headerlink" title="4、升级版bing.sh"></a>4、升级版bing.sh</h3><p>在bing2.sh的基础上升级的v3.0版的bing3.sh，优化了bing2.sh的部分判断逻辑和代码，相较于bing2.sh移除了diff和cmp比较，使用了更为高效的md5比较，且将md5校验信息存到文件中，供下次使用，加速判断。</p><p>运行截图：</p><p>这里都是展示了更为高级的并发下载的情况，非并发就不再展示了。</p><ol><li><p>两个终端分别进行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing3.sh 1 3</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing3.sh 1 4</span><br></pre></td></tr></table></figure><p>结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200504110120.jpg" alt="Screenshot_20200504_104053" style="zoom:80%"><p>完美执行成功，且已经下载过的不会重复下载：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200504110205.jpg" alt="Screenshot_20200504_104113" style="zoom:80%"><p>查看图片：</p><p>刚好1-4页48个图片加1个md5校验文件，共49个文件</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200504110222.jpg" alt="Screenshot_20200504_104143" style="zoom:80%"><p>md5校验文件md5.txt也成功生成了。</p></li><li><p>两个终端分别进行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing3.sh rand 10</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bing3.sh rand 10</span><br></pre></td></tr></table></figure><p>结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200504110546.jpg" alt="Screenshot_20200504_101820" style="zoom:80%"><p>查看图片：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200504110616.jpg" alt="Screenshot_20200504_101905" style="zoom:80%"></li></ol><h3 id="5、小修复"><a href="#5、小修复" class="headerlink" title="5、小修复"></a>5、小修复</h3><p>修复了分辨率过小，导致下载的图片不清晰的问题，现在分辨率统一为1920x1080。</p><p>由文件大小也可以看出，分辨率已经给更改。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200505220602.jpg" alt="Screenshot_20200505_214913" style="zoom:80%"><p>打开图片查看，图片已经很清晰了，分辨率为1920x1080。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200505220644.jpg" alt="Screenshot_20200505_215821" style="zoom:80%"><h2 id="四、实验总结及感受"><a href="#四、实验总结及感受" class="headerlink" title="四、实验总结及感受"></a>四、实验总结及感受</h2><p>​ 在这次实验中，明显感受到了shell脚本程序的编程和C语言等有很大的差别，尤为要注意各种双引号，单引号，空格啊之类的，拉下来就完全错误。在实验中还遇到了一个很有意思的小问题，就是echo命令如果后面的变量中有换行的话，直接使用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $xxx</span><br></pre></td></tr></table></figure><p>会将换行变成空格，但是如果加上双引号括起来，就能正常输出换行了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "$xxx"</span><br></pre></td></tr></table></figure><p>在实验中还熟悉了各种分支循环命令的使用，在shell中的printf格式化输出，并且复习了前面学习的正则表达式和grep、sed、awk文本处理三剑客，收获很大。</p><h2 id="五、附录"><a href="#五、附录" class="headerlink" title="五、附录"></a>五、附录</h2><h3 id="1、net-sh"><a href="#1、net-sh" class="headerlink" title="1、net.sh"></a>1、net.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Description: 生成TCP 活动状况报告</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Version: v1.0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Author: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Date: 2020-04-30 11:26:28</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditors: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditTime: 2020-05-01 23:19:04</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取时间</span></span><br><span class="line">date_time=`date '+%Y-%m-%d %H:%M'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一分钟开始时的TCP报文数</span></span><br><span class="line">data1=`netstat --statistics | grep '[0-9][0-9]* segments [rs][e][cn]'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送</span></span><br><span class="line">send1=`echo $data1 | awk '&#123;print $4&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收</span></span><br><span class="line">recv1=`echo $data1 | awk '&#123;print $1&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 等60s</span></span><br><span class="line">sleep 60</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一分钟结束时的TCP报文数</span></span><br><span class="line">data_temp=`netstat --statistics | grep '[0-9][0-9]* segments [rs][e][cn]'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送</span></span><br><span class="line">send_temp=`echo $data_temp | awk '&#123;print $4&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收</span></span><br><span class="line">recv_temp=`echo $data_temp | awk '&#123;print $1&#125;'`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一分钟内发送的TCP报文数</span></span><br><span class="line">send=`expr $send_temp - $send1`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一分钟内接收的TCP报文数</span></span><br><span class="line">recv=`expr $recv_temp - $recv1`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一分钟内收发TCP报文总数</span></span><br><span class="line">sum_temp=`expr $send + $recv`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出,第一次输出不加最后的符号</span></span><br><span class="line">printf '%-16s%8s%8s%8s\n' "$date_time" "$send" "$recv" "$sum_temp"</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">    # 获取时间</span><br><span class="line">    date_time=`date '+%Y-%m-%d %H:%M'`</span><br><span class="line">    # 等60s</span><br><span class="line">    sleep 60</span><br><span class="line">    # 一分钟后的TCP报文数</span><br><span class="line">    data2=`netstat --statistics | grep '[0-9][0-9]* segments [rs][e][cn]'`</span><br><span class="line">    # 发送</span><br><span class="line">    send2=`echo $data2 | awk '&#123;print $4&#125;'`</span><br><span class="line">    # 接收</span><br><span class="line">    recv2=`echo $data2 | awk '&#123;print $1&#125;'`</span><br><span class="line">    # 这一分钟内发送的TCP报文数</span><br><span class="line">    send=`expr $send2 - $send_temp`</span><br><span class="line">    # 这一分钟内接收的TCP报文数</span><br><span class="line">    recv=`expr $recv2 - $recv_temp`</span><br><span class="line">    # 这一分钟内收发TCP报文总数</span><br><span class="line">    sum2=`expr $send + $recv`</span><br><span class="line">    # 判断最后的符号</span><br><span class="line">    # 后-前&gt;10,为+</span><br><span class="line">    if [ `expr $sum2 - $sum_temp` -gt 10 ]</span><br><span class="line">    then</span><br><span class="line">        sign='+'</span><br><span class="line">    # 前-后&gt;10,为-</span><br><span class="line">    elif [ `expr $sum_temp - $sum2` -gt 10 ]</span><br><span class="line">    then</span><br><span class="line">        sign='-'</span><br><span class="line">    # 其他情况,为空格</span><br><span class="line">    else</span><br><span class="line">        sign=' '</span><br><span class="line">    fi</span><br><span class="line">    # 输出</span><br><span class="line">    printf '%-16s%8s%8s%8s%5s\n' "$date_time" "$send" "$recv" "$sum2" "$sign"</span><br><span class="line">    # 保留上一次的数据,用于下一次比较</span><br><span class="line">    send_temp=$send2</span><br><span class="line">    recv_temp=$recv2</span><br><span class="line">    sum_temp=$sum2</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="2、bing-sh"><a href="#2、bing-sh" class="headerlink" title="2、bing.sh"></a>2、bing.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Description: 下载bing 图库中图片</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Version: 1.0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Author: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Date: 2020-05-01 08:54:37</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditors: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditTime: 2020-05-05 21:55:22</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 错误代号:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1: 参数输入格式错误</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2: 输入的页数非整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3: 输入的页数范围不在[1,126]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4: 开始页数&lt;结束页数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5: 获取下载页面失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6: 获取下载图片失败</span></span><br><span class="line"></span><br><span class="line">NONE="\e[0m"</span><br><span class="line">RED="\e[0;31m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取命令行参数，并进行错误处理</span></span><br><span class="line">if [ $# = 0 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=126</span><br><span class="line"><span class="meta">#</span><span class="bash"> 额外增加了一个，如果只输入一个参数，代表从第1页到输入的参数的页数</span></span><br><span class="line">elif [ $# = 1 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=$1</span><br><span class="line">elif [ $# = 2 ]</span><br><span class="line">then</span><br><span class="line">    start_page=$1</span><br><span class="line">    end_page=$2</span><br><span class="line">else</span><br><span class="line">    printf $RED'Error: Please input the right arguments\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from 1 to 126 by default"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入的页数非整数</span></span><br><span class="line">if ! expr $start_page + 0 &gt; /dev/null 2&gt;&amp;1 || ! expr $end_page + 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">then</span><br><span class="line">    printf $RED'Error: Your input page is not an integer\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from 1 to 126 by default"</span><br><span class="line">    exit 2</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入的页数范围不在[1,126]</span></span><br><span class="line">if [ $start_page -lt 1 -o $end_page -lt 1 -o $start_page -gt 126 -o $end_page -gt 126 ]</span><br><span class="line">then</span><br><span class="line">    printf $RED'Error: Your input page not in the range [1,126]\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from 1 to 126 by default"</span><br><span class="line">    exit 3</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始页数&lt;结束页数</span></span><br><span class="line">if [ $start_page -gt $end_page ]</span><br><span class="line">then</span><br><span class="line">    printf $RED'Error: Your input [start_page] &gt; [end page]\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from 1 to 126 by default"</span><br><span class="line">    exit 4</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo "Your input page range is [$start_page,$end_page]"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断并创建目录</span></span><br><span class="line">if [ ! -d bing ]</span><br><span class="line">then</span><br><span class="line">    mkdir bing</span><br><span class="line">    echo "Work directory bing is created"</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 缓存目录这里使用当前进程ID号作为区分，防止受到影响，下面下载图片使用$$.jpg作为缓存也是同样的道理</span></span><br><span class="line">if [ ! -d bing/html_$$ ]</span><br><span class="line">then</span><br><span class="line">    mkdir bing/html_$$</span><br><span class="line">    echo "Cache directory bing/html_$$ is created"</span><br><span class="line">fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 对页范围内的循环下载</span></span><br><span class="line">for i in `seq $start_page $end_page`</span><br><span class="line">do</span><br><span class="line">    # 判断是否已经下载</span><br><span class="line">    if [ ! -f bing/html_$$/$i.html ]</span><br><span class="line">    then</span><br><span class="line">        echo "Download page $i……"</span><br><span class="line">        if wget -O bing/html_$$/$i.html "https://bing.ioliu.cn/?p=$i" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            echo "Page $i download successfully"</span><br><span class="line">        else</span><br><span class="line">            if [ -f bing/html_$$/$i.html ]</span><br><span class="line">            then</span><br><span class="line">                rm bing/html_$$/$i.html</span><br><span class="line">            fi</span><br><span class="line">            printf $RED"Error: Page $i download failed\n"$NONE</span><br><span class="line">            exit 5</span><br><span class="line">        fi</span><br><span class="line">    else</span><br><span class="line">        echo "Page $i already exists"</span><br><span class="line">    fi</span><br><span class="line">    # 获取该页所以图片信息</span><br><span class="line">    name_list=`cat bing/html_$$/$i.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/©/ &#123; print $0 &#125;' | sed 's/(.*)//g'`</span><br><span class="line">    date_list=`cat bing/html_$$/$i.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/[0-9][0-9]*-[0-9][0-9]*-[0-9][0-9]*/ &#123; print $0 &#125;'`</span><br><span class="line">    url_list=`cat bing/html_$$/$i.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | sed -e 's/"&gt;&lt;a//g' -e 's/640x480/1920x1080/g'`</span><br><span class="line">    # 对该页内图片循环下载</span><br><span class="line">    for j in `seq 1 12`</span><br><span class="line">    do</span><br><span class="line">        # 获取图片信息</span><br><span class="line">        name=`echo "$name_list" | awk "NR==$j"`</span><br><span class="line">        date=`echo "$date_list" | awk "NR==$j"`</span><br><span class="line">        url=`echo "$url_list" | awk "NR==$j"`</span><br><span class="line">        file_name="$date $name.jpg"</span><br><span class="line">        # 清理残留缓存</span><br><span class="line">        if [ -f "bing/$$.jpg" ]</span><br><span class="line">        then</span><br><span class="line">            rm "bing/$$.jpg"</span><br><span class="line">        fi</span><br><span class="line">        # 判断是否已经下载</span><br><span class="line">        if [ ! -f "bing/$file_name" ]</span><br><span class="line">        then</span><br><span class="line">            echo "Download photo $i-$j……"</span><br><span class="line">            if wget -O bing/$$.jpg "$url" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">            then</span><br><span class="line">                mv "bing/$$.jpg" "bing/$file_name"</span><br><span class="line">                echo "Photo $i-$j download successfully"</span><br><span class="line">            else</span><br><span class="line">                printf $RED"Error: Photo $i-$j download failed\n"$NONE</span><br><span class="line">                exit 6</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            echo "Photo $i-$j already exists"</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> 清理缓存</span></span><br><span class="line">echo "Cleaning……"</span><br><span class="line">if [ -d bing/html_$$ ]</span><br><span class="line">then</span><br><span class="line">    rm -r bing/html_$$</span><br><span class="line">fi</span><br><span class="line">echo "All done,Thanks for using!"</span><br></pre></td></tr></table></figure><h3 id="3、bing2-sh"><a href="#3、bing2-sh" class="headerlink" title="3、bing2.sh"></a>3、bing2.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Description: </span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Version: 2.0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Author: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Date: 2020-05-01 08:54:37</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditors: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditTime: 2020-05-08 22:01:41</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 错误代号:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1: 参数输入格式错误</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2: 输入的页数非整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3: 输入的页数范围不在[1,126]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4: 开始页数&lt;结束页数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5: 下载页面失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6: 下载图片失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7: 输入的随机次数非整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 8: 输入的随机次数&lt;1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 9: 下载json失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10: 未知错误</span></span><br><span class="line"></span><br><span class="line">NONE="\e[0m"</span><br><span class="line">RED="\e[0;31m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> rand=0，代表普通模式；rand&gt;0代表随机模式，rand的数值代表随机的次数</span></span><br><span class="line">rand=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取命令行参数，并进行错误处理</span></span><br><span class="line">if [ $# = 0 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=126</span><br><span class="line"><span class="meta">#</span><span class="bash"> 额外增加了一个，如果只输入一个参数，代表从第1页到输入的参数的页数</span></span><br><span class="line">elif [ $# = 1 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=$1</span><br><span class="line">elif [ $# = 2 ]</span><br><span class="line">then</span><br><span class="line">    # 随机模式</span><br><span class="line">    if [ $1 = 'rand' ]</span><br><span class="line">    then</span><br><span class="line">        # 判断第二个参数是否为整数</span><br><span class="line">        if expr $2 + 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            # 输入的随机次数&lt;1</span><br><span class="line">            if [ $2 -lt 1 ]</span><br><span class="line">            then</span><br><span class="line">                printf $RED'Error: Your input [rand times] &lt; 1\n'$NONE</span><br><span class="line">                echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">                echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">                echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">                echo "   or: $0 rand [rand times]          rand download photos of [rand times]"</span><br><span class="line">                exit 8</span><br><span class="line">            else</span><br><span class="line">                rand=$2</span><br><span class="line">            fi</span><br><span class="line">        # 输入的随机次数非整数</span><br><span class="line">        else</span><br><span class="line">            printf $RED'Error: Your input [rand times] is not an integer\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]          rand download photos of [rand times]"</span><br><span class="line">            exit 7</span><br><span class="line">        fi</span><br><span class="line">    # 普通模式</span><br><span class="line">    else</span><br><span class="line">        start_page=$1</span><br><span class="line">        end_page=$2</span><br><span class="line">        # 输入的页数非整数</span><br><span class="line">        if ! expr $start_page + 0 &gt; /dev/null 2&gt;&amp;1 || ! expr $end_page + 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input page is not an integer\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 2</span><br><span class="line">        fi</span><br><span class="line">        # 输入的页数范围不在[1,126]</span><br><span class="line">        if [ $start_page -lt 1 -o $end_page -lt 1 -o $start_page -gt 126 -o $end_page -gt 126 ]</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input page not in the range [1,126]\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 3</span><br><span class="line">        fi</span><br><span class="line">        # 开始页数&lt;结束页数</span><br><span class="line">        if [ $start_page -gt $end_page ]</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input [start_page] &gt; [end page]\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 4</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 参数输入格式错误</span></span><br><span class="line">else</span><br><span class="line">    printf $RED'Error: Please input the right arguments\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">    echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断并创建工作目录</span></span><br><span class="line">if [ ! -d bing ]</span><br><span class="line">then</span><br><span class="line">    mkdir bing</span><br><span class="line">    echo "Work directory bing is created"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通模式</span></span><br><span class="line">if [ $rand -eq 0 ]</span><br><span class="line">then</span><br><span class="line">    echo "##############Regular Mode##############"</span><br><span class="line">    echo "Your input page range is [$start_page,$end_page]"</span><br><span class="line">    # 对页范围内的循环下载</span><br><span class="line">    for i in `seq $start_page $end_page`</span><br><span class="line">    do</span><br><span class="line">        # 缓存文件使用当前进程ID号$$.html命名，防止受到影响，下面下载图片使用$$.jpg作为缓存也是同样的道理</span><br><span class="line">        echo "Download page $i……"</span><br><span class="line">        if wget -O bing/$$.html "https://bing.ioliu.cn/?p=$i" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            echo "Page $i download successfully"</span><br><span class="line">        else</span><br><span class="line">            if [ -f bing/$$.html ]</span><br><span class="line">            then</span><br><span class="line">                rm bing/$$.html</span><br><span class="line">            fi</span><br><span class="line">            printf $RED"Error: Page $i download failed\n"$NONE</span><br><span class="line">            exit 5</span><br><span class="line">        fi</span><br><span class="line">        # 获取该页所以图片信息</span><br><span class="line">        name_list=`cat bing/$$.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/©/ &#123; print $0 &#125;' | sed 's/(.*)//g'`</span><br><span class="line">        date_list=`cat bing/$$.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/[0-9][0-9]*-[0-9][0-9]*-[0-9][0-9]*/ &#123; print $0 &#125;'`</span><br><span class="line">        url_list=`cat bing/$$.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | sed -e 's/"&gt;&lt;a//g' -e 's/640x480/1920x1080/g'`</span><br><span class="line">        # 对该页内图片循环下载</span><br><span class="line">        for j in `seq 1 12`</span><br><span class="line">        do</span><br><span class="line">            # 获取图片信息</span><br><span class="line">            name=`echo "$name_list" | awk "NR==$j"`</span><br><span class="line">            date=`echo "$date_list" | awk "NR==$j"`</span><br><span class="line">            url=`echo "$url_list" | awk "NR==$j"`</span><br><span class="line">            file_name="$date $name.jpg"</span><br><span class="line">            # 判断是否已经下载</span><br><span class="line">            if [ ! -f "bing/$file_name" ]</span><br><span class="line">            then</span><br><span class="line">                echo "Download photo $i-$j……"</span><br><span class="line">                if wget -O bing/$$.jpg "$url" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">                then</span><br><span class="line">                    mv "bing/$$.jpg" "bing/$file_name"</span><br><span class="line">                    echo "Photo $i-$j download successfully"</span><br><span class="line">                else</span><br><span class="line">                    printf $RED"Error: Photo $i-$j download failed\n"$NONE</span><br><span class="line">                    exit 6</span><br><span class="line">                fi</span><br><span class="line">            else</span><br><span class="line">                echo "Photo $i-$j already exists"</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">    # 清理缓存</span><br><span class="line">    echo "Cleaning……"</span><br><span class="line">    rm bing/$$.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 随机模式</span></span><br><span class="line">elif [ $rand -gt 0 ]</span><br><span class="line">then</span><br><span class="line">    echo "##############Random Mode##############"</span><br><span class="line">    echo "Your input rand times is $rand"</span><br><span class="line">    # 循环随机下载</span><br><span class="line">    for k in `seq 1 $rand`</span><br><span class="line">    do</span><br><span class="line">        # 获取json</span><br><span class="line">        if wget -O bing/$$.json "https://bing.ioliu.cn/v1/rand?type=json" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            # 获取图片信息</span><br><span class="line">            name=`cat bing/$$.json | sed 's/.*"copyright":"\(.*\)(.*©.*)"&#125;,.*/\1/g'`</span><br><span class="line">            date=`cat bing/$$.json | sed 's/.*"enddate":"\([0-9][0-9][0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)",.*/\1-\2-\3/g'`</span><br><span class="line">            url=`cat bing/$$.json | sed 's/.*"url":"\(http:.*imageslim\)",.*/\1/g'`</span><br><span class="line">            file_name="$date $name.jpg"</span><br><span class="line">            # 判断是否已经下载，先用文件名判断</span><br><span class="line">            if [ ! -f "bing/$file_name" ]</span><br><span class="line">            then</span><br><span class="line">                echo "Download photo $k……"</span><br><span class="line">                if wget -O bing/$$ "$url" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">                then</span><br><span class="line">                    # 文件名不存在的，判断是否有文件大小相同的和内容相同的</span><br><span class="line">                    same=0</span><br><span class="line">                    for file in bing/*.jpg</span><br><span class="line">                    do</span><br><span class="line">                        # 先判断bing文件夹中是否有.jpg文件，如果没有的话*不会被替换，会出错</span><br><span class="line">                        if [ "$file" = 'bing/*.jpg' ]</span><br><span class="line">                        then</span><br><span class="line">                            break</span><br><span class="line">                        fi</span><br><span class="line">                        # 先比较文件大小是否相同，加快速度</span><br><span class="line">                        if [ `stat -c%s "$file"` = `ls -l "bing/$$" | awk '&#123; print $5 &#125;'` ]</span><br><span class="line">                        then</span><br><span class="line">                            # 大小相同再比较内容</span><br><span class="line">                            # diff命令主要用于比较文本文件，比较二进制文件效率较低</span><br><span class="line">                            # if diff "$file" "bing/$$" &gt; /dev/null</span><br><span class="line">                            # then</span><br><span class="line">                            #     # 相同</span><br><span class="line">                            #     same=1</span><br><span class="line">                            #     break</span><br><span class="line">                            # fi</span><br><span class="line">                            # md5sum计算文件md5值，进行比较</span><br><span class="line">                            # if [ `md5sum "$file" | awk '&#123; print $1 &#125;'` = `md5sum "bing/$$" | awk '&#123; print $1 &#125;'` ]</span><br><span class="line">                            # then</span><br><span class="line">                            #     # 相同</span><br><span class="line">                            #     same=1</span><br><span class="line">                            #     break</span><br><span class="line">                            # fi</span><br><span class="line">                            # cmp命令是逐字节比较</span><br><span class="line">                            if cmp -s "$file" "bing/$$"</span><br><span class="line">                            then</span><br><span class="line">                                # 相同</span><br><span class="line">                                same=1</span><br><span class="line">                                break</span><br><span class="line">                            fi</span><br><span class="line">                        fi</span><br><span class="line">                    done</span><br><span class="line">                    if [ $same = 1 ]</span><br><span class="line">                    then</span><br><span class="line">                        rm bing/$$</span><br><span class="line">                        echo "Photo $k already exists"</span><br><span class="line">                    else</span><br><span class="line">                        mv "bing/$$" "bing/$file_name"</span><br><span class="line">                        echo "Photo $k download successfully"</span><br><span class="line">                    fi</span><br><span class="line">                else</span><br><span class="line">                    printf $RED"Error: Photo $k download failed\n"$NONE</span><br><span class="line">                    exit 6</span><br><span class="line">                fi</span><br><span class="line">            else</span><br><span class="line">                echo "Photo $k already exists"</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            if [ -f bing/$$.json ]</span><br><span class="line">            then</span><br><span class="line">                rm bing/$$.json</span><br><span class="line">            fi</span><br><span class="line">            printf $RED"Error: Json $k download failed\n"$NONE</span><br><span class="line">            exit 9</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">    # 清理缓存</span><br><span class="line">    echo "Cleaning……"</span><br><span class="line">    rm bing/$$.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> 未知错误</span></span><br><span class="line">else</span><br><span class="line">    printf $RED"Error: Unkonwn error\n"$NONE</span><br><span class="line">    exit 10</span><br><span class="line">fi</span><br><span class="line">echo "All done,Thanks for using!"</span><br></pre></td></tr></table></figure><h3 id="3、bing3-sh"><a href="#3、bing3-sh" class="headerlink" title="3、bing3.sh"></a>3、bing3.sh</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Description: </span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Version: 3.0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Author: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @Date: 2020-05-01 08:54:37</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditors: 苇名一心</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> @LastEditTime: 2020-05-08 22:04:23</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"><span class="comment">##</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 错误代号:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1: 参数输入格式错误</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2: 输入的页数非整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3: 输入的页数范围不在[1,126]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4: 开始页数&lt;结束页数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5: 下载页面失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6: 下载图片失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7: 输入的随机次数非整数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 8: 输入的随机次数&lt;1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 9: 下载json失败</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10: 未知错误</span></span><br><span class="line"></span><br><span class="line">NONE="\e[0m"</span><br><span class="line">RED="\e[0;31m"</span><br><span class="line"><span class="meta">#</span><span class="bash"> rand=0，代表普通模式；rand&gt;0代表随机模式，rand的数值代表随机的次数</span></span><br><span class="line">rand=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 读取命令行参数，并进行错误处理</span></span><br><span class="line">if [ $# = 0 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=126</span><br><span class="line"><span class="meta">#</span><span class="bash"> 额外增加了一个，如果只输入一个参数，代表从第1页到输入的参数的页数</span></span><br><span class="line">elif [ $# = 1 ]</span><br><span class="line">then</span><br><span class="line">    start_page=1</span><br><span class="line">    end_page=$1</span><br><span class="line">elif [ $# = 2 ]</span><br><span class="line">then</span><br><span class="line">    # 随机模式</span><br><span class="line">    if [ $1 = 'rand' ]</span><br><span class="line">    then</span><br><span class="line">        # 判断第二个参数是否为整数</span><br><span class="line">        if expr $2 + 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            # 输入的随机次数&lt;1</span><br><span class="line">            if [ $2 -lt 1 ]</span><br><span class="line">            then</span><br><span class="line">                printf $RED'Error: Your input [rand times] &lt; 1\n'$NONE</span><br><span class="line">                echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">                echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">                echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">                echo "   or: $0 rand [rand times]          rand download photos of [rand times]"</span><br><span class="line">                exit 8</span><br><span class="line">            else</span><br><span class="line">                rand=$2</span><br><span class="line">            fi</span><br><span class="line">        # 输入的随机次数非整数</span><br><span class="line">        else</span><br><span class="line">            printf $RED'Error: Your input [rand times] is not an integer\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]          rand download photos of [rand times]"</span><br><span class="line">            exit 7</span><br><span class="line">        fi</span><br><span class="line">    # 普通模式</span><br><span class="line">    else</span><br><span class="line">        start_page=$1</span><br><span class="line">        end_page=$2</span><br><span class="line">        # 输入的页数非整数</span><br><span class="line">        if ! expr $start_page + 0 &gt; /dev/null 2&gt;&amp;1 || ! expr $end_page + 0 &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input page is not an integer\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 2</span><br><span class="line">        fi</span><br><span class="line">        # 输入的页数范围不在[1,126]</span><br><span class="line">        if [ $start_page -lt 1 -o $end_page -lt 1 -o $start_page -gt 126 -o $end_page -gt 126 ]</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input page not in the range [1,126]\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 3</span><br><span class="line">        fi</span><br><span class="line">        # 开始页数&lt;结束页数</span><br><span class="line">        if [ $start_page -gt $end_page ]</span><br><span class="line">        then</span><br><span class="line">            printf $RED'Error: Your input [start_page] &gt; [end page]\n'$NONE</span><br><span class="line">            echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">            echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">            echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">            echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">            exit 4</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 参数输入格式错误</span></span><br><span class="line">else</span><br><span class="line">    printf $RED'Error: Please input the right arguments\n'$NONE</span><br><span class="line">    echo "Usage: $0 [start page] [end page]  download photos in pages from [start page] to [end page]"</span><br><span class="line">    echo "   or: $0 [end page]               download photos in pages from [1] to [end page]"</span><br><span class="line">    echo "   or: $0 (with no arguments)      download photos in pages from [1] to [126] by default"</span><br><span class="line">    echo "   or: $0 rand [rand times]        rand download photos of [rand times]"</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断并创建工作目录</span></span><br><span class="line">if [ ! -d bing ]</span><br><span class="line">then</span><br><span class="line">    mkdir bing</span><br><span class="line">    echo "Work directory bing is created"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通模式</span></span><br><span class="line">if [ $rand -eq 0 ]</span><br><span class="line">then</span><br><span class="line">    echo "##############Regular Mode##############"</span><br><span class="line">    echo "Your input page range is [$start_page,$end_page]"</span><br><span class="line">    # 对页范围内的循环下载</span><br><span class="line">    for i in `seq $start_page $end_page`</span><br><span class="line">    do</span><br><span class="line">        # 缓存文件使用当前进程ID号$$.html命名，防止受到影响，下面下载图片使用$$.jpg作为缓存也是同样的道理</span><br><span class="line">        echo "Download page $i……"</span><br><span class="line">        if wget -O bing/$$.html "https://bing.ioliu.cn/?p=$i" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            echo "Page $i download successfully"</span><br><span class="line">        else</span><br><span class="line">            if [ -f bing/$$.html ]</span><br><span class="line">            then</span><br><span class="line">                rm bing/$$.html</span><br><span class="line">            fi</span><br><span class="line">            printf $RED"Error: Page $i download failed\n"$NONE</span><br><span class="line">            exit 5</span><br><span class="line">        fi</span><br><span class="line">        # 获取该页所以图片信息</span><br><span class="line">        name_list=`cat bing/$$.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/©/ &#123; print $0 &#125;' | sed 's/(.*)//g'`</span><br><span class="line">        date_list=`cat bing/$$.html | sed 's/&lt;[^&lt;&gt;]*&gt;/\n/g' | awk '/[0-9][0-9]*-[0-9][0-9]*-[0-9][0-9]*/ &#123; print $0 &#125;'`</span><br><span class="line">        url_list=`cat bing/$$.html | sed 's/src="/\n/g' | awk '/^http:/ &#123; print $1 &#125;' | sed -e 's/"&gt;&lt;a//g' -e 's/640x480/1920x1080/g'`</span><br><span class="line">        # 对该页内图片循环下载</span><br><span class="line">        for j in `seq 1 12`</span><br><span class="line">        do</span><br><span class="line">            # 获取图片信息</span><br><span class="line">            name=`echo "$name_list" | awk "NR==$j"`</span><br><span class="line">            date=`echo "$date_list" | awk "NR==$j"`</span><br><span class="line">            url=`echo "$url_list" | awk "NR==$j"`</span><br><span class="line">            file_name="$date $name.jpg"</span><br><span class="line">            # 判断是否已经下载</span><br><span class="line">            if [ ! -f "bing/$file_name" ]</span><br><span class="line">            then</span><br><span class="line">                echo "Download photo $i-$j……"</span><br><span class="line">                if wget -O bing/$$.jpg "$url" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">                then</span><br><span class="line">                    same=0</span><br><span class="line">                    # 先判断md5文件是否存在，如果不存在，说明bing空目录，直接改名</span><br><span class="line">                    if [ -f "bing/md5.txt" ]</span><br><span class="line">                    then</span><br><span class="line">                        # 文件名不存在的，判断是否有文件大小相同的和md5相同的</span><br><span class="line">                        cat bing/md5.txt | while read line</span><br><span class="line">                        do</span><br><span class="line">                            # 先比较文件大小是否相同，加快速度</span><br><span class="line">                            if [ `stat -c%s "bing/$$.jpg"` = `echo "$line" | awk '&#123; print $1 &#125;'` ]</span><br><span class="line">                            then</span><br><span class="line">                                # md5sum计算文件md5值，进行比较</span><br><span class="line">                                if [ `md5sum "bing/$$.jpg" | awk '&#123; print $1 &#125;'` = `echo "$line" | awk '&#123; print $2 &#125;'` ]</span><br><span class="line">                                then</span><br><span class="line">                                    # 相同</span><br><span class="line">                                    same=1</span><br><span class="line">                                    break</span><br><span class="line">                                fi</span><br><span class="line">                            fi</span><br><span class="line">                        done</span><br><span class="line">                    fi</span><br><span class="line">                    if [ $same = 1 ]</span><br><span class="line">                    then</span><br><span class="line">                        rm "bing/$$.jpg"</span><br><span class="line">                        echo "Photo $i-$j already exists"</span><br><span class="line">                    else</span><br><span class="line">                        mv "bing/$$.jpg" "bing/$file_name"</span><br><span class="line">                        echo "Photo $i-$j download successfully"</span><br><span class="line">                        # 生成文件大小和MD5校验信息</span><br><span class="line">                        echo "`stat -c%s "bing/$file_name"` "`md5sum "bing/$file_name"` &gt;&gt; bing/md5.txt</span><br><span class="line">                    fi</span><br><span class="line">                else</span><br><span class="line">                    printf $RED"Error: Photo $i-$j download failed\n"$NONE</span><br><span class="line">                    exit 6</span><br><span class="line">                fi</span><br><span class="line">            else</span><br><span class="line">                echo "Photo $i-$j already exists"</span><br><span class="line">            fi</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">    # 清理缓存</span><br><span class="line">    echo "Cleaning……"</span><br><span class="line">    rm bing/$$.html</span><br><span class="line"><span class="meta">#</span><span class="bash"> 随机模式</span></span><br><span class="line">elif [ $rand -gt 0 ]</span><br><span class="line">then</span><br><span class="line">    echo "##############Random Mode##############"</span><br><span class="line">    echo "Your input rand times is $rand"</span><br><span class="line">    # 循环随机下载</span><br><span class="line">    for k in `seq 1 $rand`</span><br><span class="line">    do</span><br><span class="line">        # 获取json</span><br><span class="line">        if wget -O "bing/$$.json" "https://bing.ioliu.cn/v1/rand?type=json" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        then</span><br><span class="line">            # 获取图片信息</span><br><span class="line">            name=`cat bing/$$.json | sed 's/.*"copyright":"\(.*\)(.*©.*)"&#125;,.*/\1/g'`</span><br><span class="line">            date=`cat bing/$$.json | sed 's/.*"enddate":"\([0-9][0-9][0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)",.*/\1-\2-\3/g'`</span><br><span class="line">            url=`cat bing/$$.json | sed 's/.*"url":"\(http:.*imageslim\)",.*/\1/g'`</span><br><span class="line">            file_name="$date $name.jpg"</span><br><span class="line">            # 判断是否已经下载，先用文件名判断</span><br><span class="line">            if [ ! -f "bing/$file_name" ]</span><br><span class="line">            then</span><br><span class="line">                echo "Download photo $k……"</span><br><span class="line">                if wget -O "bing/$$.jpg" "$url" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">                then</span><br><span class="line">                    same=0</span><br><span class="line">                    # 先判断md5文件是否存在，如果不存在，说明bing空目录，直接改名</span><br><span class="line">                    if [ -f "bing/md5.txt" ]</span><br><span class="line">                    then</span><br><span class="line">                        # 文件名不存在的，判断是否有文件大小相同的和md5相同的</span><br><span class="line">                        cat bing/md5.txt | while read line</span><br><span class="line">                        do</span><br><span class="line">                            # 先比较文件大小是否相同，加快速度</span><br><span class="line">                            if [ `stat -c%s "bing/$$.jpg"` = `echo "$line" | awk '&#123; print $1 &#125;'` ]</span><br><span class="line">                            then</span><br><span class="line">                                # md5sum计算文件md5值，进行比较</span><br><span class="line">                                if [ `md5sum "bing/$$.jpg" | awk '&#123; print $1 &#125;'` = `echo "$line" | awk '&#123; print $2 &#125;'` ]</span><br><span class="line">                                then</span><br><span class="line">                                    # 相同</span><br><span class="line">                                    same=1</span><br><span class="line">                                    break</span><br><span class="line">                                fi</span><br><span class="line">                            fi</span><br><span class="line">                        done</span><br><span class="line">                    fi</span><br><span class="line">                    if [ $same = 1 ]</span><br><span class="line">                    then</span><br><span class="line">                        rm "bing/$$.jpg"</span><br><span class="line">                        echo "Photo $k already exists"</span><br><span class="line">                    else</span><br><span class="line">                        mv "bing/$$.jpg" "bing/$file_name"</span><br><span class="line">                        echo "Photo $k download successfully"</span><br><span class="line">                        # 生成文件大小和MD5校验信息</span><br><span class="line">                        echo "`stat -c%s "bing/$file_name"` "`md5sum "bing/$file_name"` &gt;&gt; bing/md5.txt</span><br><span class="line">                    fi</span><br><span class="line">                else</span><br><span class="line">                    printf $RED"Error: Photo $k download failed\n"$NONE</span><br><span class="line">                    exit 6</span><br><span class="line">                fi</span><br><span class="line">            else</span><br><span class="line">                echo "Photo $k already exists"</span><br><span class="line">            fi</span><br><span class="line">        else</span><br><span class="line">            if [ -f bing/$$.json ]</span><br><span class="line">            then</span><br><span class="line">                rm bing/$$.json</span><br><span class="line">            fi</span><br><span class="line">            printf $RED"Error: Json $k download failed\n"$NONE</span><br><span class="line">            exit 9</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line">    # 清理缓存</span><br><span class="line">    echo "Cleaning……"</span><br><span class="line">    rm bing/$$.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> 未知错误</span></span><br><span class="line">else</span><br><span class="line">    printf $RED"Error: Unkonwn error\n"$NONE</span><br><span class="line">    exit 10</span><br><span class="line">fi</span><br><span class="line">echo "All done,Thanks for using!"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;本文是关于Linux中的shell脚本程序设计，有几个小Demo。&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/categories/Linux/"/>
    
      <category term="上机实战" scheme="https://666wxy666.github.io/categories/Linux/%E4%B8%8A%E6%9C%BA%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/tags/Linux/"/>
    
      <category term="实战" scheme="https://666wxy666.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
      <category term="shell脚本程序" scheme="https://666wxy666.github.io/tags/shell%E8%84%9A%E6%9C%AC%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>大数据 习题</title>
    <link href="https://666wxy666.github.io/2020/05/07/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E4%B9%A0%E9%A2%98/"/>
    <id>https://666wxy666.github.io/2020/05/07/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E4%B9%A0%E9%A2%98/</id>
    <published>2020-05-07T13:47:17.443Z</published>
    <updated>2020-06-14T02:18:14.989Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>自己随便整理了一下在学习“大数据”时遇到的一些习题，易错点之类的。</p><a id="more"></a><h2 id="1、关于Spark中task，block，partition，split，core的关系"><a href="#1、关于Spark中task，block，partition，split，core的关系" class="headerlink" title="1、关于Spark中task，block，partition，split，core的关系"></a>1、关于Spark中task，block，partition，split，core的关系</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507215355.png" alt="第5讲-第4章-大数据处理-Spark框架" style="zoom:67%"><blockquote><p>每一个过程的任务数，对应一个inputSplit, Partition输入可能以多个文件的形式存储在HDFS上，每个File都包含了很多块，称为Block。</p><p>当Spark读取这些文件作为输入时，会根据具体数据格式对应的InputFormat进行解析，一般是将若干个Block合并成一个输入分片，称为InputSplit，注意InputSplit不能跨越文件。</p><p>随后将为这些输入分片生成具体的Task。InputSplit与Task是一一对应的关系。随后这些具体的Task每个都会被分配到集群上的某个节点的某个Executor去执行。</p><ul><li><p>每个节点可以起一个或多个Executor。</p></li><li><p>每个Executor由若干core组成，每个Executor的每个core一次只能执行一个Task。</p><p>注意： 这里的core是虚拟的core而不是机器的物理CPU核，可以理解为就是Executor的一个工作线程。</p></li><li><p>每个Task执行的结果就是生成了目标RDD的一个partiton。</p><p>Task被执行的并发度 = Executor数目$\times$每个Executor核数（=core总个数）</p></li><li><p>至于partition的数目：</p><ul><li>对于数据读入阶段，例如sc.textFile，输入文件被划分为多少InputSplit就会需要多少初始Task。</li><li>在Map阶段partition数目保持不变。</li><li>在Reduce阶段，RDD的聚合会触发shuffle操作，聚合后的RDD的partition数目跟具体操作有关，例如repartition操作会聚合成指定分区数，还有一些算子是可配置的。</li><li>RDD在计算的时候，每个分区都会起一个task，所以rdd的分区数目决定了总的task数目。申请的计算节点（Executor）数目和每个计算节点核数，决定了你同一时刻可以并行执行的task。<br>比如：<br>RDD有100个分区，那么计算的时候就会生成100个task，你的资源配置为10个计算节点，每个2个核，同一时刻可以并行的task数目为20，计算这个RDD就需要5个轮次。如果计算资源不变，你有101个task的话，就需要6个轮次，在最后一轮中，只有一个task在执行，其余核都在空转。如果资源不变，你的RDD只有2个分区，那么同一时刻只有2个task运行，其余18个核空转，造成资源浪费。这就是在spark调优中，增大RDD分区数目，增大任务并行度的原因。</li></ul></li></ul></blockquote><h2 id="2、HDFS体系架构"><a href="#2、HDFS体系架构" class="headerlink" title="2、HDFS体系架构"></a>2、HDFS体系架构</h2><p>HDFS采用了主从（Master/Slave）结构 模型，一个HDFS集群是由一个 NameNode和若干个 DataNode 组成的。其中 NameNode 作为主服务器，管理文件系统的命名空间和客户端对文件的 访问操作；集群中的 DataNode 管理存储的数据。HDFS 允许用户以文件的形 式存储数据。从内部来看，文件被分成 若干个数据块，而且这若干个数据块存 放在一组 DataNode 上。NameNode 执行文件系统的命名空间操作，比如打开、关闭、重命名文件或目录等，它也负责数据块到具体 DataNode 的映射。 DataNode 负责处理文件系统客户端的文件读写请求，并在 NameNode 的统 一调度下进行数据块的创建、删除和复制工作。</p><h2 id="3、HDFS的读操作流程"><a href="#3、HDFS的读操作流程" class="headerlink" title="3、HDFS的读操作流程"></a>3、HDFS的读操作流程</h2><ol><li>初始化FileSystem，然后客户端用函数 open()打开文件。</li><li>FileSystem调用元数据节点，得到数据 块信息，并对每一个数据块、元数据节点返回，保存数据块的数据节点地址。</li><li>客户端调用Stream的read()函数开始读 取数据。</li><li>FSDataInputStream连接保存此文件第 一个数据块的最近的数据节点Datanode， data从数据节点读到客户端。</li><li>当第一个数据块读取完毕时， FSDataInputStream关闭和此数据节点的 连接，然后连接此文件下一个数据块的 最近的数据节点。</li><li>当客户端读取完毕数据的时候，调用 FSDataInputStream的close()函数，关闭连接。</li></ol><h2 id="4、HDFS的写操作流程"><a href="#4、HDFS的写操作流程" class="headerlink" title="4、HDFS的写操作流程"></a>4、HDFS的写操作流程</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507220050.jpg" alt="Pag4" style="zoom:80%"><h2 id="5、习题"><a href="#5、习题" class="headerlink" title="5、习题"></a>5、习题</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507215507.jpg" alt="Page1" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507215615.jpg" alt="Page2" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507215630.jpg" alt="Page3" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507220134.jpg" alt="第3讲-第2章-大数据存储-NoSQL数据库" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603095741.jpg" alt="2020-06-03_091537" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603095754.jpg" alt="2020-06-03_095449" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603095804.jpg" alt="2020-06-03_095457" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603095810.jpg" alt="2020-06-03_095505" style="zoom:80%">]]></content>
    
    <summary type="html">
    
      &lt;p&gt;自己随便整理了一下在学习“大数据”时遇到的一些习题，易错点之类的。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="习题" scheme="https://666wxy666.github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E4%B9%A0%E9%A2%98/"/>
    
    
      <category term="习题" scheme="https://666wxy666.github.io/tags/%E4%B9%A0%E9%A2%98/"/>
    
      <category term="易错点" scheme="https://666wxy666.github.io/tags/%E6%98%93%E9%94%99%E7%82%B9/"/>
    
      <category term="大数据" scheme="https://666wxy666.github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="Spark" scheme="https://666wxy666.github.io/tags/Spark/"/>
    
      <category term="HDFS" scheme="https://666wxy666.github.io/tags/HDFS/"/>
    
      <category term="MapReduce" scheme="https://666wxy666.github.io/tags/MapReduce/"/>
    
  </entry>
  
  <entry>
    <title>现代交换原理 MOOC习题 1~4章</title>
    <link href="https://666wxy666.github.io/2020/05/07/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86-MOOC%E4%B9%A0%E9%A2%98-1~4%E7%AB%A0/"/>
    <id>https://666wxy666.github.io/2020/05/07/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86-MOOC%E4%B9%A0%E9%A2%98-1~4%E7%AB%A0/</id>
    <published>2020-05-07T02:37:07.224Z</published>
    <updated>2020-06-14T02:42:17.118Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>自己随便整理了一下在学习“现代交换原理”网课时遇到的一些习题，易错点之类的。</p><a id="more"></a><h2 id="第一章-交换概论"><a href="#第一章-交换概论" class="headerlink" title="第一章 交换概论"></a>第一章 交换概论</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507105053.jpg" alt="2020-05-07_104537" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507105117.jpg" alt="2020-05-07_104811" style="zoom:80%"><blockquote><p>都是类似的道理，话音业务需要实时、高可靠、恒定速率，因此电路交换适合，异步显然不适合于话音业务。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507105241.jpg" alt="2020-05-07_104943" style="zoom:80%"><blockquote><p>电路交换是先建立好链路，在进行的交换。路由选择是先进行的，信息转发在建立好的链路上进行。分组交换是上面描述的特点。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507105428.jpg" alt="2020-05-07_105021" style="zoom:80%"><blockquote><p>通信网三要素是：<strong>交换设备</strong>、<strong>传输设备</strong>、<strong>终端设备</strong>。</p><p>交换网络的三要素是：<strong>交换单元</strong>、不同交换单元间的<strong>拓扑连接</strong>、<strong>控制方式</strong>。</p></blockquote><h2 id="第二章-交换网络"><a href="#第二章-交换网络" class="headerlink" title="第二章 交换网络"></a>第二章 交换网络</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507110011.jpg" alt="2020-05-07_110001" style="zoom:80%"><blockquote><p>交换单元的端口类型有两种：控制端口和状态端口。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507110554.jpg" alt="2020-05-07_110356" style="zoom:80%"><blockquote><p>T接线器：</p><ul><li><p>话音存储器（SM）：固定每个存储单元8bit存话音，存储单元的数量m就是时隙数m。</p></li><li><p>控制存储器（CM）：存储单元大小为$\log_2{m}$，所以时隙数一般都是2的幂次，存储单元的数量m也是时隙数m。</p></li></ul></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507110608.jpg" alt="2020-05-07_110547" style="zoom:80%"><blockquote><p>S接线器没有话音存储器，控制存储器（CM），可以把S接线器的所有的控制存储器看成$m\times{n}$个方格，m为时隙数，n为入（出）线数：</p><ul><li>S接线器所含CM的数量就是入（出）线数n，也就是一列为一个CM，共有n列。</li><li>每个CM所含的存储单元的数量为入（出）线的时隙数m，也就是每个格代表一个存储单元，每个CM有m个存储单元，m行。</li><li>每个存储单元的大小为$\log_2{m}$bit。</li></ul></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507114923.jpg" alt="2020-05-07_114828" style="zoom:80%"><blockquote><p>$N\times{N}$的Banyan网络需要$k=\log_2{N}$级，如果要使用$2\times{2}$的交换单元构建，那么每层就需要$\frac{N}{2}$个交换单元，k层共需要$k\times{\frac{N}{2}}=\frac{N}{2}\times{\log_2{N}}$，如果是M层的话，则需要$m\times{\frac{N}{2}\times{\log_2{N}}}$个$2\times{2}$的交换单元。</p><p>因此这个题需要$3\times{\frac{8}{2}\times{\log_2{8}}}=36$个$2\times{2}$的交换单元。</p></blockquote><h2 id="第三章-电路交换"><a href="#第三章-电路交换" class="headerlink" title="第三章 电路交换"></a>第三章 电路交换</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120505.jpg" alt="2020-05-07_120218" style="zoom:80%"><blockquote><p>常识知识。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120512.jpg" alt="2020-05-07_120231" style="zoom:80%"><blockquote><p>示意图：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518151446.jpg" alt="3" style="zoom:50%"><p>B+C-&gt;A：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200518151822.jpg" alt="第3章 电路交换" style="zoom:50%"></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120522.jpg" alt="2020-05-07_120244" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120530.jpg" alt="2020-05-07_120310" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120538.jpg" alt="2020-05-07_120324" style="zoom:80%"><blockquote><p>这三个题都是基础知识。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120551.jpg" alt="2020-05-07_120336" style="zoom:80%"><blockquote><p>直连？应该是可以实现不经过交换设备的语音通信。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120610.jpg" alt="2020-05-07_120432" style="zoom:80%"><blockquote><p>用户模块的处理机与区域处理机相连，区域处理机又与其他区域处理机和中央处理机相连。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507120618.jpg" alt="2020-05-07_120449" style="zoom:80%"><blockquote><p>周期级程序是按一定周期进行的各种扫描和驱动，例如200ms摘挂机扫描。开通业务应该是基本级程序负责。</p></blockquote><h2 id="第四章-分组交换"><a href="#第四章-分组交换" class="headerlink" title="第四章 分组交换"></a>第四章 分组交换</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121042.jpg" alt="2020-05-07_120658" style="zoom:80%"><blockquote><p>TCP连接的建立不是路由器基本功能。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121049.jpg" alt="2020-05-07_120714" style="zoom:80%"><blockquote><p>ISDN全称是综合业务数字网，不需要支持模拟业务。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121056.jpg" alt="2020-05-07_120733" style="zoom:80%"><blockquote><p>ATM 适配层（AAL）主要负责百 ATM 层与高层之间的信元转发过程。从上层收到信息后，AAL 将数据分割成 ATM 信元；从 ATM 层收到信息后，AAL 必须重度新组合数据形成一专个上层能够辨识的格式。上述操作称之为分段与重组（SAR），它是 AAL 的主要任务。此外不同的 AAL 支持属不同的流量或服务类型。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121103.jpg" alt="2020-05-07_120808" style="zoom:80%"><blockquote><p>MPLS标记可以任意级，标记栈实现多级标记，Label可以有多个。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121110.jpg" alt="2020-05-07_120850" style="zoom:80%"><blockquote><p>A、MPLS和ATM和帧中继都是路由选择和数据转发分开进行，都是面向连接的，但是不需要为每一次通信业务都建立新的连接；而传统IP网是无连接的，路由选择和数据转发同时进行。</p><p>B、MPLS和ATM都是虚连接，使用时连接，不需要时可以拆除连接，不是永久连接。</p><p>C、MPLS使用的是Label标记方式的逻辑连接，ATM是VPI/VCI方式的逻辑连接，都是逻辑虚连接。</p><p>D、MPLS通过LDP等协议，在LSR和LER、LSR和LSR之间完成标记信息的分发，形成与FEC对应的LSP路径。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121116.jpg" alt="2020-05-07_121004" style="zoom:80%"><blockquote><p>同上一个题的D选项。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121127.jpg" alt="2020-05-07_121012" style="zoom:80%"><blockquote><ol><li><p>入口LER接收分组，完成第三层功能，判定分组所属的FEC，并给分组加上标记形成MPLS标记分组。</p></li><li><p>LSR依据分组上的标记以及标记转发表通过交换单元对其进行转发，不再进行任何第三层处理，也就是只处理标记部分，不处理IP分组头。</p></li><li><p>出口 LER 将分组中的标记去掉后转发至目的地。</p></li></ol></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507121133.jpg" alt="2020-05-07_121029" style="zoom:80%"><blockquote><p>MPLS与ATM/FR类似，标记都是本地（逐段）有效的，需要路由器进行标记转换。</p></blockquote><details><summary><p>所有的习题：</p></summary><div class="content"><p><a href="/2020/05/07/现代交换原理-MOOC习题-1~4章/">现代交换原理 MOOC习题 1~4章</a></p><p><a href="/2020/05/18/现代交换原理-MOOC习题-5~6章/">现代交换原理 MOOC习题 5~6章</a></p></div></details>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;自己随便整理了一下在学习“现代交换原理”网课时遇到的一些习题，易错点之类的。&lt;/p&gt;
    
    </summary>
    
    
      <category term="现代交换原理" scheme="https://666wxy666.github.io/categories/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/"/>
    
      <category term="习题" scheme="https://666wxy666.github.io/categories/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/%E4%B9%A0%E9%A2%98/"/>
    
    
      <category term="习题" scheme="https://666wxy666.github.io/tags/%E4%B9%A0%E9%A2%98/"/>
    
      <category term="易错点" scheme="https://666wxy666.github.io/tags/%E6%98%93%E9%94%99%E7%82%B9/"/>
    
      <category term="网课" scheme="https://666wxy666.github.io/tags/%E7%BD%91%E8%AF%BE/"/>
    
      <category term="MOOC" scheme="https://666wxy666.github.io/tags/MOOC/"/>
    
      <category term="现代交换原理" scheme="https://666wxy666.github.io/tags/%E7%8E%B0%E4%BB%A3%E4%BA%A4%E6%8D%A2%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Linux MOOC习题 11~15章</title>
    <link href="https://666wxy666.github.io/2020/05/07/Linux-MOOC%E4%B9%A0%E9%A2%98-11~15%E7%AB%A0/"/>
    <id>https://666wxy666.github.io/2020/05/07/Linux-MOOC%E4%B9%A0%E9%A2%98-11~15%E7%AB%A0/</id>
    <published>2020-05-07T01:46:38.801Z</published>
    <updated>2020-06-14T02:42:06.479Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>自己随便整理了一下在学习Linux网课时遇到的一些习题，易错点之类的，接上文<a href="/2020/04/29/Linux-MOOC习题-6~10章/">Linux MOOC习题 6~10章</a>。</p><a id="more"></a><h2 id="十一、进程的基本概念"><a href="#十一、进程的基本概念" class="headerlink" title="十一、进程的基本概念"></a>十一、进程的基本概念</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507102145.jpg" alt="2020-05-07_095819" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507102202.jpg" alt="2020-05-07_095837" style="zoom:80%"><blockquote><ul><li><code>int a[N] = { 2 };</code>的意思是把<code>a[N]</code>第一个元素赋值为2，其他的赋值为0，也就是说，所有的元素都被赋值了，因此占空间很大。</li><li><code>int a[N];</code>的<code>a[N]</code>没有赋初值，只需记录a的长度即可，占用空间很小。</li></ul><p>从图中（test是第一种赋值的，test2是第二种不赋值的）也可以看出，差别巨大：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507103601.jpg" alt="2020-05-07_103457" style="zoom:80%"></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200507102210.jpg" alt="2020-05-07_100015" style="zoom:80%"><blockquote><p>忙等待主要是占用CPU，和内存没啥关系。</p></blockquote><h2 id="十二、进程的创建和重定向"><a href="#十二、进程的创建和重定向" class="headerlink" title="十二、进程的创建和重定向"></a>十二、进程的创建和重定向</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200511192429.jpg" alt="2020-05-11_192030" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200511192503.jpg" alt="2020-05-11_192056" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200511192519.jpg" alt="2020-05-11_192111" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200511192659.jpg" alt="2020-05-11_192207" style="zoom:80%"><blockquote><p>注意，这个程序是持续不间断运行的，也就是说，不能停止后再重启，但是重定向是只能在程序运行的时候进行的操作，程序一旦开始运行就没办法重定向了，因此不能实现。并且重定向是“当前进程”做的，不是父进程做的。但是如果foo可以终止后重启，确实可以用shell脚本等程序实现上述功能。修改foo程序也可以实现上述功能。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200511192733.jpg" alt="2020-05-11_192222" style="zoom:80%"><blockquote><p>执行的大致流程，只是各进程执行情况，并不代表真实执行顺序：</p><p><strong><em>父进程（0）：</em></strong></p><ul><li><p>输出：<code>i=0</code></p></li><li><p>父进程0产生第一个子进程0-1</p><p><strong><em>0-1：</em></strong></p><ul><li><p>到下一轮for循环，i=1</p></li><li><p>输出：<code>i=1</code></p></li><li><p>子进程0-1产生第一个子进程0-1-1</p><p><strong><em>0-1-1：</em></strong></p><ul><li><p>到下一轮for循环，i=2</p></li><li><p>输出：<code>i=2</code></p></li><li><p>进程0-1-1产生第一个子进程0-1-1-1</p><p><strong><em>0-1-1-1：</em></strong></p><ul><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-1-1-1产生第一个子进程0-1-1-1-1</p><p><strong><em>0-1-1-1-1：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-1-1-1-1结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-1-1-1结束</p></li></ul></li><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-1-1产生第二个子进程0-1-1-2</p><p><strong><em>0-1-1-2：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-1-1-2结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-1-1结束</p></li></ul></li><li><p>到下一轮for循环，i=2</p></li><li><p>输出：<code>i=2</code></p></li><li><p>子进程0-1产生第二个子进程0-1-2</p><p><strong><em>0-1-2：</em></strong></p><ul><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-1-2产生第一个子进程0-1-2-1</p><p><strong><em>0-1-2-1：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-1-2-1结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-1-2结束</p></li></ul></li><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>子进程0-1产生第三个子进程0-1-3</p><p><strong><em>0-1-3：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-1-3结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-1结束</p></li></ul></li><li><p>到下一轮for循环，i=1</p></li><li><p>输出：<code>i=1</code></p></li><li><p>父进程0产生第二个子进程0-2</p><p><strong><em>0-2：</em></strong></p><ul><li><p>到下一轮for循环，i=2</p></li><li><p>输出：<code>i=2</code></p></li><li><p>进程0-2产生第一个子进程0-2-1</p><p><strong><em>0-2-1：</em></strong></p><ul><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-2-1产生第一个子进程0-2-1-1</p><p><strong><em>0-2-1-1：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-2-1-1结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-2-1结束</p></li></ul></li><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-2产生第二个子进程0-2-2</p><p><strong><em>0-2-2：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-2-2结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-2结束</p></li></ul></li><li><p>到下一轮for循环，i=2</p></li><li><p>输出：<code>i=2</code></p></li><li><p>父进程0产生第三个子进程0-3</p><p><strong><em>0-3：</em></strong></p><ul><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>进程0-3产生第一个子进程0-3-1</p><p><strong><em>0-3-1：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-3-1结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>0-3结束</p></li></ul></li><li><p>到下一轮for循环，i=3</p></li><li><p>输出：<code>i=3</code></p></li><li><p>父进程0产生第四个子进程0-4</p><p><strong><em>0-4：</em></strong></p><ul><li>到下一轮for循环，i=4</li><li>0-4结束</li></ul></li><li><p>到下一轮for循环，i=4</p></li><li><p>父进程0结束</p></li></ul><p>共15行输出，分别为：</p><table><thead><tr><th align="center">输出</th><th align="center">次数</th></tr></thead><tbody><tr><td align="center">i=0</td><td align="center">$2^0=1$</td></tr><tr><td align="center">i=1</td><td align="center">$2^1=2$</td></tr><tr><td align="center">i=2</td><td align="center">$2^2=4$</td></tr><tr><td align="center">i=3</td><td align="center">$2^3=8$</td></tr></tbody></table><p>在linux下的实际执行情况：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514110539.png" alt="img" style="zoom:80%"><p>可以发现确实是15行，但是却有两个问题：</p><ol><li><p>为什么最后产生了一个空行，在等待用户输入？</p><p>shell提示符其实是主进程死了以后，shell给出来的。因为实际运行结果是子进程死得晚，父进程死的早。其实，你不按回车，大家也都运行结束了，只是shell提示符出现得比某个子进程早。你看起来这个效果，其实这个提示符已经在上面显示了，那个时候主进程结束，shell给出了提示符，但此时子进程还没有结束，因此会继续输出，但这个时候shell已经进入了等待下一个命令的状态了，就像这样：</p></li></ol><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514111514.png" alt="QQ图片20200514111508" style="zoom:80%"><p>​ 可以发现，echo命令已经可以被shell接受了。</p><ol start="2"><li><p>程序为什么分两部分输出了？</p><p>这是因为后面的子进程因为他的父进程先死掉了，变成了孤儿进程，打印出他们的父进程pid，发现是1，也证明了这一点：</p></li></ol><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514110755.png" alt="QQ图片20200514110749" style="zoom:80%"><p>因此我们可以对程序进行如下修改：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: </span></span><br><span class="line"><span class="comment"> * @Version: </span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-05-11 20:02:00</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-05-14 11:18:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,status,wait_pid;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"i=%d,pid=%d,ppid=%d\n"</span>, i,getpid(),getppid());</span><br><span class="line">        <span class="keyword">if</span>(fork()&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            wait_pid = wait(&amp;status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对每个fork加上wait语句，就可以完全按照上面的进程树执行顺序执行，且不会有任何问题了。</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200514112003.png" alt="QQ图片20200514111958" style="zoom:80%"><p>PS：对于wait，如果其所有子进程都还在运行，则阻塞；如果是一部分子进程终止，而另一部分还在运行，那么父进程还会阻塞吗？答案是不会，只要有一个进程终止，wait就会返回。也就是说只要wait接收到一个SIGCHLD信号，wait()就会返回。对于两个或多个子进程的情况，需要调用wait两次或多次。说白了在每一个fork后面的父进程分支中都要有一个wait与之对应。与wait相关的详细知识请参照这位兄弟的博客：<a href="https://www.cnblogs.com/black-mamba/p/6886434.html" target="_blank" rel="external nofollow noopener noreferrer">wait()函数的详细分析</a>。</p></blockquote><h2 id="十三、重定向和管道，信号"><a href="#十三、重定向和管道，信号" class="headerlink" title="十三、重定向和管道，信号"></a>十三、重定向和管道，信号</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200521095329.jpg" alt="2020-05-21_094112" style="zoom:80%"><blockquote><p>xsh2.c是一个简易的模拟shell程序。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @Copyright: Copyright (c) 2020 苇名一心 All Rights Reserved.</span></span><br><span class="line"><span class="comment"> * @Description: </span></span><br><span class="line"><span class="comment"> * @Version: </span></span><br><span class="line"><span class="comment"> * @Author: 苇名一心</span></span><br><span class="line"><span class="comment"> * @Date: 2020-05-21 09:44:26</span></span><br><span class="line"><span class="comment"> * @LastEditors: 苇名一心</span></span><br><span class="line"><span class="comment"> * @LastEditTime: 2020-05-21 09:51:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">256</span>], *argv1[<span class="number">256</span>], **p, *cmd2, *argv2[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">int</span> sv, fd[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"=&gt; "</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span>) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((cmd2 = <span class="built_in">strstr</span>(buf, <span class="string">"|"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        *cmd2++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (p = &amp;argv1[<span class="number">0</span>], *p = strtok(buf, <span class="string">" \t\n"</span>); *p != <span class="literal">NULL</span>; *++p = strtok(<span class="literal">NULL</span>, <span class="string">" \t\n"</span>))</span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (p = &amp;argv2[<span class="number">0</span>], *p = strtok(cmd2, <span class="string">" \t\n"</span>); *p != <span class="literal">NULL</span>; *++p = strtok(<span class="literal">NULL</span>, <span class="string">" \t\n"</span>))</span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argv1[<span class="number">0</span>] == <span class="literal">NULL</span> || argv2[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        pipe(fd);</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)<span class="comment">// | 左边的写端进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            dup2(fd[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">            execvp(argv1[<span class="number">0</span>], argv1);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"** bad command 1: %m\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (fork() == <span class="number">0</span>)<span class="comment">// | 右边的读端进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            dup2(fd[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">1</span>]);<span class="comment">// 和第二题的类似，也不能省略</span></span><br><span class="line">            execvp(argv2[<span class="number">0</span>], argv2);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"** bad command 2: %m\n"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">close</span>(fd[<span class="number">0</span>]);<span class="comment">// 第一题要省略的操作</span></span><br><span class="line">        <span class="built_in">close</span>(fd[<span class="number">1</span>]);<span class="comment">// 第二题要省略的操作</span></span><br><span class="line">        wait(&amp;sv);</span><br><span class="line">        wait(&amp;sv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>如果省略了这一条，对程序执行是没有什么影响的，但是循环多次以后，文件描述符一直不会被回收，导致资源耗尽，程序无法正常运行。</li><li>如果省略了这一条，就会产生重大问题。在写端进程写入结束后正常退出，读端在读取管道时，因为有个写入端一直没有关闭，导致读端的管道一直收不到结束信号，一直在等待读取，导致了死锁，读端程序不能正常结束。</li></ol></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200521100519.jpg" alt="2020-05-21_094136" style="zoom:80%"><blockquote><p>goto只能在函数内跳转，全局跳转则可以跳转到保存的程序运行状态（包括堆栈等），就可以理解为玩游戏的SavePoint。但是如果你没保存，那就没法跳转，因此全局跳转只能跳转到执行过的位置。但是这个题目是有点问题的，goto语句也可以向前和向后跳转，因此此题可以忽略。</p></blockquote><h2 id="十四、进程间协作，Socket概述"><a href="#十四、进程间协作，Socket概述" class="headerlink" title="十四、进程间协作，Socket概述"></a>十四、进程间协作，Socket概述</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529100058.jpg" alt="2020-05-29_094202" style="zoom:80%"><blockquote><p>也就是说，<code>mmap()</code>需要一个已经打开的文件的文件描述符，当然需要<code>open()</code>打开文件，至于为什么需要，解析说的很明白。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529100352.jpg" alt="2020-05-29_094455" style="zoom:80%"><blockquote><p>如果你打开的文件不关闭，你的程序一直执行，一直打开文件，打开的太多就会导致文件描述符资源耗尽，无法打开文件，但是当你程序退出时（正常退出或者异常终止），操作系统都会自动检测你已经打开的文件，自行关闭应该关闭的文件，因此也能正常持久化到磁盘文件。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529100636.jpg" alt="2020-05-29_094519" style="zoom:80%"><blockquote><p>咨询式锁定是很关键的，也就是你不自己调用<code>fcntl()</code>，你是不会被阻塞的，也就是说Linux给你提供了互斥访问的途径，你自己不用或者使用不当，还是会导致出现问题，这也是Linux“策略和机制相分离”的设计方法。它是一个重要的设计思路，当系统不能大包大揽时，系统提供“机制”，把“策略”留给程序员，简化了操作系统的设计，程序员正确操作，应该完成的功能也都能实现。这是一个典型的合理的“甩锅”行为。因特网和Linux设计上都遵循了这样的理念。SUID，bash中的条件判断，四则运算，都是相同的理念，它们简化了自己，仅提供“机制”，把“策略”留给应用程序，不失必备功能。C语言也一样，printf在C语言里也会是个函数，与语言本身无关，C语言自己设计得很简单，以至于常用C语言的程序员，不需要查阅任何手册，都能把语法记下来。C++，你试试？</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529101032.jpg" alt="2020-05-29_094606" style="zoom:80%"><blockquote><p>注意是以命令行参数方式传递，<code>exec()</code>虽然会清空原来的代码段，但是对文件描述符和信号的处理有所不同。</p><p>关于<code>fork()</code>和<code>exec()</code>父子进程对文件描述符和信号的继承问题总结如下：</p><ul><li><p>信号</p><ul><li><p>仅fork时子进程会继承父进程fork之前所设置的信号处理方式。</p></li><li><p>当有exec加载新程序时</p><ul><li>子进程继承的处理方式是忽略或默认处理方式时，exec新程序后设置依然有效。</li><li>如果子进程继承是捕获处理方式时，exec新程序后将被还原为默认处理方式。</li></ul></li></ul></li><li><p>文件描述符</p><p>当你用fork建立一个子进程，父进程的所有内容会被“完完整整”的复制到子进程中。子进程是父进程的一个clone体，除了pid不同，其余一切相同。在fork后父、子进程对于每一个打开的文件描述符共享同一个文件表项，此时可能有多个文件描述符项指向同一文件表项。即使exec也会保留文件描述符，但是有时子进程不需要继承父进程的文件描述符，并且有时在exec后子进程继承下来的文件描述符有的是毫无意义的，Linux使用close_on_exec标志位来实现。当父进程打开文件时，只需要应用程序设置FD_CLOSEXEC标志位，则当fork后exec其他程序的时候，内核自动会将其继承的父进程FD关闭。因此原则上只要你不设置这个标志位，你fork子进程后，exec新程序依然可以用你在父进程或者原来的子进程中打开的文件。</p></li></ul></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529101043.jpg" alt="2020-05-29_094713" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200529102311.jpg" alt="2020-05-29_094803" style="zoom:80%"><h2 id="十五、Socket编程"><a href="#十五、Socket编程" class="headerlink" title="十五、Socket编程"></a>十五、Socket编程</h2><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603082808.jpg" alt="2020-06-03_081900" style="zoom:80%"><blockquote><ul><li><code>bind</code>设置本地端点名，也可以用在客户端程序，不会阻塞；</li><li><code>listen</code>仅仅是给内核一个通知，开始监听到达的连接请求，不会阻塞；</li><li><code>connect</code>建立连接，设定远端端点名，进程阻塞，直到TCP连接建立（第二次握手）；</li><li><code>accept</code>接受一个连接请求，阻塞等待新连接的到来，直到TCP三次握手结束返回；</li></ul></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083359.jpg" alt="2020-06-03_082405" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083428.jpg" alt="2020-06-03_082415" style="zoom:80%"><blockquote><p>不执行<code>signal(SIGCLD,SIG_ING)</code>会产生僵尸进程。</p></blockquote><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083519.jpg" alt="2020-06-03_082433" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083527.jpg" alt="2020-06-03_082526" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083537.jpg" alt="2020-06-03_082543" style="zoom:80%"> <img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200603083546.jpg" alt="2020-06-03_082554" style="zoom:80%"><details><summary><p>所有的习题：</p></summary><div class="content"><p><a href="/2020/04/28/Linux-MOOC习题-1~5章/">Linux MOOC习题 1~5章</a></p><p><a href="/2020/04/29/Linux-MOOC习题-6~10章/">Linux MOOC习题 6~10章</a></p><p><a href="/2020/05/07/Linux-MOOC习题-11~15章/">Linux MOOC习题 11~15章</a></p></div></details>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;自己随便整理了一下在学习Linux网课时遇到的一些习题，易错点之类的，接上文&lt;a href=&quot;/2020/04/29/Linux-MOOC习题-6~10章/&quot;&gt;Linux MOOC习题 6~10章&lt;/a&gt;。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/categories/Linux/"/>
    
      <category term="习题" scheme="https://666wxy666.github.io/categories/Linux/%E4%B9%A0%E9%A2%98/"/>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/tags/Linux/"/>
    
      <category term="习题" scheme="https://666wxy666.github.io/tags/%E4%B9%A0%E9%A2%98/"/>
    
      <category term="易错点" scheme="https://666wxy666.github.io/tags/%E6%98%93%E9%94%99%E7%82%B9/"/>
    
      <category term="网课" scheme="https://666wxy666.github.io/tags/%E7%BD%91%E8%AF%BE/"/>
    
      <category term="MOOC" scheme="https://666wxy666.github.io/tags/MOOC/"/>
    
  </entry>
  
  <entry>
    <title>Linux 拓展学习</title>
    <link href="https://666wxy666.github.io/2020/04/29/Linux-%E6%8B%93%E5%B1%95%E5%AD%A6%E4%B9%A0/"/>
    <id>https://666wxy666.github.io/2020/04/29/Linux-%E6%8B%93%E5%B1%95%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-04-29T12:40:47.779Z</published>
    <updated>2020-05-08T14:23:11.008Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>简单的写了一些Linux的课外拓展学习的相关知识和问题。</p><a id="more"></a><h2 id="一、命令的参数"><a href="#一、命令的参数" class="headerlink" title="一、命令的参数"></a>一、命令的参数</h2><p>编写一个小程序，可以显示命令的选项和参数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d:%p [%s]\n"</span>, i, argv[i], argv[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429205057.jpg" alt="2020-04-29_205032" style="zoom:80%"><h2 id="二、关于控制printf输出的颜色"><a href="#二、关于控制printf输出的颜色" class="headerlink" title="二、关于控制printf输出的颜色"></a>二、关于控制printf输出的颜色</h2><p>编写程序hello.c，编译和运行程序，得到类似以下结果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429204547.png" alt="图片1" style="zoom:80%"><p>可以通过</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="number">033</span>[</span><br></pre></td></tr></table></figure><p>来控制printf输出的颜色，格式为：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"\033[字背景颜色;字体颜色m 字符串 \033[0m"</span> );</span><br></pre></td></tr></table></figure><p>注意，一定要在printf最后使用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="number">033</span>[<span class="number">0</span>m</span><br></pre></td></tr></table></figure><p>来消除前面的作用，否则前面的设置对后面的printf都有效果。</p><table><thead><tr><th align="center">ANSI控制码</th><th align="center">效果</th></tr></thead><tbody><tr><td align="center">\033[0m</td><td align="center">关闭所有属性</td></tr><tr><td align="center">\033[1m</td><td align="center">设置高亮度</td></tr><tr><td align="center">\033[4m</td><td align="center">下划线</td></tr><tr><td align="center">\033[5m</td><td align="center">闪烁</td></tr><tr><td align="center">\033[7m</td><td align="center">反显</td></tr><tr><td align="center">\033[8m</td><td align="center">消隐</td></tr><tr><td align="center">\033[30m —\033[37m</td><td align="center">设置前景色</td></tr><tr><td align="center">\033[40m—\033[47m</td><td align="center">设置背景色</td></tr><tr><td align="center">\033[nA</td><td align="center">光标上移n行</td></tr><tr><td align="center">\03[nB</td><td align="center">光标下移n行</td></tr><tr><td align="center">\033[nC</td><td align="center">光标右移n行</td></tr><tr><td align="center">\033[nD</td><td align="center">光标左移n行</td></tr></tbody></table><p>字背景颜色范围: 40–49</p><p>字颜色范围: 30—39</p><table><thead><tr><th align="center">字背景颜色代号</th><th align="center">字背景颜色</th><th align="center">字颜色代号</th><th align="center">字颜色</th></tr></thead><tbody><tr><td align="center">40</td><td align="center">黑</td><td align="center">30</td><td align="center">黑</td></tr><tr><td align="center">41</td><td align="center">红</td><td align="center">31</td><td align="center">红</td></tr><tr><td align="center">42</td><td align="center">绿</td><td align="center">32</td><td align="center">绿</td></tr><tr><td align="center">43</td><td align="center">黄</td><td align="center">33</td><td align="center">黄</td></tr><tr><td align="center">44</td><td align="center">蓝</td><td align="center">34</td><td align="center">蓝</td></tr><tr><td align="center">45</td><td align="center">紫</td><td align="center">35</td><td align="center">紫</td></tr><tr><td align="center">46</td><td align="center">青</td><td align="center">36</td><td align="center">青</td></tr><tr><td align="center">47</td><td align="center">白</td><td align="center">37</td><td align="center">白</td></tr></tbody></table><p>小程序具体代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NONE <span class="meta-string">"\e[0m"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED <span class="meta-string">"\e[0;31m"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN <span class="meta-string">"\e[0;36m"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(RED <span class="string">"Hello "</span> CYAN <span class="string">"World!\n"</span> NONE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\e[0;31mHello \e[0;36mWorld!\n\e[0m"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里\e和\033是一个意思，e的八进制代码就是033，这两个print其实效果是一样的，前面那个printf中多个连续的“xxx”字符串会被自动整合为一个字符串，其实最终执行的就是第二个printf。</p><p>效果：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429211041.jpg" alt="2020-04-29_210711"><h2 id="三、关于Linux中bash的变量、替换和元字符"><a href="#三、关于Linux中bash的变量、替换和元字符" class="headerlink" title="三、关于Linux中bash的变量、替换和元字符"></a>三、关于Linux中bash的变量、替换和元字符</h2><p>要求只列出所有bash进程的状态，使用命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep bash</span><br></pre></td></tr></table></figure><p>但grep进程自身也被输出了：</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429211423.jpg" alt="2020-04-29_211412" style="zoom:80%"><p>使用以下的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep [b]ash</span><br><span class="line">ps -ef | grep \\bash</span><br><span class="line">ps -ef | grep b\\ash</span><br><span class="line">ps -ef | grep b\ash</span><br><span class="line">ps -ef | grep ba\\sh</span><br></pre></td></tr></table></figure><ol><li><p>可以</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429211802.jpg" alt="2020-04-29_211631" style="zoom:80%"><p>上面这5个命令的核心目的其实是改变grep在</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br></pre></td></tr></table></figure><p>命令中的显示形式，例如这一个，我们使用三通（tee）命令将在grep命令过滤之前的输出定向到一个文件中。</p><p>先将原命令试一下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep bash</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429214710.jpg" alt="2020-04-29_214703" style="zoom:80%"><p>与1这个命令进行一下对比：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep [b]ash</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429212708.jpg" alt="2020-04-29_212451" style="zoom:80%"><p>我们可以很明显的看到，grep命令确实改变了，因为正则表达式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[b]ash</span><br></pre></td></tr></table></figure><p>是可以匹配bash的，但是却不能匹配[b]ash，因此第一行的-bash这一行被取了出来，而最后grep这一行，由于不匹配[b]ash，就取不出来了，刚好实现了我们只列出所有bash进程的状态的目的，下面的几个命令大同小异。</p></li><li><p>不可以</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429211917.jpg" alt="2020-04-29_211651" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep \\bash</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429213025.jpg" alt="2020-04-29_213015" style="zoom:80%"><p>首先，\是Shell的元字符，先被\转义为真正的单个字符\，因此传给grep的正则表达式其实是\bash，而在正则表达式中，\b有特殊含义，是单词边界，因此就连bash和\bash全部都没有匹配到。</p></li><li><p>可以</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429211852.jpg" alt="2020-04-29_211709" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep b\\ash</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429213823.jpg" alt="2020-04-29_213811" style="zoom:80%"><p>和2一样，传给grep的正则表达式为b\ash，在正则表达式中\a是没有意义的，因此\被丢弃，正则表达式其实就是bash，所以第一行的-bash这一行被取了出来，而最后grep这一行，由于不匹配b\ash，就取不出来了。</p></li><li><p>不可以</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429212003.jpg" alt="2020-04-29_211730" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep b\ash</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429214303.jpg" alt="2020-04-29_214256" style="zoom:80%"><p>首先，\a先经过Shell的替换，因\a是没有特殊含义的，因此\被直接丢掉，传给grep的正则表达式为bash，这就和使用这个命令是一样的：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep bash</span><br></pre></td></tr></table></figure><p>显然是不能实现目的。</p></li><li><p>不可以</p><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429212010.jpg" alt="2020-04-29_211747" style="zoom:80%"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | tee 1.txt | grep ba\\sh</span><br><span class="line">cat 1.txt</span><br></pre></td></tr></table></figure><img src="https://cdn.jsdelivr.net/gh/666WXY666/cdn/img/placeholder/large.svg" data-original="https://gitee.com/wxy_666/images/raw/master/20200429214922.jpg" alt="2020-04-29_214914" style="zoom:80%"><p>这个和2基本是一样的，和3唯一的区别就是，第3个中\a对正则表达式而言是没有特殊含义的，但是\s对正则表达式而言是有特殊含义的，\s代表空白字符（可能是空格、制表符、其他空白），也就是说，grep匹配到的应该是类似于：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ba h</span><br></pre></td></tr></table></figure><p>这种的字符串，显然-bash和ba\sh都不符合，因此就什么都没取到。</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;简单的写了一些Linux的课外拓展学习的相关知识和问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/categories/Linux/"/>
    
      <category term="拓展学习" scheme="https://666wxy666.github.io/categories/Linux/%E6%8B%93%E5%B1%95%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="Linux" scheme="https://666wxy666.github.io/tags/Linux/"/>
    
      <category term="拓展" scheme="https://666wxy666.github.io/tags/%E6%8B%93%E5%B1%95/"/>
    
      <category term="难点" scheme="https://666wxy666.github.io/tags/%E9%9A%BE%E7%82%B9/"/>
    
  </entry>
  
</feed>
